<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Our Kitchen">
<meta name="theme-color" content="#c8521a">
<meta name="application-name" content="Our Kitchen">
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
<title>ü•ï Our Kitchen</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,500;0,700;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #faf7f2; --surface: #fff; --surface2: #f3efe8; --border: #e8e2d9;
  --text: #2c2416; --text2: #7a6e5f;
  --accent: #c8521a; --accent-light: #fdf0ea;
  --low: #d4860a; --low-light: #fef6e4;
  --full: #3a7d44; --full-light: #edf7ef;
  --out: #c8521a;
  --shop-bg: #f0f5f1; --shop-accent: #2d6a4f;
  --hist-bg: #f5f0fa; --hist-accent: #5b3d8f;
  --stores-bg: #f0f4fa; --stores-accent: #1e4d8c;
  --cook-bg: #fdf6ee; --cook-accent: #b5451b; --cook-light: #fff3ec;
  --meal-bg: #f0f4ff; --meal-accent: #3d52a0; --meal-light: #e8eeff;
  --shadow: 0 2px 12px rgba(44,36,22,0.08); --radius: 14px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:calc(72px + env(safe-area-inset-bottom));transition:background 0.3s;}
body.mode-shopping{background:var(--shop-bg);}
body.mode-history{background:var(--hist-bg);}
body.mode-stores{background:var(--stores-bg);}
body.mode-cook{background:var(--cook-bg);}
body.mode-meal{background:var(--meal-bg);}
body.mode-admin{background:#1a1a2e;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);transition:background 0.3s,border-color 0.3s;}
body.mode-shopping header{background:var(--shop-accent);border-bottom-color:transparent;}
body.mode-history header{background:var(--hist-accent);border-bottom-color:transparent;}
body.mode-stores header{background:var(--stores-accent);border-bottom-color:transparent;}
body.mode-cook header{background:var(--cook-accent);border-bottom-color:transparent;}
body.mode-meal header{background:var(--meal-accent);border-bottom-color:transparent;}
body.mode-admin header{background:#16213e;border-bottom-color:#0f3460;}

.header-top{display:flex;align-items:center;justify-content:space-between;}
.logo{font-family:'Fraunces',serif;font-size:1.4rem;font-weight:700;color:var(--text);letter-spacing:-0.5px;transition:color 0.3s;}
.logo span{color:var(--accent);transition:color 0.3s;}
body.mode-shopping .logo,.mode-history .logo,.mode-stores .logo,.mode-cook .logo{color:#fff;}
body.mode-shopping .logo span{color:#a8d5ba;}
body.mode-history .logo span{color:#c9aff5;}
body.mode-stores .logo span{color:#90b8f0;}
body.mode-cook .logo span{color:#ffc9a8;}
body.mode-meal .logo span{color:#a8b8f8;}
body.mode-admin .logo span{color:#7b8cde;}

.header-right{display:flex;align-items:center;gap:8px;}
.family-badge{font-size:0.7rem;font-weight:600;background:var(--surface2);border:1px solid var(--border);border-radius:50px;padding:4px 10px;color:var(--text2);cursor:pointer;transition:all 0.2s;}
body.mode-shopping .family-badge,body.mode-history .family-badge,body.mode-stores .family-badge,body.mode-cook .family-badge,body.mode-meal .family-badge{background:rgba(255,255,255,0.18);border-color:rgba(255,255,255,0.3);color:#fff;}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:300;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:stretch;padding-bottom:env(safe-area-inset-bottom);box-shadow:0 -4px 20px rgba(44,36,22,0.1);}
.bottom-nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:8px 4px;cursor:pointer;border:none;background:none;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:0.6rem;font-weight:600;letter-spacing:0.3px;text-transform:uppercase;transition:color 0.15s;position:relative;user-select:none;-webkit-tap-highlight-color:transparent;}
.bottom-nav-item .nav-icon{font-size:1.35rem;line-height:1;transition:transform 0.15s;}
.bottom-nav-item.active{color:var(--accent);}
.bottom-nav-item.active .nav-icon{transform:scale(1.12);}
.bottom-nav-item:active .nav-icon{transform:scale(0.9);}

/* Active indicator dot above icon */
.bottom-nav-item.active::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:28px;height:3px;border-radius:0 0 3px 3px;background:var(--accent);}

/* Mode-coloured active states */
body.mode-shopping .bottom-nav-item.active{color:var(--shop-accent);}
body.mode-shopping .bottom-nav-item.active::before{background:var(--shop-accent);}
body.mode-history  .bottom-nav-item.active{color:var(--hist-accent);}
body.mode-history  .bottom-nav-item.active::before{background:var(--hist-accent);}
body.mode-stores   .bottom-nav-item.active{color:var(--stores-accent);}
body.mode-stores   .bottom-nav-item.active::before{background:var(--stores-accent);}
body.mode-cook     .bottom-nav-item.active{color:var(--cook-accent);}
body.mode-cook     .bottom-nav-item.active::before{background:var(--cook-accent);}
body.mode-meal     .bottom-nav-item.active{color:var(--meal-accent);}
body.mode-meal     .bottom-nav-item.active::before{background:var(--meal-accent);}

/* Centre Add button */
.bottom-nav-add{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:6px 4px;cursor:pointer;border:none;background:none;font-family:'DM Sans',sans-serif;font-size:0.6rem;font-weight:600;letter-spacing:0.3px;text-transform:uppercase;color:var(--text2);user-select:none;-webkit-tap-highlight-color:transparent;}
.bottom-nav-add .nav-add-circle{width:46px;height:46px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:300;box-shadow:0 4px 14px rgba(200,82,26,0.45);transition:transform 0.15s,box-shadow 0.15s;margin-top:-14px;}
.bottom-nav-add:active .nav-add-circle{transform:scale(0.92);box-shadow:0 2px 8px rgba(200,82,26,0.3);}
body.mode-shopping .bottom-nav-add .nav-add-circle{background:var(--shop-accent);box-shadow:0 4px 14px rgba(74,142,96,0.4);}
body.mode-cook     .bottom-nav-add .nav-add-circle{background:var(--cook-accent);box-shadow:0 4px 14px rgba(181,69,27,0.4);}
body.mode-meal     .bottom-nav-add .nav-add-circle{background:var(--meal-accent);box-shadow:0 4px 14px rgba(61,82,160,0.4);}
body.mode-history  .bottom-nav-add,.body.mode-stores .bottom-nav-add{pointer-events:none;opacity:0.35;}
body.mode-admin    .bottom-nav-add{pointer-events:none;opacity:0.25;}

/* More drawer */
.more-drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:290;opacity:0;pointer-events:none;transition:opacity 0.22s;}
.more-drawer-backdrop.open{opacity:1;pointer-events:all;}
.more-drawer{position:fixed;bottom:0;left:0;right:0;z-index:295;background:var(--surface);border-radius:20px 20px 0 0;padding:0 0 calc(80px + env(safe-area-inset-bottom));box-shadow:0 -8px 32px rgba(44,36,22,0.15);transform:translateY(100%);transition:transform 0.28s cubic-bezier(0.32,0.72,0,1);}
.more-drawer.open{transform:translateY(0);}
.more-drawer-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:12px auto 4px;}
.more-drawer-title{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2);padding:12px 20px 8px;}
.more-drawer-item{display:flex;align-items:center;gap:16px;padding:14px 20px;cursor:pointer;transition:background 0.12s;border-bottom:1px solid var(--border);}
.more-drawer-item:last-child{border-bottom:none;}
.more-drawer-item:active{background:var(--surface2);}
.more-drawer-icon{font-size:1.5rem;width:32px;text-align:center;flex-shrink:0;}
.more-drawer-label{font-size:0.95rem;font-weight:500;color:var(--text);}
.more-drawer-sub{font-size:0.75rem;color:var(--text2);margin-top:1px;}

/* ‚îÄ‚îÄ SAVED FAMILIES ‚îÄ‚îÄ */
.saved-families-list{display:flex;flex-direction:column;gap:8px;margin-bottom:4px;}
.saved-family-card{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:14px;border:2px solid var(--border);background:var(--surface2);cursor:pointer;transition:all 0.15s;position:relative;}
.saved-family-card.active{border-color:var(--accent);background:var(--accent-light);}
.saved-family-card:active{transform:scale(0.98);}
.saved-family-avatar{width:40px;height:40px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;}
.saved-family-card.active .saved-family-avatar{background:var(--accent-light);}
.saved-family-info{flex:1;min-width:0;}
.saved-family-nickname{font-size:0.92rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.saved-family-code{font-size:0.72rem;color:var(--text2);font-family:'Fraunces',serif;letter-spacing:1px;margin-top:1px;}
.saved-family-active-badge{font-size:0.62rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--accent);margin-top:2px;}
.saved-family-actions{display:flex;gap:6px;flex-shrink:0;}
.saved-family-edit-btn{background:none;border:none;font-size:0.9rem;cursor:pointer;padding:4px;color:var(--text2);opacity:0.6;}
.saved-family-edit-btn:hover{opacity:1;}
.saved-family-remove-btn{background:none;border:none;font-size:0.9rem;cursor:pointer;padding:4px;color:var(--out);opacity:0.5;}
.saved-family-remove-btn:hover{opacity:1;}
.nickname-edit-input{font-size:0.88rem;font-weight:600;border:none;border-bottom:2px solid var(--accent);background:transparent;color:var(--text);outline:none;width:100%;padding:2px 0;}

/* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
.filter-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;transition:background 0.3s,border-color 0.3s;}
.filter-bar::-webkit-scrollbar{display:none;}
body.mode-shopping .filter-bar{background:#e8f2ec;border-bottom-color:#c5dece;}
body.mode-history .filter-bar{background:#ede8f7;border-bottom-color:#c9aff5;}
body.mode-stores .filter-bar{background:#e8eef7;border-bottom-color:#90b8f0;}

.filter-pill{white-space:nowrap;padding:6px 14px;border-radius:50px;border:1.5px solid var(--border);background:var(--bg);font-size:0.78rem;font-weight:500;cursor:pointer;transition:all 0.15s;color:var(--text2);user-select:none;}
.filter-pill.active{background:var(--text);border-color:var(--text);color:white;}
.filter-pill.needs-pill.active{background:var(--accent);border-color:var(--accent);color:white;}
body.mode-shopping .filter-pill{background:#fff;border-color:#c5dece;color:#2d6a4f;}
body.mode-shopping .filter-pill.active{background:var(--shop-accent);border-color:var(--shop-accent);color:#fff;}
body.mode-shopping .filter-pill.needs-pill.active{background:var(--accent);border-color:var(--accent);color:#fff;}
body.mode-history .filter-pill{background:#fff;border-color:#c9aff5;color:var(--hist-accent);}
body.mode-history .filter-pill.active{background:var(--hist-accent);border-color:var(--hist-accent);color:#fff;}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main{padding:18px 16px;max-width:600px;margin:0 auto;}

/* ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ */
.stats-bar{display:flex;gap:10px;margin-bottom:20px;}
.stat-chip{flex:1;background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:10px 12px;text-align:center;transition:background 0.3s;}
body.mode-shopping .stat-chip{background:#fff;border-color:#c5dece;}
.stat-num{font-family:'Fraunces',serif;font-size:1.4rem;font-weight:700;line-height:1;}
.stat-label{font-size:0.68rem;color:var(--text2);margin-top:3px;text-transform:uppercase;letter-spacing:0.4px;}
.stat-chip.out-chip .stat-num{color:var(--out);}
.stat-chip.low-chip .stat-num{color:var(--low);}
.stat-chip.full-chip .stat-num{color:var(--full);}
.stat-chip.cost-chip .stat-num{color:var(--shop-accent);font-size:1.1rem;}

/* ‚îÄ‚îÄ SHOPPING BANNER ‚îÄ‚îÄ */
.shop-banner{display:none;background:var(--shop-accent);color:white;border-radius:14px;padding:14px 18px;margin-bottom:16px;align-items:center;gap:12px;}
body.mode-shopping .shop-banner{display:flex;}
.shop-banner-icon{font-size:1.8rem;}
.sb-title{font-family:'Fraunces',serif;font-size:1rem;font-weight:700;}
.sb-sub{font-size:0.78rem;opacity:0.8;margin-top:2px;}

/* ‚îÄ‚îÄ STORE SELECTOR ‚îÄ‚îÄ */
.store-selector-bar{background:#fff;border:1.5px solid #c5dece;border-radius:12px;padding:10px 14px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all 0.15s;}
.store-selector-bar:active{transform:scale(0.99);}
.ssl-label{font-size:0.7rem;color:#6a9e85;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;}
.ssl-name{font-size:0.95rem;font-weight:500;color:var(--shop-accent);margin-top:2px;}
.ssl-chevron{font-size:1.2rem;color:#6a9e85;}

/* ‚îÄ‚îÄ ESTIMATED TOTAL BAR ‚îÄ‚îÄ */
.est-total-bar{background:var(--shop-accent);color:#fff;border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.etb-label{font-size:0.78rem;opacity:0.8;}
.etb-amount{font-family:'Fraunces',serif;font-size:1.4rem;font-weight:700;}
.etb-note{font-size:0.68rem;opacity:0.65;margin-top:1px;}
.log-shop-btn{background:#fff;color:var(--shop-accent);border:none;border-radius:50px;padding:8px 16px;font-family:'DM Sans',sans-serif;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.log-shop-btn:active{transform:scale(0.96);}

/* ‚îÄ‚îÄ CATEGORY SECTION ‚îÄ‚îÄ */
.category-section{margin-bottom:26px;}
.category-header{display:flex;align-items:center;margin-bottom:10px;}
.category-name{font-family:'Fraunces',serif;font-size:1.02rem;font-weight:500;color:var(--text2);letter-spacing:0.3px;display:flex;align-items:center;gap:8px;transition:color 0.3s;flex:1;}
body.mode-shopping .category-name{color:var(--shop-accent);}
.category-count{font-family:'DM Sans',sans-serif;font-size:0.72rem;background:var(--surface2);border-radius:50px;padding:2px 8px;color:var(--text2);transition:all 0.3s;}
body.mode-shopping .category-count{background:#c5dece;color:var(--shop-accent);}
.cat-add-btn{width:26px;height:26px;border-radius:50%;background:var(--surface2);border:1.5px solid var(--border);color:var(--text2);font-size:1rem;line-height:1;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity 0.15s,background 0.15s,transform 0.15s;flex-shrink:0;user-select:none;}
.category-section:hover .cat-add-btn{opacity:1;}
.cat-add-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;transform:scale(1.1);}
body.mode-shopping .cat-add-btn:hover{background:var(--shop-accent);border-color:var(--shop-accent);color:#fff;}
/* Always visible on touch devices */
@media(hover:none){.cat-add-btn{opacity:1;}}

/* ‚îÄ‚îÄ ITEM CARD ‚îÄ‚îÄ */
.item-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:13px 16px;margin-bottom:8px;display:flex;align-items:center;gap:13px;cursor:pointer;transition:opacity 0.2s,transform 0.15s;position:relative;}
.item-card:active{transform:scale(0.985);}
.item-card.status-out{border-left:4px solid var(--out);}
.item-card.status-low{border-left:4px solid var(--low);}
.item-card.status-full{border-left:4px solid var(--full);}
body.mode-shopping .item-card.status-full{opacity:0.42;}
body.mode-shopping .item-card.status-out{border:2px solid var(--out);border-left:4px solid var(--out);box-shadow:0 2px 10px rgba(200,82,26,0.12);}
body.mode-shopping .item-card.status-low{border:2px solid var(--low);border-left:4px solid var(--low);box-shadow:0 2px 10px rgba(212,134,10,0.1);}

.status-dot{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.95rem;flex-shrink:0;}
.status-out .status-dot{background:var(--accent-light);}
.status-low .status-dot{background:var(--low-light);}
.status-full .status-dot{background:var(--full-light);}

.item-info{flex:1;min-width:0;}
.item-name{font-size:0.93rem;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.item-meta{font-size:0.73rem;color:var(--text2);margin-top:2px;}
.item-price-tag{font-size:0.72rem;color:var(--shop-accent);font-weight:500;margin-top:2px;}

.status-badge{font-size:0.7rem;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;padding:4px 10px;border-radius:50px;flex-shrink:0;}
.status-out .status-badge{background:var(--accent-light);color:var(--out);}
.status-low .status-badge{background:var(--low-light);color:var(--low);}
.status-full .status-badge{background:var(--full-light);color:var(--full);}

.section-divider{display:flex;align-items:center;gap:10px;margin:10px 0;}
.section-divider span{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.6px;color:var(--text2);white-space:nowrap;}
.section-divider::before,.section-divider::after{content:'';flex:1;height:1px;background:var(--border);}
body.mode-shopping .section-divider span{color:#6a9e85;}
body.mode-shopping .section-divider::before,body.mode-shopping .section-divider::after{background:#c5dece;}

/* ‚îÄ‚îÄ HISTORY TAB ‚îÄ‚îÄ */
.history-list{position:relative;}
.history-month-label{font-family:'Fraunces',serif;font-size:0.85rem;font-weight:700;color:var(--hist-accent);text-transform:uppercase;letter-spacing:1px;padding:8px 0 6px;margin-top:8px;border-bottom:1px solid #c9aff5;margin-bottom:12px;}
.shop-card{background:var(--surface);border:1.5px solid #d8cff0;border-radius:var(--radius);padding:16px;margin-bottom:10px;cursor:pointer;transition:all 0.15s;}
.shop-card:active{transform:scale(0.99);}
.shop-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
.shop-card-store{font-family:'Fraunces',serif;font-size:1rem;font-weight:700;color:var(--text);}
.shop-card-date{font-size:0.75rem;color:var(--text2);margin-top:3px;}
.shop-card-total{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:700;color:var(--hist-accent);text-align:right;white-space:nowrap;}
.shop-card-total-label{font-size:0.68rem;color:var(--text2);text-align:right;margin-top:2px;}
.shop-card-items{font-size:0.78rem;color:var(--text2);margin-top:8px;padding-top:8px;border-top:1px solid var(--border);}
.shop-card-expanded{display:none;margin-top:10px;border-top:1px solid var(--border);padding-top:10px;}
.shop-card.expanded .shop-card-expanded{display:block;}
.receipt-line{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px dashed var(--border);font-size:0.82rem;}
.receipt-line:last-child{border-bottom:none;}
.receipt-line .rl-name{color:var(--text);}
.receipt-line .rl-price{color:var(--hist-accent);font-weight:500;}
.receipt-line .rl-est{color:var(--text2);font-size:0.72rem;}

/* ‚îÄ‚îÄ STORES TAB ‚îÄ‚îÄ */
.store-card{background:var(--surface);border:1.5px solid #b8cfe8;border-radius:var(--radius);padding:16px;margin-bottom:10px;cursor:pointer;transition:all 0.15s;}
.store-card:active{transform:scale(0.99);}
.store-card-top{display:flex;align-items:center;gap:14px;}
.store-icon{width:44px;height:44px;border-radius:12px;background:#e8eef7;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;}
.store-info{flex:1;}
.store-name{font-family:'Fraunces',serif;font-size:1rem;font-weight:700;color:var(--text);}
.store-meta{font-size:0.75rem;color:var(--text2);margin-top:2px;}
.store-visits{font-size:0.72rem;color:var(--stores-accent);font-weight:500;margin-top:3px;}
.store-avg{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:var(--stores-accent);text-align:right;}
.store-avg-label{font-size:0.68rem;color:var(--text2);text-align:right;}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty{text-align:center;padding:48px 20px;color:var(--text2);}
.empty-icon{font-size:3rem;margin-bottom:12px;}
.empty-title{font-family:'Fraunces',serif;font-size:1.2rem;margin-bottom:6px;color:var(--text);}
.empty-sub{font-size:0.85rem;line-height:1.5;}

/* ‚îÄ‚îÄ OVERLAY / MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(44,36,22,0.45);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border-radius:20px 20px 0 0;padding:24px 20px calc(72px + env(safe-area-inset-bottom));width:100%;max-width:600px;transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.32,0.72,0,1);max-height:92vh;overflow-y:auto;}
.overlay.open .modal{transform:translateY(0);}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:99px;margin:0 auto 20px;}
.modal-title{font-family:'Fraunces',serif;font-size:1.3rem;font-weight:700;margin-bottom:4px;color:var(--text);}
.modal-sub{font-size:0.82rem;color:var(--text2);margin-bottom:20px;}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:0.78rem;font-weight:500;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;}
.form-input,.form-select{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:0.95rem;color:var(--text);background:var(--bg);outline:none;transition:border-color 0.15s;-webkit-appearance:none;}
.form-input:focus,.form-select:focus{border-color:var(--accent);}
.form-row{display:flex;gap:10px;}
.form-row .form-group{flex:1;}
.currency-prefix{display:flex;align-items:center;}
.currency-prefix .prefix{padding:12px 10px 12px 14px;background:var(--surface2);border:1.5px solid var(--border);border-right:none;border-radius:10px 0 0 10px;font-size:0.9rem;color:var(--text2);}
.currency-prefix .form-input{border-radius:0 10px 10px 0;}

.status-picker{display:flex;gap:8px;}
.status-option{flex:1;padding:10px 6px;border:1.5px solid var(--border);border-radius:10px;text-align:center;cursor:pointer;font-size:0.78rem;font-weight:500;transition:all 0.15s;background:var(--bg);}
.so-emoji{font-size:1.3rem;display:block;margin-bottom:4px;}
.status-option[data-val="out"].selected{background:var(--accent-light);border-color:var(--out);color:var(--out);}
.status-option[data-val="low"].selected{background:var(--low-light);border-color:var(--low);color:var(--low);}
.status-option[data-val="full"].selected{background:var(--full-light);border-color:var(--full);color:var(--full);}

.btn-row{display:flex;gap:10px;margin-top:22px;}
.btn{flex:1;padding:14px;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:500;cursor:pointer;border:none;transition:all 0.15s;}
.btn:active{transform:scale(0.97);}
.btn-primary{background:var(--accent);color:white;}
.btn-secondary{background:var(--surface2);color:var(--text);}
.btn-danger{background:#fde8e8;color:#c0392b;}
.btn-green{background:var(--shop-accent);color:#fff;}
.btn-purple{background:var(--hist-accent);color:#fff;}

.action-list{display:flex;flex-direction:column;gap:8px;}
.action-item{display:flex;align-items:center;gap:14px;padding:14px 16px;border-radius:12px;cursor:pointer;border:1.5px solid var(--border);transition:all 0.15s;background:var(--bg);font-weight:500;}
.action-item:active{transform:scale(0.98);}
.action-item.out{border-color:var(--out);background:var(--accent-light);color:var(--out);}
.action-item.low{border-color:var(--low);background:var(--low-light);color:var(--low);}
.action-item.full{border-color:var(--full);background:var(--full-light);color:var(--full);}
.ai-emoji{font-size:1.3rem;}
.ai-sub{font-size:0.75rem;opacity:0.7;font-weight:400;}

.divider{border:none;border-top:1px solid var(--border);margin:16px 0;}

.new-cat-row{display:flex;gap:8px;margin-top:8px;}
.new-cat-row .form-input{flex:1;}
.new-cat-btn{padding:12px 16px;background:var(--text);color:white;border:none;border-radius:10px;cursor:pointer;font-size:0.9rem;white-space:nowrap;}

/* ‚îÄ‚îÄ ONBOARDING OVERLAY ‚îÄ‚îÄ */
.onboard-overlay{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;align-items:center;justify-content:center;padding:24px;}
.onboard-box{max-width:400px;width:100%;text-align:center;}
.onboard-logo{font-family:'Fraunces',serif;font-size:2.2rem;font-weight:700;color:var(--text);margin-bottom:6px;}
.onboard-logo span{color:var(--accent);}
.onboard-tagline{font-size:0.9rem;color:var(--text2);margin-bottom:36px;line-height:1.5;}
.onboard-code-display{background:var(--surface2);border:2px dashed var(--border);border-radius:16px;padding:20px;margin-bottom:24px;}
.ocd-label{font-size:0.75rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
.ocd-code{font-family:'Fraunces',serif;font-size:2rem;font-weight:700;color:var(--accent);letter-spacing:4px;}
.ocd-sub{font-size:0.78rem;color:var(--text2);margin-top:8px;line-height:1.4;}
.onboard-or{font-size:0.82rem;color:var(--text2);margin:16px 0;}
.join-row{display:flex;gap:8px;}
.join-row .form-input{flex:1;text-transform:uppercase;letter-spacing:2px;font-weight:600;}

/* ‚îÄ‚îÄ LOG SHOP MODAL ‚îÄ‚îÄ */
.log-item-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.log-item-row:last-child{border-bottom:none;}
.log-item-check{width:22px;height:22px;border-radius:6px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all 0.15s;font-size:0.9rem;}
.log-item-check.checked{background:var(--full);border-color:var(--full);color:white;}
.log-item-name{flex:1;font-size:0.9rem;font-weight:500;}
.log-item-price{width:90px;}
.log-item-price .form-input{padding:8px 10px;font-size:0.85rem;}
.log-total-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0 0;border-top:2px solid var(--border);margin-top:8px;}
.ltr-label{font-size:0.85rem;color:var(--text2);}
.ltr-amount{font-family:'Fraunces',serif;font-size:1.3rem;font-weight:700;color:var(--shop-accent);}

/* ‚îÄ‚îÄ CURRENCY CHIP ‚îÄ‚îÄ */
.converted-chip{font-size:0.65rem;background:#fff3cd;border:1px solid #ffd75e;color:#7a5800;border-radius:50px;padding:2px 7px;margin-left:6px;font-weight:600;}

/* ‚îÄ‚îÄ DATE RANGE PICKER ‚îÄ‚îÄ */
.date-range-row{display:flex;gap:8px;align-items:center;}
.date-range-row .form-input{flex:1;padding:8px 12px;font-size:0.85rem;}
.date-range-row span{color:var(--text2);font-size:0.85rem;}

/* ‚îÄ‚îÄ COOK TAB ‚îÄ‚îÄ */
.recipe-card{background:var(--surface);border-radius:var(--radius);padding:16px 18px;margin-bottom:10px;box-shadow:var(--shadow);cursor:pointer;border:1.5px solid var(--border);transition:transform 0.15s,border-color 0.15s;}
.recipe-card:active{transform:scale(0.98);}
.recipe-card-top{display:flex;align-items:flex-start;gap:12px;}
.recipe-emoji{font-size:2rem;line-height:1;flex-shrink:0;}
.recipe-info{flex:1;min-width:0;}
.recipe-name{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:2px;}
.recipe-desc{font-size:0.82rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.recipe-meta{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;}
.recipe-chip{font-size:0.72rem;background:var(--cook-light);color:var(--cook-accent);border-radius:50px;padding:3px 10px;font-weight:500;}

/* Recipe detail */
.recipe-detail-header{background:var(--cook-accent);color:#fff;border-radius:var(--radius);padding:20px;margin-bottom:16px;position:relative;}
.recipe-detail-emoji{font-size:3rem;margin-bottom:8px;}
.recipe-detail-name{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:700;margin-bottom:4px;}
.recipe-detail-desc{font-size:0.88rem;opacity:0.85;margin-bottom:12px;}
.recipe-detail-chips{display:flex;gap:8px;flex-wrap:wrap;}
.recipe-detail-chip{font-size:0.72rem;background:rgba(255,255,255,0.2);border-radius:50px;padding:3px 10px;}
.start-cooking-btn{width:100%;padding:15px;background:#fff;color:var(--cook-accent);border:none;border-radius:12px;font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;cursor:pointer;margin-top:14px;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform 0.15s;}
.start-cooking-btn:active{transform:scale(0.97);}

.recipe-section-title{font-size:0.72rem;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--text2);margin:18px 0 8px;}
.ingredient-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;margin-bottom:6px;}
.ingredient-qty{font-size:0.8rem;font-weight:600;color:var(--cook-accent);min-width:50px;}
.ingredient-name{font-size:0.9rem;flex:1;}
.ingredient-del{background:none;border:none;cursor:pointer;color:var(--text2);font-size:1rem;padding:2px 6px;opacity:0.5;transition:opacity 0.15s;}
.ingredient-del:hover{opacity:1;color:#c0392b;}

.step-row{display:flex;gap:10px;padding:10px 12px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;margin-bottom:6px;align-items:flex-start;transition:box-shadow 0.15s,opacity 0.15s;}
.step-row.dragging{opacity:0.4;box-shadow:0 4px 20px rgba(0,0,0,0.15);}
.step-row.drag-over{border-color:var(--cook-accent);box-shadow:0 0 0 2px var(--cook-accent);}
.step-drag-handle{cursor:grab;color:var(--border);font-size:1.1rem;padding:2px 2px;flex-shrink:0;touch-action:none;user-select:none;line-height:1.6;}
.step-drag-handle:active{cursor:grabbing;}
.step-num{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:var(--cook-accent);flex-shrink:0;min-width:22px;line-height:1.6;}
.step-text{font-size:0.9rem;line-height:1.5;flex:1;word-break:break-word;}
.step-edit-area{flex:1;display:flex;flex-direction:column;gap:6px;}
.step-edit-textarea{width:100%;padding:8px 10px;border:1.5px solid var(--cook-accent);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;line-height:1.5;resize:vertical;min-height:60px;outline:none;}
.step-edit-actions{display:flex;gap:6px;}
.step-actions{display:flex;gap:2px;flex-shrink:0;}
.step-btn{background:none;border:none;cursor:pointer;color:var(--text2);font-size:0.85rem;padding:3px 5px;opacity:0.55;transition:opacity 0.15s,color 0.15s;line-height:1;}
.step-btn:hover{opacity:1;}
.step-btn.edit:hover{color:var(--cook-accent);}
.step-btn.del:hover{color:#c0392b;}
.step-btn.move{font-size:0.75rem;}
.step-btn.move:hover{color:var(--cook-accent);}

.add-ingredient-row{display:flex;gap:6px;margin-bottom:6px;}
.add-ingredient-row select,.add-ingredient-row input{flex:1;}
.add-step-row{display:flex;gap:6px;}
.add-step-row textarea{flex:1;min-height:70px;padding:10px 12px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:0.9rem;resize:vertical;}

/* ‚îÄ‚îÄ FOCUS / COOKING MODE ‚îÄ‚îÄ */
.focus-overlay{position:fixed;inset:0;background:#1a1008;z-index:400;display:none;flex-direction:column;overflow:hidden;}
.focus-overlay.active{display:flex;}
.focus-header{padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.1);}
.focus-recipe-name{font-family:'Fraunces',serif;font-size:1.1rem;color:#fff;font-weight:700;}
.focus-exit-btn{background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:50px;padding:6px 14px;font-size:0.82rem;cursor:pointer;}
.focus-body{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.focus-steps-area{flex:1;overflow-y:auto;padding:20px 20px 0;}
.focus-done-list{display:flex;flex-direction:column;gap:4px;margin-bottom:12px;}
.focus-done-item{display:flex;align-items:center;gap:8px;opacity:0.4;font-size:0.8rem;color:#fff;padding:4px 0;transition:opacity 0.3s;}
.focus-done-item .done-check{color:#4caf50;font-size:0.9rem;}
.focus-current-step{background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:24px 20px;margin-bottom:16px;}
.focus-step-label{font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.5);margin-bottom:8px;}
.focus-step-text{font-family:'Fraunces',serif;font-size:1.4rem;color:#fff;line-height:1.5;font-weight:500;}
.focus-upcoming{display:flex;flex-direction:column;gap:6px;padding-bottom:20px;}
.focus-upcoming-item{font-size:0.82rem;color:rgba(255,255,255,0.3);padding:6px 10px;border-radius:8px;display:flex;gap:8px;}
.focus-upcoming-num{color:rgba(255,255,255,0.2);font-weight:600;}
.focus-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,0.1);}
.focus-next-btn{width:100%;padding:18px;background:var(--cook-accent);color:#fff;border:none;border-radius:14px;font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;cursor:pointer;transition:transform 0.15s,background 0.15s;}
.focus-next-btn:active{transform:scale(0.97);}
.focus-next-btn.done{background:#3a7d44;}
.focus-ingredients-toggle{display:flex;justify-content:center;margin-bottom:12px;}
.focus-ing-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);border-radius:50px;padding:6px 16px;font-size:0.8rem;cursor:pointer;}
.focus-ingredients-panel{background:rgba(255,255,255,0.05);border-radius:12px;padding:12px 16px;margin-bottom:12px;display:none;}
.focus-ingredients-panel.open{display:block;}
.focus-ing-item{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.07);font-size:0.88rem;color:rgba(255,255,255,0.8);cursor:pointer;transition:opacity 0.2s;}
.focus-ing-item:last-child{border-bottom:none;}
.focus-ing-item.grabbed{opacity:0.35;text-decoration:line-through;}
.focus-ing-qty{color:var(--cook-accent);font-weight:600;font-size:0.8rem;min-width:48px;}
.focus-complete-banner{text-align:center;padding:40px 20px;}
.focus-complete-banner .big-emoji{font-size:4rem;margin-bottom:12px;}
.focus-complete-banner h2{font-family:'Fraunces',serif;font-size:1.8rem;color:#fff;margin-bottom:8px;}
.focus-complete-banner p{color:rgba(255,255,255,0.6);font-size:0.9rem;}

/* ‚îÄ‚îÄ MEAL PLAN TAB ‚îÄ‚îÄ */
/* View switcher */
.meal-view-bar{display:flex;gap:0;background:var(--surface);border-radius:12px;padding:3px;margin-bottom:12px;box-shadow:var(--shadow);}
.meal-view-btn{flex:1;padding:8px 4px;border:none;background:none;border-radius:9px;font-size:0.78rem;font-weight:600;cursor:pointer;color:var(--text2);transition:all 0.15s;white-space:nowrap;}
.meal-view-btn.active{background:var(--meal-accent);color:#fff;box-shadow:0 2px 8px rgba(61,82,160,0.3);}

/* Day view */
.meal-day-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:8px;}
.meal-day-nav{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--meal-accent);padding:4px 8px;border-radius:8px;transition:background 0.15s;}
.meal-day-nav:hover{background:var(--meal-light);}
.meal-day-title{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:var(--meal-accent);text-align:center;flex:1;}
.meal-today-chip{font-size:0.65rem;background:var(--meal-accent);color:#fff;border-radius:50px;padding:2px 7px;font-weight:600;}
.meal-shop-btn{font-size:0.75rem;background:var(--meal-light);color:var(--meal-accent);border:1.5px solid var(--meal-accent);border-radius:50px;padding:5px 10px;cursor:pointer;font-weight:600;transition:background 0.15s;white-space:nowrap;}
.meal-shop-btn:hover{background:var(--meal-accent);color:#fff;}
.meal-day-view{background:var(--surface);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);}
.meal-slot{margin-bottom:14px;}
.meal-slot-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.meal-slot-name{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text2);}
.meal-slot-add{width:26px;height:26px;border-radius:50%;background:var(--meal-light);border:1.5px solid var(--meal-accent);color:var(--meal-accent);font-size:1rem;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;flex-shrink:0;}
.meal-slot-add:hover{background:var(--meal-accent);color:#fff;}
.meal-entry{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface2);border-radius:10px;margin-bottom:5px;}
.meal-entry-emoji{font-size:1.2rem;flex-shrink:0;}
.meal-entry-name{font-size:0.88rem;flex:1;font-weight:500;}
.meal-entry-del{background:none;border:none;cursor:pointer;color:var(--text2);opacity:0.4;font-size:0.85rem;padding:2px 4px;transition:opacity 0.15s;}
.meal-entry-del:hover{opacity:1;color:#c0392b;}
.meal-empty-slot{font-size:0.8rem;color:var(--text2);padding:6px 10px;font-style:italic;opacity:0.7;}

/* Week view */
.week-grid{background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);}
.week-grid-header{display:grid;grid-template-columns:repeat(7,1fr);background:var(--meal-accent);}
.week-grid-dayname{padding:8px 4px;text-align:center;font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:rgba(255,255,255,0.8);}
.week-row{display:grid;grid-template-columns:repeat(7,1fr);border-top:1px solid var(--border);}
.week-cell{padding:8px 6px;min-height:80px;border-right:1px solid var(--border);cursor:pointer;transition:background 0.15s;position:relative;}
.week-cell:last-child{border-right:none;}
.week-cell:hover{background:var(--meal-light);}
.week-cell.today{background:rgba(61,82,160,0.06);}
.week-cell.today .wc-num{color:var(--meal-accent);font-weight:800;}
.week-cell.other-month .wc-num{opacity:0.3;}
.wc-num{font-family:'Fraunces',serif;font-size:0.9rem;font-weight:700;margin-bottom:4px;}
.wc-dot{width:6px;height:6px;border-radius:50%;background:var(--meal-accent);display:inline-block;margin:1px;}
.wc-label{font-size:0.58rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3;display:block;}
.week-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.week-nav-title{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:var(--meal-accent);}
.week-nav-btns{display:flex;gap:4px;}
.week-nav-btn{background:var(--meal-light);border:1.5px solid var(--meal-accent);color:var(--meal-accent);border-radius:8px;padding:5px 12px;cursor:pointer;font-size:0.82rem;font-weight:600;}

/* Month view */
.month-grid{background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);}
.month-grid-header{display:grid;grid-template-columns:repeat(7,1fr);background:var(--meal-accent);}
.month-grid-dayname{padding:8px 2px;text-align:center;font-size:0.6rem;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.8);}
.month-row{display:grid;grid-template-columns:repeat(7,1fr);border-top:1px solid var(--border);}
.month-cell{padding:6px 4px;min-height:60px;border-right:1px solid var(--border);cursor:pointer;transition:background 0.15s;overflow:hidden;}
.month-cell:last-child{border-right:none;}
.month-cell:hover{background:var(--meal-light);}
.month-cell.today{background:rgba(61,82,160,0.07);}
.month-cell.today .mc-num{color:var(--meal-accent);font-weight:800;}
.month-cell.other-month{background:var(--surface2);}
.month-cell.other-month .mc-num{opacity:0.3;}
.mc-num{font-family:'Fraunces',serif;font-size:0.82rem;font-weight:700;margin-bottom:2px;}
.mc-dots{display:flex;flex-wrap:wrap;gap:2px;margin-bottom:2px;}
.mc-dot{width:5px;height:5px;border-radius:50%;background:var(--meal-accent);}
.mc-preview{font-size:0.55rem;color:var(--text2);line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.month-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.month-nav-title{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:var(--meal-accent);}
.month-nav-btns{display:flex;gap:4px;}
.month-nav-btn{background:var(--meal-light);border:1.5px solid var(--meal-accent);color:var(--meal-accent);border-radius:8px;padding:5px 12px;cursor:pointer;font-size:0.82rem;font-weight:600;}
.month-template-btn{font-size:0.78rem;background:var(--meal-accent);color:#fff;border:none;border-radius:8px;padding:6px 12px;cursor:pointer;font-weight:600;}

/* Templates */
.template-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;box-shadow:var(--shadow);}
.template-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.template-name{font-family:'Fraunces',serif;font-size:1rem;font-weight:700;color:var(--meal-accent);}
.template-actions{display:flex;gap:6px;}
.template-btn{font-size:0.72rem;border:1.5px solid var(--meal-accent);color:var(--meal-accent);background:var(--meal-light);border-radius:50px;padding:4px 10px;cursor:pointer;font-weight:600;transition:all 0.15s;}
.template-btn:hover{background:var(--meal-accent);color:#fff;}
.template-btn.danger{border-color:#c0392b;color:#c0392b;background:#fff5f5;}
.template-btn.danger:hover{background:#c0392b;color:#fff;}
.template-week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.template-day{background:var(--surface2);border-radius:8px;padding:5px;min-height:48px;}
.template-day-name{font-size:0.6rem;font-weight:700;text-transform:uppercase;color:var(--text2);margin-bottom:3px;}
.template-meal-chip{font-size:0.55rem;background:var(--meal-light);color:var(--meal-accent);border-radius:4px;padding:2px 4px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;}

/* Meal picker modal */
.meal-picker-tabs{display:flex;gap:0;margin-bottom:12px;border:1.5px solid var(--border);border-radius:10px;overflow:hidden;}
.meal-picker-tab{flex:1;padding:9px;border:none;font-size:0.82rem;font-weight:600;cursor:pointer;transition:background 0.15s;}
.meal-picker-tab.active{background:var(--meal-accent);color:#fff;}
.meal-picker-tab:not(.active){background:var(--surface2);color:var(--text2);}
.meal-picker-list{max-height:300px;overflow-y:auto;}
.meal-picker-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:background 0.15s;margin-bottom:4px;}
.meal-picker-item:hover,.meal-picker-item:active{background:var(--meal-light);}
.meal-picker-item-emoji{font-size:1.3rem;flex-shrink:0;}
.meal-picker-item-name{font-size:0.9rem;flex:1;}
.meal-picker-item-meta{font-size:0.72rem;color:var(--text2);}
.meal-picker-search{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:10px;font-size:0.9rem;margin-bottom:10px;outline:none;}
.meal-picker-search:focus{border-color:var(--meal-accent);}

/* ‚îÄ‚îÄ FEEDBACK WIDGET ‚îÄ‚îÄ */
.feedback-fab{position:fixed;bottom:calc(80px + env(safe-area-inset-bottom));right:18px;width:44px;height:44px;border-radius:50%;background:var(--meal-accent);color:#fff;border:none;font-size:1.2rem;cursor:pointer;box-shadow:0 4px 16px rgba(61,82,160,0.4);z-index:200;display:flex;align-items:center;justify-content:center;transition:transform 0.15s;}
.feedback-fab:hover{transform:scale(1.1);}
.star-row{display:flex;justify-content:center;gap:8px;margin:12px 0;}
.star-btn{background:none;border:none;font-size:2rem;cursor:pointer;transition:transform 0.1s;line-height:1;padding:0;}
.star-btn:hover,.star-btn.lit{color:#f0b429;}
.star-btn:not(.lit){color:var(--border);}
.star-btn:hover ~ .star-btn{color:var(--border)!important;}
.feedback-feature-pills{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0;}
.feature-pill{font-size:0.75rem;padding:4px 10px;border-radius:50px;border:1.5px solid var(--border);cursor:pointer;transition:all 0.15s;background:var(--surface);}
.feature-pill.selected{background:var(--meal-accent);color:#fff;border-color:var(--meal-accent);}

/* ‚îÄ‚îÄ ADMIN TAB ‚îÄ‚îÄ */
.admin-login{text-align:center;padding:40px 20px;}
.admin-login h2{font-family:'Fraunces',serif;font-size:1.6rem;color:#e0e0ff;margin-bottom:8px;}
.admin-login p{color:#888;font-size:0.88rem;margin-bottom:20px;}
.admin-login input{width:100%;padding:12px;border-radius:10px;border:1.5px solid #333;background:#1e1e3f;color:#fff;font-size:1rem;margin-bottom:10px;text-align:center;letter-spacing:2px;}
.admin-section{background:#1e1e3f;border-radius:var(--radius);padding:16px;margin-bottom:14px;}
.admin-section h3{font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;color:#7b8cde;margin-bottom:12px;}
.feedback-card{background:#16213e;border-radius:10px;padding:12px;margin-bottom:8px;}
.feedback-stars{color:#f0b429;font-size:1rem;margin-bottom:4px;}
.feedback-comment{font-size:0.85rem;color:#ccc;margin-bottom:4px;}
.feedback-meta{font-size:0.7rem;color:#666;}
.admin-stat{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #2a2a4a;}
.admin-stat:last-child{border-bottom:none;}
.admin-stat-label{font-size:0.85rem;color:#ccc;}
.admin-stat-val{font-family:'Fraunces',serif;font-size:1.1rem;color:#7b8cde;font-weight:700;}

/* ‚îÄ‚îÄ PWA INSTALL BANNER ‚îÄ‚îÄ */
.pwa-step{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);}
.pwa-step:last-of-type{border-bottom:none;}
.pwa-step-num{width:24px;height:24px;border-radius:50%;background:var(--accent);color:#fff;font-size:0.75rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.pwa-step span:last-child{font-size:0.88rem;line-height:1.5;color:var(--text);}
/* In header */
.pwa-header-btn{background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.35);color:#fff;border-radius:50%;width:34px;height:34px;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;flex-shrink:0;}
.pwa-header-btn:hover{background:rgba(255,255,255,0.28);}
.pwa-header-btn.installed{opacity:0.35;cursor:default;}

/* ‚îÄ‚îÄ ADMIN FILTERS ‚îÄ‚îÄ */
.admin-filters{background:#1e1e3f;border-radius:var(--radius);padding:14px;margin-bottom:14px;display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;}
.admin-filter-group{display:flex;flex-direction:column;gap:4px;flex:1;min-width:120px;}
.admin-filter-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.8px;color:#7b8cde;font-weight:600;}
.admin-filter-input{background:#16213e;border:1.5px solid #3a3a6a;border-radius:8px;color:#fff;padding:7px 10px;font-size:0.82rem;outline:none;width:100%;}
.admin-filter-input:focus{border-color:#7b8cde;}
.admin-filter-select{background:#16213e;border:1.5px solid #3a3a6a;border-radius:8px;color:#fff;padding:7px 10px;font-size:0.82rem;outline:none;width:100%;}
.admin-export-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
.admin-export-btn{flex:1;padding:10px;border-radius:10px;border:1.5px solid #3a3a6a;background:#1e1e3f;color:#7b8cde;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.15s;min-width:100px;text-align:center;}
.admin-export-btn:hover{background:#3a3a6a;color:#fff;}

@media(min-width:600px){main{padding:22px 24px;}}

</style>
</head>
<body>

<!-- ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ -->
<div class="onboard-overlay" id="onboard-overlay">
  <div class="onboard-box">
    <div class="onboard-logo">Our <span>Kitchen</span></div>
    <div class="onboard-tagline">A shared pantry & shopping tracker<br>for your whole family.</div>
    <div class="onboard-code-display">
      <div class="ocd-label">Your Family Code</div>
      <div class="ocd-code" id="onboard-code">‚Äî</div>
      <div class="ocd-sub">Share this code with family members so they can join your kitchen.</div>
    </div>
    <button class="btn btn-primary" id="btn-finish-onboard" style="width:100%;margin-bottom:12px;">Get Started ‚Üí</button>
    <div class="onboard-or">‚Äî or join an existing family ‚Äî</div>
    <div class="join-row">
      <input class="form-input" id="join-code-input" placeholder="FAMILY CODE" maxlength="12" />
      <button class="btn btn-secondary" id="btn-join-family" style="flex:0;white-space:nowrap;padding:12px 16px;">Join</button>
    </div>
    <div style="margin-top:16px;">
      <div class="form-label" style="text-align:center;margin-bottom:8px;">Currency</div>
      <select class="form-select" id="onboard-currency"></select>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<header>
  <div class="header-top">
    <div class="logo">Our <span>Kitchen</span></div>
    <div class="header-right">
      <button class="pwa-header-btn" id="btn-pwa-install" title="Add to Home Screen">üì≤</button>
      <div class="family-badge" id="family-badge-btn">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ‚Äî‚Äî</div>
    </div>
  </div>
</header>
<div class="filter-bar" id="filter-bar"></div>

<!-- ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ -->
<nav class="bottom-nav" id="bottom-nav">
  <button class="bottom-nav-item active" id="tab-pantry">
    <span class="nav-icon">üè†</span>Pantry
  </button>
  <button class="bottom-nav-item" id="tab-shopping">
    <span class="nav-icon">üõí</span>Shop
  </button>
  <button class="bottom-nav-add" id="main-add-btn">
    <div class="nav-add-circle">Ôºã</div>
    <span style="margin-top:4px;">Add</span>
  </button>
  <button class="bottom-nav-item" id="tab-cook">
    <span class="nav-icon">üë®‚Äçüç≥</span>Cook
  </button>
  <button class="bottom-nav-item" id="tab-meal">
    <span class="nav-icon">üìÖ</span>Meals
  </button>
  <button class="bottom-nav-item" id="tab-more">
    <span class="nav-icon">¬∑¬∑¬∑</span>More
  </button>
</nav>

<!-- ‚îÄ‚îÄ MORE DRAWER ‚îÄ‚îÄ -->
<div class="more-drawer-backdrop" id="more-drawer-backdrop"></div>
<div class="more-drawer" id="more-drawer">
  <div class="more-drawer-handle"></div>
  <div class="more-drawer-title">More</div>
  <div class="more-drawer-item" id="drawer-stores">
    <span class="more-drawer-icon">üè™</span>
    <div><div class="more-drawer-label">Stores</div><div class="more-drawer-sub">Manage your shops & prices</div></div>
  </div>
  <div class="more-drawer-item" id="drawer-history">
    <span class="more-drawer-icon">üìã</span>
    <div><div class="more-drawer-label">History</div><div class="more-drawer-sub">Past shopping trips</div></div>
  </div>
  <div class="more-drawer-item" id="drawer-install">
    <span class="more-drawer-icon">üì≤</span>
    <div><div class="more-drawer-label">Add to Home Screen</div><div class="more-drawer-sub">Install as an app</div></div>
  </div>
  <div class="more-drawer-item" id="drawer-family">
    <span class="more-drawer-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
    <div><div class="more-drawer-label">Family Code</div><div class="more-drawer-sub">Share with your household</div></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<main>
  <div class="stats-bar" id="stats-bar"></div>

  <!-- Shopping extras -->
  <div class="shop-banner">
    <div class="shop-banner-icon">üõí</div>
    <div class="shop-banner-text">
      <div class="sb-title">Shopping List</div>
      <div class="sb-sub" id="shop-banner-sub">Out & Low items first</div>
    </div>
  </div>
  <div class="store-selector-bar" id="store-selector-bar" style="display:none;">
    <div><div class="ssl-label">Shopping at</div><div class="ssl-name" id="ssl-name">Select a store‚Ä¶</div></div>
    <div class="ssl-chevron">‚Ä∫</div>
  </div>
  <div class="est-total-bar" id="est-total-bar" style="display:none;">
    <div>
      <div class="etb-label">Estimated total</div>
      <div class="etb-amount" id="etb-amount">‚Äî</div>
      <div class="etb-note" id="etb-note"></div>
    </div>
    <button class="log-shop-btn" id="btn-log-shop">Log This Shop</button>
  </div>

  <div id="items-container"></div>
</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODALS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- ADD / EDIT ITEM -->
<div class="overlay" id="add-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-title">Add Item</div>
    <div class="modal-sub" id="modal-sub"></div>
    <div class="form-group">
      <label class="form-label">Item Name</label>
      <input class="form-input" id="item-name-input" placeholder="e.g. Almond Milk" />
    </div>
    <div class="form-group">
      <label class="form-label">Category</label>
      <select class="form-select" id="item-category-input"></select>
      <div class="new-cat-row">
        <input class="form-input" id="new-cat-input" placeholder="Or type new category‚Ä¶" />
        <button class="new-cat-btn" id="btn-add-cat">Add</button>
      </div>
      <div id="cat-manage-list" style="margin-top:8px;"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <div class="status-picker">
        <div class="status-option" data-val="out"><span class="so-emoji">üö´</span>Out</div>
        <div class="status-option" data-val="low"><span class="so-emoji">‚ö†Ô∏è</span>Low</div>
        <div class="status-option selected" data-val="full"><span class="so-emoji">‚úÖ</span>Full</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Estimated Price <span style="font-weight:400;text-transform:none;">(optional)</span></label>
      <div class="currency-prefix">
        <span class="prefix" id="price-prefix">$</span>
        <input class="form-input" id="item-price-input" type="number" min="0" step="0.01" placeholder="0.00" />
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="btn-cancel-add">Cancel</button>
      <button class="btn btn-primary" id="save-btn">Add Item</button>
    </div>
  </div>
</div>

<!-- ITEM DETAIL -->
<div class="overlay" id="detail-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="detail-title"></div>
    <div class="modal-sub" id="detail-sub"></div>
    <div class="action-list">
      <div class="action-item out"  id="action-out"><span class="ai-emoji">üö´</span><div><div>Mark as Out</div><div class="ai-sub">We're completely out</div></div></div>
      <div class="action-item low"  id="action-low"><span class="ai-emoji">‚ö†Ô∏è</span><div><div>Mark as Low</div><div class="ai-sub">Running low, time to restock</div></div></div>
      <div class="action-item full" id="action-full"><span class="ai-emoji">‚úÖ</span><div><div>Mark as Full</div><div class="ai-sub">All stocked up!</div></div></div>
    </div>
    <hr class="divider">
    <div class="btn-row">
      <button class="btn btn-secondary" id="btn-edit-item">‚úèÔ∏è Edit</button>
      <button class="btn btn-danger"    id="btn-delete-item">üóë Delete</button>
    </div>
  </div>
</div>

<!-- FAMILY MODAL -->
<div class="overlay" id="family-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Family Settings</div>
    <div id="family-modal-body"></div>
  </div>
</div>

<!-- STORE PICKER (in shopping mode) -->
<div class="overlay" id="store-pick-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Choose Store</div>
    <div class="modal-sub">Estimates are personalised per store.</div>
    <input class="form-input" id="store-search-input" placeholder="üîç Search by name or city‚Ä¶" style="margin-bottom:12px;" />
    <div id="store-pick-list"></div>
    <div class="btn-row" style="margin-top:16px;">
      <button class="btn btn-secondary" id="btn-cancel-store-pick">Cancel</button>
      <button class="btn btn-green" id="btn-add-store-from-pick">Ôºã Add Store</button>
    </div>
  </div>
</div>

<!-- ADD STORE -->
<div class="overlay" id="add-store-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="add-store-title">Add Store</div>
    <div class="form-group">
      <label class="form-label">Store Name</label>
      <input class="form-input" id="store-name-input" placeholder="e.g. Tesco" />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">City / Location</label>
        <input class="form-input" id="store-city-input" placeholder="e.g. Dublin" />
      </div>
      <div class="form-group">
        <label class="form-label">Currency</label>
        <select class="form-select" id="store-currency-input"></select>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="btn-cancel-store">Cancel</button>
      <button class="btn btn-danger"    id="btn-delete-store" style="display:none;">üóë Delete</button>
      <button class="btn btn-green"     id="btn-save-store">Save Store</button>
    </div>
  </div>
</div>

<!-- LOG SHOP MODAL -->
<div class="overlay" id="log-shop-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Log This Shop</div>
    <div class="modal-sub" id="log-shop-sub">Check off what you bought and enter actual prices.</div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input class="form-input" type="date" id="log-shop-date" />
    </div>
    <div class="form-group">
      <label class="form-label">Items Purchased</label>
      <div id="log-items-list"></div>
    </div>
    <div class="log-total-row">
      <div>
        <div class="ltr-label">Actual Total</div>
        <div style="font-size:0.72rem;color:var(--text2);">Override if needed</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span id="log-total-calc" class="ltr-amount">‚Äî</span>
        <div class="currency-prefix" style="width:110px;">
          <span class="prefix" id="log-total-prefix">$</span>
          <input class="form-input" id="log-total-override" type="number" min="0" step="0.01" placeholder="override" style="border-radius:0 10px 10px 0;padding:8px 10px;font-size:0.85rem;" />
        </div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="btn-cancel-log">Cancel</button>
      <button class="btn btn-green"     id="btn-save-log">Save Shop Log</button>
    </div>
  </div>
</div>

<!-- SHOP DETAIL (history) -->
<div class="overlay" id="shop-detail-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="shop-detail-title"></div>
    <div class="modal-sub" id="shop-detail-sub"></div>
    <div id="shop-detail-body"></div>
    <div class="btn-row" style="margin-top:16px;">
      <button class="btn btn-secondary" id="btn-close-shop-detail">Close</button>
      <button class="btn btn-danger"    id="shop-detail-delete">üóë Delete</button>
    </div>
  </div>
</div>

<!-- FOCUS / COOKING MODE OVERLAY -->
<div class="focus-overlay" id="focus-overlay">
  <div class="focus-header">
    <div>
      <div class="focus-recipe-name" id="focus-recipe-name">Recipe</div>
      <div id="focus-time-remaining" style="font-size:0.72rem;color:rgba(255,255,255,0.5);margin-top:2px;"></div>
    </div>
    <button class="focus-exit-btn" id="btn-exit-focus">‚úï Exit</button>
  </div>
  <div class="focus-body">
    <div class="focus-steps-area" id="focus-steps-area"></div>
    <div style="padding:0 20px;">
      <div class="focus-ingredients-toggle">
        <button class="focus-ing-btn" id="btn-toggle-ingredients">üß∫ Show Ingredients</button>
      </div>
      <div class="focus-ingredients-panel" id="focus-ingredients-panel"></div>
    </div>
  </div>
  <div class="focus-footer">
    <button class="focus-next-btn" id="btn-focus-next">Mark Step Done ‚Üí</button>
  </div>
</div>

<!-- ADD / EDIT RECIPE MODAL -->
<div class="overlay" id="recipe-edit-overlay">
  <div class="modal" style="max-height:90vh;overflow-y:auto;">
    <div class="modal-handle"></div>
    <div class="modal-title" id="recipe-edit-title">New Recipe</div>
    <div class="form-group">
      <label class="form-label">Recipe Name</label>
      <input class="form-input" id="recipe-name-input" placeholder="e.g. Spaghetti Bolognese" />
    </div>
    <div class="form-group">
      <label class="form-label">Description <span style="font-weight:400;text-transform:none;">(optional)</span></label>
      <input class="form-input" id="recipe-desc-input" placeholder="A short tagline‚Ä¶" />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Emoji</label>
        <input class="form-input" id="recipe-emoji-input" placeholder="üçΩÔ∏è" style="text-align:center;font-size:1.4rem;" />
      </div>
      <div class="form-group">
        <label class="form-label">Cook Time</label>
        <input class="form-input" id="recipe-time-input" placeholder="e.g. 45 min" />
      </div>
    </div>

    <div class="recipe-section-title">Ingredients</div>
    <div id="recipe-ingredients-list"></div>

    <!-- Ingredient source tabs -->
    <div style="display:flex;gap:0;margin-bottom:8px;border:1.5px solid var(--border);border-radius:10px;overflow:hidden;">
      <button id="ing-tab-pantry" onclick="switchIngTab('pantry')" style="flex:1;padding:8px;border:none;background:var(--cook-accent);color:#fff;font-size:0.82rem;font-weight:600;cursor:pointer;">üì¶ From Pantry</button>
      <button id="ing-tab-custom" onclick="switchIngTab('custom')" style="flex:1;padding:8px;border:none;background:var(--surface2);color:var(--text2);font-size:0.82rem;font-weight:600;cursor:pointer;">‚úèÔ∏è New Item</button>
    </div>
    <div id="ing-panel-pantry" class="add-ingredient-row">
      <select class="form-select" id="recipe-ing-item-select" style="flex:2;"></select>
      <input class="form-input" id="recipe-ing-qty-input" placeholder="Qty e.g. 2 cups" style="flex:1;" />
      <button class="new-cat-btn" id="btn-add-ingredient">Add</button>
    </div>
    <div id="ing-panel-custom" class="add-ingredient-row" style="display:none;">
      <input class="form-input" id="recipe-ing-custom-name" placeholder="Item name e.g. Tahini" style="flex:2;" />
      <input class="form-input" id="recipe-ing-custom-qty" placeholder="Qty e.g. 3 tbsp" style="flex:1;" />
      <button class="new-cat-btn" id="btn-add-custom-ingredient">Add</button>
    </div>
    <div id="ing-custom-note" style="display:none;font-size:0.75rem;color:var(--cook-accent);padding:4px 2px 6px;">‚ö° New items are added to your pantry as "Out" and will appear on your shopping list.</div>

    <div class="recipe-section-title">Steps</div>
    <div id="recipe-steps-list"></div>
    <div class="add-step-row">
      <textarea class="form-input" id="recipe-step-input" placeholder="Describe this step‚Ä¶"></textarea>
      <button class="new-cat-btn" id="btn-add-step" style="align-self:flex-end;">Add</button>
    </div>

    <div class="btn-row" style="margin-top:22px;">
      <button class="btn btn-secondary" id="btn-cancel-recipe">Discard</button>
      <button class="btn btn-danger"    id="btn-delete-recipe" style="display:none;">üóë</button>
      <button class="btn btn-primary" style="background:var(--cook-accent);" id="btn-save-recipe">Save Recipe</button>
    </div>
  </div>
</div>

<!-- FEEDBACK FAB -->
<button class="feedback-fab" id="btn-feedback-fab" title="Rate this feature">‚òÖ</button>

<!-- FEEDBACK MODAL -->
<div class="overlay" id="feedback-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Rate a Feature ‚òÖ</div>
    <div class="modal-sub">Your feedback helps improve the app for everyone.</div>
    <div style="margin:10px 0 6px;">
      <div class="form-label" style="margin-bottom:8px;">Which feature?</div>
      <div class="feedback-feature-pills" id="feedback-feature-pills">
        <div class="feature-pill selected" data-f="pantry" onclick="selectFeedbackFeature(this)">üè† Pantry</div>
        <div class="feature-pill" data-f="shopping" onclick="selectFeedbackFeature(this)">üõí Shopping</div>
        <div class="feature-pill" data-f="stores" onclick="selectFeedbackFeature(this)">üè™ Stores</div>
        <div class="feature-pill" data-f="history" onclick="selectFeedbackFeature(this)">üìã History</div>
        <div class="feature-pill" data-f="cook" onclick="selectFeedbackFeature(this)">üë®‚Äçüç≥ Cook</div>
        <div class="feature-pill" data-f="meal" onclick="selectFeedbackFeature(this)">üìÖ Meal Plan</div>
        <div class="feature-pill" data-f="overall" onclick="selectFeedbackFeature(this)">‚≠ê Overall</div>
      </div>
    </div>
    <div class="form-label" style="margin-bottom:4px;">Your rating</div>
    <div class="star-row" id="feedback-stars">
      <button class="star-btn" data-v="1" onclick="setFeedbackStar(1)">‚òÖ</button>
      <button class="star-btn" data-v="2" onclick="setFeedbackStar(2)">‚òÖ</button>
      <button class="star-btn" data-v="3" onclick="setFeedbackStar(3)">‚òÖ</button>
      <button class="star-btn" data-v="4" onclick="setFeedbackStar(4)">‚òÖ</button>
      <button class="star-btn" data-v="5" onclick="setFeedbackStar(5)">‚òÖ</button>
    </div>
    <div id="feedback-comment-section" style="display:none;">
      <div class="form-label" style="margin-bottom:6px;">Any comments? <span style="font-weight:400;text-transform:none;">(optional)</span></div>
      <textarea class="form-input" id="feedback-comment-input" placeholder="Tell us what you think‚Ä¶" style="min-height:80px;resize:vertical;"></textarea>
    </div>
    <div class="btn-row" style="margin-top:16px;">
      <button class="btn btn-secondary" id="btn-cancel-feedback">Cancel</button>
      <button class="btn btn-primary" style="background:var(--meal-accent);" id="btn-submit-feedback">Submit ‚òÖ</button>
    </div>
  </div>
</div>

<!-- MEAL PICKER MODAL -->
<div class="overlay" id="meal-picker-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="meal-picker-title">Add to Meal</div>
    <input class="meal-picker-search" id="meal-picker-search" placeholder="üîç Search recipes or items‚Ä¶" />
    <div class="meal-picker-tabs">
      <button class="meal-picker-tab active" id="mpt-recipes" onclick="switchMealPickerTab('recipes')">üë®‚Äçüç≥ Recipes</button>
      <button class="meal-picker-tab" id="mpt-items" onclick="switchMealPickerTab('items')">üì¶ Items</button>
    </div>
    <div class="meal-picker-list" id="meal-picker-list"></div>
    <div class="btn-row" style="margin-top:12px;">
      <button class="btn btn-secondary" id="btn-cancel-meal-picker">Cancel</button>
    </div>
  </div>
</div>

<!-- TEMPLATE EDIT MODAL -->
<div class="overlay" id="template-edit-overlay">
  <div class="modal" style="max-height:90vh;overflow-y:auto;">
    <div class="modal-handle"></div>
    <div class="modal-title" id="template-edit-title">New Template</div>
    <div class="form-group">
      <label class="form-label">Template Name</label>
      <input class="form-input" id="template-name-input" placeholder="e.g. School Week, Summer Rotation" />
    </div>
    <div class="recipe-section-title" style="margin-top:14px;">Meals for each day</div>
    <div id="template-days-editor"></div>
    <div class="btn-row" style="margin-top:18px;">
      <button class="btn btn-secondary" id="btn-cancel-template">Cancel</button>
      <button class="btn btn-danger" id="btn-delete-template" style="display:none;">üóë</button>
      <button class="btn btn-primary" style="background:var(--meal-accent);" id="btn-save-template">Save Template</button>
    </div>
  </div>
</div>

<!-- APPLY TEMPLATE MODAL -->
<div class="overlay" id="apply-template-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Apply Template</div>
    <div class="modal-sub" id="apply-template-sub">Choose how to apply this template:</div>
    <div style="margin:14px 0;display:flex;flex-direction:column;gap:8px;" id="apply-template-options">
      <label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--surface2);border-radius:10px;cursor:pointer;">
        <input type="radio" name="apply-scope" value="week" checked style="accent-color:var(--meal-accent);width:18px;height:18px;" />
        <div><div style="font-weight:600;">This week</div><div style="font-size:0.78rem;color:var(--text2);" id="apply-week-label">Mon‚ÄìSun</div></div>
      </label>
      <label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--surface2);border-radius:10px;cursor:pointer;">
        <input type="radio" name="apply-scope" value="month" style="accent-color:var(--meal-accent);width:18px;height:18px;" />
        <div><div style="font-weight:600;">Fill the whole month</div><div style="font-size:0.78rem;color:var(--text2);" id="apply-month-label">Repeats template week by week</div></div>
      </label>
    </div>
    <div style="padding:10px 12px;background:var(--low-light);border-radius:10px;font-size:0.8rem;color:#8a6200;margin-bottom:4px;">
      ‚ö†Ô∏è Days that already have meals will not be overwritten.
    </div>
    <div class="btn-row" style="margin-top:14px;">
      <button class="btn btn-secondary" id="btn-cancel-apply-template">Cancel</button>
      <button class="btn btn-primary" style="background:var(--meal-accent);" id="btn-confirm-apply-template">Apply ‚Üí</button>
    </div>
  </div>
</div>

<!-- PWA INSTALL MODAL -->
<div class="overlay" id="pwa-install-overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üì≤ Add to Home Screen</div>
    <div class="modal-sub">Keep Our Kitchen in your pocket for instant access ‚Äî no app store needed.</div>
    <div id="pwa-install-steps" style="margin:16px 0;"></div>
    <div id="pwa-native-btn-row" style="display:none;margin-bottom:12px;">
      <button id="btn-pwa-native-install" class="btn btn-primary" style="width:100%;background:var(--full);font-size:1rem;">üì≤ Install Now</button>
    </div>
    <button class="btn btn-secondary" id="btn-close-pwa-modal" style="width:100%;">Done</button>
  </div>
</div>

<script type="module">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
import { initializeApp }                              from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBigMYAmZq4bFBYGiP1wWdBuFIj1LYqdyg",
  authDomain: "family-pantry-62e45.firebaseapp.com",
  databaseURL: "https://family-pantry-62e45-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "family-pantry-62e45",
  storageBucket: "family-pantry-62e45.firebasestorage.app",
  messagingSenderId: "1007893281082",
  appId: "1:1007893281082:web:58d47936bddea818547803"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

// Active real-time listeners ‚Äî stored so we can detach on family switch
let _listeners = [];

function dbPath(k){ return `families/${STATE.familyCode}/${k}`; }

// Write a value to Firebase
async function save(k, data){
  try{ await set(ref(db, dbPath(k)), data); }catch(e){ console.error('Firebase write error', e); }
}

// Save a single item/store/shop by its id (avoids full-collection overwrites)
async function saveRecord(collection, record){
  if(!record.id){ console.error('saveRecord called without id', record); return; }
  if(/^\d+$/.test(String(record.id))){ console.error('saveRecord called with numeric id ‚Äî refusing', record); return; }
  try{ await set(ref(db, dbPath(collection)+'/'+record.id), record); }catch(e){ console.error(e); }
}
async function deleteRecord(collection, id){
  if(!id){ console.error('deleteRecord called without id'); return; }
  if(/^\d+$/.test(String(id))){ console.error('deleteRecord called with numeric id ‚Äî refusing', id); return; }
  try{ await remove(ref(db, dbPath(collection)+'/'+id)); }catch(e){ console.error(e); }
}

// One-time read from Firebase
async function load(k, fallback){
  try{
    const snap = await get(ref(db, dbPath(k)));
    return snap.exists() ? snap.val() : fallback;
  }catch(e){ return fallback; }
}

// Subscribe to a path ‚Äî fires instantly with current value then on every change
function subscribe(k, callback){
  const r = ref(db, dbPath(k));
  const unsub = onValue(r, snap => callback(snap.exists() ? snap.val() : null));
  _listeners.push(unsub);
}

// Detach all listeners (used when switching families)
function detachListeners(){
  _listeners.forEach(u => u());
  _listeners = [];
}

// Settings are device-local (family code, currency preference)
const SETTINGS_KEY = 'kitchen-settings-v3';
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SETTINGS_KEY)); }catch{ return null; } }
function saveSettings(data){ try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(data)); }catch(e){} }

// Add or update a family in the saved list, persist immediately
function upsertSavedFamily(code, nickname){
  if(!code || code === 'ADMIN-1337') return;
  const existing = STATE.savedFamilies.find(f => f.code === code);
  if(existing){
    existing.lastUsed = Date.now();
    if(nickname !== undefined) existing.nickname = nickname;
  } else {
    STATE.savedFamilies.push({ code, nickname: nickname || code, lastUsed: Date.now() });
  }
  persistSettings();
}

function removeSavedFamily(code){
  STATE.savedFamilies = STATE.savedFamilies.filter(f => f.code !== code);
  persistSettings();
}

function persistSettings(){
  saveSettings({
    familyCode: STATE.familyCode,
    currency: STATE.currency,
    savedFamilies: STATE.savedFamilies,
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & CURRENCIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CURRENCIES = [
  {code:'USD',symbol:'$',name:'US Dollar'},
  {code:'GBP',symbol:'¬£',name:'British Pound'},
  {code:'EUR',symbol:'‚Ç¨',name:'Euro'},
  {code:'CAD',symbol:'CA$',name:'Canadian Dollar'},
  {code:'AUD',symbol:'A$',name:'Australian Dollar'},
  {code:'NZD',symbol:'NZ$',name:'New Zealand Dollar'},
  {code:'JPY',symbol:'¬•',name:'Japanese Yen'},
  {code:'CHF',symbol:'Fr',name:'Swiss Franc'},
  {code:'SEK',symbol:'kr',name:'Swedish Krona'},
  {code:'NOK',symbol:'kr',name:'Norwegian Krone'},
  {code:'DKK',symbol:'kr',name:'Danish Krone'},
  {code:'SGD',symbol:'S$',name:'Singapore Dollar'},
  {code:'HKD',symbol:'HK$',name:'Hong Kong Dollar'},
  {code:'INR',symbol:'‚Çπ',name:'Indian Rupee'},
  {code:'MXN',symbol:'MX$',name:'Mexican Peso'},
  {code:'BRL',symbol:'R$',name:'Brazilian Real'},
  {code:'ZAR',symbol:'R',name:'South African Rand'},
  {code:'AED',symbol:'ÿØ.ÿ•',name:'UAE Dirham'},
];
const LOCATION_CURRENCY_MAP = {
  US:'USD',GB:'GBP',AU:'AUD',CA:'CAD',NZ:'NZD',JP:'JPY',SG:'SGD',
  HK:'HKD',IN:'INR',MX:'MXN',BR:'BRL',ZA:'ZAR',AE:'AED',
  DE:'EUR',FR:'EUR',IT:'EUR',ES:'EUR',NL:'EUR',BE:'EUR',AT:'EUR',
  PT:'EUR',IE:'EUR',FI:'EUR',SE:'SEK',NO:'NOK',DK:'DKK',CH:'CHF',
};
const DEFAULT_CATS = ['Produce','Dairy & Eggs','Pantry','Beverages','Frozen','Snacks','Household'];
const CAT_EMOJI_MAP = {'Produce':'ü•¶','Dairy & Eggs':'ü•õ','Pantry':'ü´ô','Beverages':'üßÉ','Frozen':'üßä','Snacks':'üçø','Household':'üßπ','Meat & Fish':'ü•©','Bakery':'üçû','Condiments':'üß¥','Other':'üì¶'};
const RANK = {out:0,low:1,full:2};

// PWA install state ‚Äî declared early so renderPantry can reference them
let _pwaPrompt = null;
let _pwaInstalled = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let STATE = {
  familyCode: null,
  currency: 'USD',
  mode: 'pantry',
  items: [],
  categories: [...DEFAULT_CATS],
  stores: [],
  shopLogs: [],
  selectedStoreId: null,
  // filters
  pf: {needs:false,recent:true,alpha:false},
  sf: {needsOnly:false,recent:true,alpha:false,showSkipped:false},
  hf: {from:'',to:''},
  // edit state
  editingItemId: null,
  editingStoreId: null,
  editingRecipeId: null,
  detailItemId: null,
  detailShopId: null,
  selectedStatus: 'full',
  recipes: [],
  mealPlan: {},        // keyed by "YYYY-MM-DD" ‚Üí {breakfast:[],lunch:[],dinner:[],snacks:[]}
  mealTemplates: [],   // [{id,name,days:{mon:[],tue:[],wed:[],thu:[],fri:[],sat:[],sun:[]}}]
  mealView: 'day',     // 'day' | 'week' | 'month' | 'templates'
  selectedMealDate: null,
  mealWeekOffset: 0,   // weeks from current week
  mealMonthOffset: 0,  // months from current month
  mealPickerSlot: null,
  editingTemplateId: null,
  applyTemplateId: null,
  // focus mode
  focusRecipeId: null,
  focusStep: 0,
  focusGrabbed: {},
  // shopping skip ‚Äî session-local
  skippedIds: new Set(),
  // feedback
  feedbackStar: 0,
  feedbackFeature: 'pantry',
  // admin
  isAdmin: false,
  adminFeedback: [],
  adminFilter: { minStars:0, maxStars:5, feature:'all', dateFrom:'', dateTo:'', hasComment:false },
  // saved families
  savedFamilies: [], // [{code, nickname, lastUsed}]
  // exchange rates cache
  rates: {},
  ratesTs: 0,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CURRENCY HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function currencySymbol(code){
  return (CURRENCIES.find(c=>c.code===code)||{symbol:'$'}).symbol;
}
function fmt(amount, code){
  if(amount==null||amount==='') return '‚Äî';
  code = code||STATE.currency;
  const sym = currencySymbol(code);
  return sym + Number(amount).toFixed(2);
}

async function getRate(from, to){
  if(from===to) return 1;
  const cacheKey = from+'_'+to;
  const now = Date.now();
  // Cache 6 hours
  if(STATE.rates[cacheKey] && now - STATE.ratesTs < 21600000) return STATE.rates[cacheKey];
  try{
    const res = await fetch(`https://open.er-api.com/v6/latest/${from}`);
    const data = await res.json();
    if(data.rates){
      Object.keys(data.rates).forEach(c=>{ STATE.rates[from+'_'+c]=data.rates[c]; });
      STATE.ratesTs = now;
      return STATE.rates[cacheKey]||1;
    }
  }catch(e){}
  return 1;
}

async function convertPrice(amount, fromCurrency, toCurrency){
  if(!amount) return null;
  if(fromCurrency===toCurrency) return {amount:Number(amount),converted:false};
  const rate = await getRate(fromCurrency, toCurrency);
  return {amount:Number(amount)*rate, converted:true, fromCurrency};
}

function populateCurrencySelects(){
  const html = CURRENCIES.map(c=>`<option value="${c.code}">${c.symbol} ${c.code} ‚Äî ${c.name}</option>`).join('');
  ['onboard-currency','settings-currency','store-currency-input'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.innerHTML=html; el.value=STATE.currency; }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAMILY CODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateFamilyCode(){
  const words=['APPLE','BAKER','CEDAR','DAISY','EMBER','FROST','GROVE','HAVEN','IVORY','JUNCO'];
  const word = words[Math.floor(Math.random()*words.length)];
  const num  = Math.floor(1000+Math.random()*9000);
  return word+'-'+num;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  populateCurrencySelects();

  const settings = await loadSettings();
  if(settings && settings.familyCode){
    STATE.familyCode = settings.familyCode;
    STATE.currency   = settings.currency||'EUR';
    STATE.savedFamilies = settings.savedFamilies || [];

    if(STATE.familyCode === 'ADMIN-1337'){
      STATE.isAdmin = true;
      hideOnboarding();
      await loadAdminData();
      setMode('admin');
      updateFamilyBadge();
      return;
    }

    // Ensure current family is in saved list
    upsertSavedFamily(STATE.familyCode);
    await loadAllData();
    hideOnboarding();
  } else {
    const code = generateFamilyCode();
    STATE.familyCode = code;
    document.getElementById('onboard-code').textContent = code;
    detectLocationCurrency();
    document.getElementById('onboard-overlay').style.display='flex';
  }

  updateFamilyBadge();
  document.getElementById('price-prefix').textContent = currencySymbol(STATE.currency);
}

function detectLocationCurrency(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const {latitude:lat,longitude:lng} = pos.coords;
      const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
      const data = await res.json();
      const cc = data.countryCode;
      const suggested = LOCATION_CURRENCY_MAP[cc];
      if(suggested){
        STATE.currency = suggested;
        populateCurrencySelects();
      }
    }catch(e){}
  }, ()=>{});
}

async function loadAllData(){
  detachListeners();

  // Load settings UI ‚Äî settings-currency is rendered dynamically in renderFamilyModal so guard it
  const currencyEl = document.getElementById('settings-currency');
  if(currencyEl) currencyEl.value = STATE.currency;
  document.getElementById('price-prefix').textContent = currencySymbol(STATE.currency);

  // Check if family exists and fix any broken numeric-keyed data from array seeding
  const existingRaw = await load('items', null);
  if(!existingRaw){
    // Brand new family ‚Äî seed with proper keyed objects
    const defaultItems = getDefaultItems();
    const itemsObj = {};
    defaultItems.forEach(i => { itemsObj[i.id] = i; });
    await save('items', itemsObj);
    await save('cats',  DEFAULT_CATS);
    await save('stores', {});
    await save('shops',  {});
  } else {
    // Check if items have numeric keys (broken array conversion) and repair
    const keys = Object.keys(existingRaw);
    const hasNumericKeys = keys.some(k => /^\d+$/.test(k));
    if(hasNumericKeys){
      console.log('Repairing numeric-keyed items...');
      const repaired = {};
      Object.values(existingRaw).forEach(item => {
        // Give items with numeric/missing IDs a proper ID
        if(!item.id || /^\d+$/.test(String(item.id))){
          item = {...item, id: uid()};
        }
        repaired[item.id] = item;
      });
      await save('items', repaired);
    }
  }

  // Subscribe to real-time updates
  subscribe('items', val => {
    if(!val){ STATE.items=[]; render(); return; }
    // Always normalise ‚Äî ensure every item has a proper string id
    STATE.items = Object.entries(val).map(([k, item]) => {
      if(!item.id || /^\d+$/.test(String(item.id))) return {...item, id: k};
      return item;
    });
    render();
  });
  subscribe('cats', val => {
    STATE.categories = val ? (Array.isArray(val) ? val : Object.values(val)) : DEFAULT_CATS;
  });
  subscribe('stores', val => {
    STATE.stores = val ? Object.entries(val).map(([k,s]) => s.id ? s : {...s,id:k}) : [];
    if(STATE.mode==='stores') renderStoresTab();
  });
  subscribe('shops', val => {
    STATE.shopLogs = val ? Object.entries(val).map(([k,s]) => s.id ? s : {...s,id:k}) : [];
    if(STATE.mode === 'history') renderHistoryTab();
  });
  subscribe('recipes', val => {
    STATE.recipes = val ? Object.entries(val).map(([k,r]) => r.id ? r : {...r,id:k}) : [];
    if(STATE.mode === 'cook') renderCookTab();
  });
  subscribe('mealPlan', val => {
    STATE.mealPlan = val || {};
    if(STATE.mode === 'meal') renderMealTab();
  });
  subscribe('mealTemplates', val => {
    STATE.mealTemplates = val ? Object.entries(val).map(([k,t])=>t.id?t:{...t,id:k}) : [];
    if(STATE.mode === 'meal' && STATE.mealView==='templates') renderMealTab();
  });
}

async function finishOnboard(){
  STATE.currency = document.getElementById('onboard-currency').value;
  upsertSavedFamily(STATE.familyCode);
  persistSettings();
  await loadAllData();
  hideOnboarding();
}

async function joinFamily(){
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  if(!code||code.length<4){ alert('Please enter a valid family code.'); return; }
  if(code === 'ADMIN-1337'){
    STATE.isAdmin = true;
    STATE.familyCode = 'ADMIN-1337';
    persistSettings();
    hideOnboarding();
    await loadAdminData();
    setMode('admin');
    updateFamilyBadge();
    return;
  }
  STATE.familyCode = code;
  STATE.currency = document.getElementById('onboard-currency').value;
  upsertSavedFamily(code);
  persistSettings();
  await loadAllData();
  hideOnboarding();
}

async function switchFamily(){
  const code = document.getElementById('switch-code-input').value.trim().toUpperCase();
  if(!code||code.length<4){ alert('Please enter a valid family code.'); return; }
  if(code === STATE.familyCode){ closeModal('family-overlay'); return; }
  detachListeners();
  STATE.familyCode = code;
  STATE.isAdmin = false;
  STATE.items = []; STATE.stores = []; STATE.shopLogs = [];
  STATE.recipes = []; STATE.mealPlan = {}; STATE.mealTemplates = [];
  upsertSavedFamily(code);
  persistSettings();
  await loadAllData();
  updateFamilyBadge();
  render();
  closeModal('family-overlay');
  showToast('Switched to ' + (STATE.savedFamilies.find(f=>f.code===code)||{}).nickname || code);
}

async function quickSwitchFamily(code){
  if(code === STATE.familyCode) return;
  detachListeners();
  STATE.familyCode = code;
  STATE.isAdmin = false;
  STATE.items = []; STATE.stores = []; STATE.shopLogs = [];
  STATE.recipes = []; STATE.mealPlan = {}; STATE.mealTemplates = [];
  upsertSavedFamily(code);
  persistSettings();
  await loadAllData();
  updateFamilyBadge();
  render();
  closeModal('family-overlay');
  const f = STATE.savedFamilies.find(f=>f.code===code);
  showToast('Switched to ' + (f ? f.nickname : code));
}

function renderFamilyModal(){
  // Determine the real active kitchen code (exclude ADMIN-1337 from display)
  const activeCode = STATE.familyCode;
  const isAdminMode = activeCode === 'ADMIN-1337';

  // Ensure current non-admin family is always in the saved list
  if(!isAdminMode) upsertSavedFamily(activeCode);

  const families = STATE.savedFamilies.slice().sort((a,b) => b.lastUsed - a.lastUsed);

  const familyCards = families.length ? `
    <div class="form-group">
      <label class="form-label">Your Kitchens</label>
      <div class="saved-families-list">
        ${families.map(f => {
          const isActive = f.code === activeCode;
          const emoji = isActive ? 'üè†' : 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
          return `<div class="saved-family-card ${isActive?'active':''}" onclick="${isActive?'':'quickSwitchFamily(\''+f.code+'\')'}">
            <div class="saved-family-avatar">${emoji}</div>
            <div class="saved-family-info">
              <div class="saved-family-nickname" id="fn-label-${f.code}">${escHtml(f.nickname)}</div>
              <div class="saved-family-code">${escHtml(f.code)}</div>
              ${isActive ? '<div class="saved-family-active-badge">‚óè Active</div>' : ''}
            </div>
            <div class="saved-family-actions" onclick="event.stopPropagation()">
              <button class="saved-family-edit-btn" onclick="startNicknameEdit('${f.code}')" title="Rename">‚úèÔ∏è</button>
              ${!isActive ? `<button class="saved-family-remove-btn" onclick="confirmRemoveFamily('${f.code}')" title="Remove">‚úï</button>` : ''}
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>` : '';

  // Share Your Code ‚Äî only show for real family codes, not admin
  const copyRow = isAdminMode ? '' : `
    <div class="form-group">
      <label class="form-label">Share Your Code</label>
      <div style="display:flex;gap:8px;">
        <input class="form-input" id="family-code-display" readonly value="${escHtml(activeCode)}"
          style="font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;letter-spacing:2px;color:var(--accent);" />
        <button class="new-cat-btn" id="btn-copy-code" onclick="copyFamilyCode()">Copy</button>
      </div>
      <div style="font-size:0.78rem;color:var(--text2);margin-top:6px;">Share this with family members so they can join your kitchen.</div>
    </div>`;

  const joinRow = `
    <div class="form-group">
      <label class="form-label">${isAdminMode ? 'Switch to a Kitchen' : 'Add Another Kitchen'}</label>
      <div class="join-row">
        <input class="form-input" id="switch-code-input" placeholder="Enter family code" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()" />
        <button class="new-cat-btn" id="btn-switch-family" style="background:var(--shop-accent);" onclick="switchFamily()">Join</button>
      </div>
    </div>`;

  const currencyRow = `
    <hr class="divider">
    <div class="form-group">
      <label class="form-label">Currency</label>
      <select class="form-select" id="settings-currency" onchange="updateCurrency(this.value)"></select>
    </div>`;

  const doneRow = `
    <div class="btn-row">
      <button class="btn btn-secondary" id="btn-close-family" onclick="closeModal('family-overlay')">Done</button>
    </div>`;

  document.getElementById('family-modal-body').innerHTML =
    familyCards + copyRow + joinRow + currencyRow + doneRow;

  populateCurrencySelects();
}

function startNicknameEdit(code){
  const f = STATE.savedFamilies.find(f => f.code === code);
  if(!f) return;
  const label = document.getElementById('fn-label-'+code);
  if(!label) return;
  const currentName = f.nickname;
  label.innerHTML = `<input class="nickname-edit-input" id="nn-input-${code}"
    value="${escHtml(currentName)}"
    onblur="saveNickname('${code}')"
    onkeydown="if(event.key==='Enter'){event.preventDefault();saveNickname('${code}');}if(event.key==='Escape'){cancelNicknameEdit('${code}','${escHtml(currentName)}')}" />`;
  const inp = document.getElementById('nn-input-'+code);
  if(inp){ inp.focus(); inp.select(); }
}

function saveNickname(code){
  const inp = document.getElementById('nn-input-'+code);
  if(!inp) return;
  const val = inp.value.trim() || code;
  upsertSavedFamily(code, val);
  renderFamilyModal();
}

function cancelNicknameEdit(code, original){
  const label = document.getElementById('fn-label-'+code);
  if(label) label.textContent = original;
}

function confirmRemoveFamily(code){
  const f = STATE.savedFamilies.find(f => f.code === code);
  const name = f ? f.nickname : code;
  if(!confirm(`Remove "${name}" from your saved kitchens?\n\nThis only removes it from this device ‚Äî the kitchen data is not deleted.`)) return;
  removeSavedFamily(code);
  renderFamilyModal();
  showToast('Removed from saved kitchens');
}

function copyFamilyCode(){
  navigator.clipboard.writeText(STATE.familyCode)
    .then(() => showToast('Family code copied!'))
    .catch(() => alert('Family code: ' + STATE.familyCode));
}

function updateFamilyBadge(){
  const badge = document.getElementById('family-badge-btn');
  if(badge){
    const f = STATE.savedFamilies.find(f => f.code === STATE.familyCode);
    const label = f && f.nickname !== f.code ? f.nickname : STATE.familyCode;
    badge.textContent = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ' + (label||'‚Äî‚Äî');
  }
  const codeDisplay = document.getElementById('family-code-display');
  if(codeDisplay) codeDisplay.value = STATE.familyCode||'';
}

function hideOnboarding(){
  document.getElementById('onboard-overlay').style.display='none';
  updateFamilyBadge();
}

async function updateCurrency(val){
  STATE.currency = val;
  persistSettings();
  document.getElementById('price-prefix').textContent = currencySymbol(STATE.currency);
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function uid(){ return Math.random().toString(36).slice(2,10); }
function getDefaultItems(){
  return [
    {id:uid(),name:'Whole Milk',     category:'Dairy & Eggs',status:'low', updated:Date.now()-300000,  estimatedPrice:2.49},
    {id:uid(),name:'Eggs',           category:'Dairy & Eggs',status:'out', updated:Date.now()-1800000, estimatedPrice:4.99},
    {id:uid(),name:'Sourdough Bread',category:'Pantry',      status:'low', updated:Date.now()-3600000, estimatedPrice:5.50},
    {id:uid(),name:'Olive Oil',      category:'Pantry',      status:'full',updated:Date.now()-720000,  estimatedPrice:8.99},
    {id:uid(),name:'Bananas',        category:'Produce',     status:'out', updated:Date.now()-600000,  estimatedPrice:1.29},
    {id:uid(),name:'Orange Juice',   category:'Beverages',   status:'low', updated:Date.now()-7200000, estimatedPrice:3.99},
    {id:uid(),name:'Pasta',          category:'Pantry',      status:'full',updated:Date.now()-86400000,estimatedPrice:2.20},
    {id:uid(),name:'Sparkling Water',category:'Beverages',   status:'full',updated:Date.now()-5400000, estimatedPrice:1.50},
  ];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(m){
  STATE.mode=m;
  // Update bottom nav active state ‚Äî only the 4 direct tabs + more for overflow
  ['pantry','shopping','cook','meal'].forEach(t=>{
    const el=document.getElementById('tab-'+t);
    if(el) el.classList.toggle('active', t===m);
  });
  // "More" tab lights up when in stores/history
  const moreTab=document.getElementById('tab-more');
  if(moreTab) moreTab.classList.toggle('active', m==='stores'||m==='history');

  document.body.className = m==='pantry'?'':'mode-'+m;

  // Add button label/visibility
  const addBtn=document.getElementById('main-add-btn');
  if(addBtn){
    const addCircle=addBtn.querySelector('.nav-add-circle');
    if(addCircle){
      addCircle.textContent = m==='meal'?'üìÖ':'Ôºã';
    }
    // Hide add in history/stores/admin ‚Äî done via CSS opacity but also disable pointer
    addBtn.style.pointerEvents=(m==='history'||m==='stores'||m==='admin')?'none':'';
    addBtn.style.opacity=(m==='history'||m==='stores'||m==='admin')?'0.3':'';
  }

  // Feedback FAB ‚Äî hide on admin
  const fab=document.getElementById('btn-feedback-fab');
  if(fab) fab.style.display=(m==='admin')?'none':'flex';

  render();
}

function openMoreDrawer(){
  document.getElementById('more-drawer').classList.add('open');
  document.getElementById('more-drawer-backdrop').classList.add('open');
}

function closeMoreDrawer(){
  document.getElementById('more-drawer').classList.remove('open');
  document.getElementById('more-drawer-backdrop').classList.remove('open');
}

function handleMainAdd(){
  if(STATE.mode==='stores')   openAddStore();
  else if(STATE.mode==='cook') openRecipeEdit(null);
  else if(STATE.mode==='meal') scrollMealToToday();
  else openAddModal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER BAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFilterBar(){
  const bar=document.getElementById('filter-bar');
  if(STATE.mode==='pantry'){
    const pf=STATE.pf;
    bar.innerHTML=`
      <div class="filter-pill needs-pill ${pf.needs?'active':''}" onclick="toggleFilter('needs')">üõí Needs Only</div>
      <div class="filter-pill ${pf.recent?'active':''}" onclick="toggleFilter('recent')">üïê Most Recent</div>
      <div class="filter-pill ${pf.alpha?'active':''}"  onclick="toggleFilter('alpha')">A‚ÄìZ</div>`;
  } else if(STATE.mode==='shopping'){
    const sf=STATE.sf;
    const skippedCount=STATE.skippedIds.size;
    bar.innerHTML=`
      <div class="filter-pill needs-pill ${sf.needsOnly?'active':''}" onclick="toggleShopFilter('needsOnly')">‚ö° Needs Only</div>
      <div class="filter-pill ${sf.recent?'active':''}" onclick="toggleShopFilter('recent')">üïê Recent</div>
      <div class="filter-pill ${sf.alpha?'active':''}"  onclick="toggleShopFilter('alpha')">A‚ÄìZ</div>
      ${skippedCount?`<div class="filter-pill ${sf.showSkipped?'active':''}" onclick="toggleShopFilter('showSkipped')">üëÅ Skipped (${skippedCount})</div>`:''}
      ${skippedCount?`<div class="filter-pill" onclick="clearSkipped()" style="color:#c0392b;">‚úï Clear Skipped</div>`:''}`;
  } else if(STATE.mode==='history'){
    bar.innerHTML=`
      <div style="display:flex;align-items:center;gap:8px;flex:1;">
        <span style="font-size:0.78rem;color:var(--text2);white-space:nowrap;">From</span>
        <input type="date" class="form-input" style="flex:1;padding:6px 10px;font-size:0.78rem;" id="hf-from" value="${STATE.hf.from}" onchange="STATE.hf.from=this.value;renderHistoryTab();" />
        <span style="font-size:0.78rem;color:var(--text2);white-space:nowrap;">To</span>
        <input type="date" class="form-input" style="flex:1;padding:6px 10px;font-size:0.78rem;" id="hf-to" value="${STATE.hf.to}" onchange="STATE.hf.to=this.value;renderHistoryTab();" />
        <div class="filter-pill" style="padding:6px 10px;" onclick="STATE.hf={from:'',to:''};renderFilterBar();renderHistoryTab();">Clear</div>
      </div>`;
  } else {
    bar.innerHTML='';
  }
}

function toggleFilter(f){
  if(f==='recent'||f==='alpha'){STATE.pf.recent=f==='recent';STATE.pf.alpha=f==='alpha';}
  else STATE.pf[f]=!STATE.pf[f];
  render();
}
function toggleShopFilter(f){
  if(f==='recent'||f==='alpha'){STATE.sf.recent=f==='recent';STATE.sf.alpha=f==='alpha';}
  else STATE.sf[f]=!STATE.sf[f];
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN RENDER DISPATCHER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  renderFilterBar();
  // Show/hide shopping extras
  document.getElementById('store-selector-bar').style.display = STATE.mode==='shopping'?'flex':'none';
  document.getElementById('est-total-bar').style.display = STATE.mode==='shopping'?'flex':'none';

  if(STATE.mode==='pantry')    renderPantry();
  else if(STATE.mode==='shopping') renderShoppingTab();
  else if(STATE.mode==='stores')   renderStoresTab();
  else if(STATE.mode==='history')  renderHistoryTab();
  else if(STATE.mode==='cook')     renderCookTab();
  else if(STATE.mode==='meal')     renderMealTab();
  else if(STATE.mode==='admin')    renderAdminTab();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARED RENDER HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sorted(list, byRecent, byAlpha){
  if(byRecent) return [...list].sort((a,b)=>RANK[a.status]!==RANK[b.status]?RANK[a.status]-RANK[b.status]:b.updated-a.updated);
  if(byAlpha)  return [...list].sort((a,b)=>RANK[a.status]!==RANK[b.status]?RANK[a.status]-RANK[b.status]:a.name.localeCompare(b.name));
  return list;
}
function getCatsWithItems(itemList){
  itemList=itemList||STATE.items;
  const used=STATE.categories.filter(cat=>itemList.some(i=>i.category===cat));
  const hasOther=itemList.some(i=>!STATE.categories.includes(i.category));
  return hasOther?[...used,'Other']:used;
}
function getCatItems(cat, itemList){
  itemList=itemList||STATE.items;
  return cat==='Other'?itemList.filter(i=>!STATE.categories.includes(i.category)):itemList.filter(i=>i.category===cat);
}
function catEmoji(cat){ return CAT_EMOJI_MAP[cat]||'üì¶'; }
function empty(icon,title,sub){
  return `<div class="empty"><div class="empty-icon">${icon}</div><div class="empty-title">${title}</div><div class="empty-sub">${sub}</div></div>`;
}
function timeAgo(ts){
  const d=Date.now()-ts;
  if(d<60000)return'just now';
  if(d<3600000)return Math.floor(d/60000)+'m ago';
  if(d<86400000)return Math.floor(d/3600000)+'h ago';
  return Math.floor(d/86400000)+'d ago';
}
function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function formatDate(ts){
  return new Date(ts).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
}
function formatMonth(ts){
  return new Date(ts).toLocaleDateString('en-GB',{month:'long',year:'numeric'});
}

function renderStats(){
  const out =STATE.items.filter(i=>i.status==='out').length;
  const low =STATE.items.filter(i=>i.status==='low').length;
  const full=STATE.items.filter(i=>i.status==='full').length;
  const bar=document.getElementById('stats-bar');
  if(STATE.mode==='shopping'&&STATE.sf.needsOnly){bar.style.display='none';return;}
  bar.style.display='flex';
  let extra='';
  if(STATE.mode==='shopping'){
    const est=calcEstimatedTotal();
    extra=`<div class="stat-chip cost-chip"><div class="stat-num">${est?currencySymbol(STATE.currency)+est.toFixed(2):'‚Äî'}</div><div class="stat-label">Est. Total</div></div>`;
  }
  bar.innerHTML=`
    <div class="stat-chip out-chip"><div class="stat-num">${out}</div><div class="stat-label">Out</div></div>
    <div class="stat-chip low-chip"><div class="stat-num">${low}</div><div class="stat-label">Low</div></div>
    <div class="stat-chip full-chip"><div class="stat-num">${full}</div><div class="stat-label">Stocked</div></div>
    ${extra}`;
}

function itemCard(item, showPrice){
  const emojis={out:'üö´',low:'‚ö†Ô∏è',full:'‚úÖ'};
  const labels={out:'Out',low:'Low',full:'Full'};
  const dotContent=(STATE.mode==='shopping'&&item.status==='full')?'‚úì':emojis[item.status];
  let priceTag='';
  if(showPrice&&item.estimatedPrice){
    // Show per-store price if a store is selected and it has a stored price
    const store=STATE.stores.find(s=>s.id===STATE.selectedStoreId);
    const storePrices=item.storePrices||{};
    const storePrice=store&&storePrices[store.id];
    const displayPrice=storePrice||item.estimatedPrice;
    priceTag=`<div class="item-price-tag">~${fmt(displayPrice)}</div>`;
  }
  return `<div class="item-card status-${item.status}" onclick="openDetail('${item.id}')">
    <div class="status-dot">${dotContent}</div>
    <div class="item-info">
      <div class="item-name">${escHtml(item.name)}</div>
      <div class="item-meta">Updated ${timeAgo(item.updated)}</div>
      ${priceTag}
    </div>
    <div class="status-badge">${labels[item.status]}</div>
  </div>`;
}

function categoryHeader(cat, count){
  return `<div class="category-header">
    <div class="category-name">${catEmoji(cat)} ${escHtml(cat)}<span class="category-count">${count}</span></div>
    <div class="cat-add-btn" onclick="openAddModalForCategory('${escHtml(cat)}')" title="Add item to ${escHtml(cat)}">Ôºã</div>
  </div>`;
}
function renderPantry(){
  renderStats();
  const container=document.getElementById('items-container');
  if(!STATE.items.length){container.innerHTML=empty('ü•ï','Your kitchen is empty!','Tap "+ Add" to start tracking your pantry.');return;}
  let html='';
  for(const cat of getCatsWithItems()){
    let list=getCatItems(cat);
    if(STATE.pf.needs) list=list.filter(i=>i.status!=='full');
    list=sorted(list,STATE.pf.recent,STATE.pf.alpha);
    if(!list.length) continue;
    html+=`<div class="category-section">
      ${categoryHeader(cat, list.length)}
      ${list.map(i=>itemCard(i,false)).join('')}
    </div>`;
  }
  if(!html) html=empty('‚úÖ','All stocked up!','Nothing is out or low right now. Great job!');
  container.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOPPING TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcEstimatedTotal(){
  const needItems=STATE.items.filter(i=>i.status!=='full');
  let total=0; let hasAny=false;
  const store=STATE.stores.find(s=>s.id===STATE.selectedStoreId);
  for(const item of needItems){
    const storePrices=item.storePrices||{};
    const storePrice=store&&storePrices[store.id];
    const price=storePrice||item.estimatedPrice||0;
    if(price){ total+=price; hasAny=true; }
  }
  return hasAny?total:null;
}

function renderShoppingTab(){
  renderStats();
  const store=STATE.stores.find(s=>s.id===STATE.selectedStoreId);
  document.getElementById('ssl-name').textContent=store?store.name+' ‚Äî '+store.city:'Select a store‚Ä¶';
  const est=calcEstimatedTotal();
  document.getElementById('etb-amount').textContent=est?fmt(est):'‚Äî';
  const needCount=STATE.items.filter(i=>i.status!=='full'&&!STATE.skippedIds.has(i.id)).length;
  document.getElementById('etb-note').textContent=needCount+' item'+(needCount!==1?'s':'')+' needed';

  const sub=document.getElementById('shop-banner-sub');
  if(STATE.sf.needsOnly) sub.textContent=`${needCount} item${needCount!==1?'s':''} needed ¬∑ Out first, then Low`;
  else sub.textContent='Out & Low first ¬∑ stocked items shown below';

  const container=document.getElementById('items-container');
  if(!STATE.items.length){container.innerHTML=empty('üõí','Nothing tracked yet!','Tap "+ Add" to add items.');return;}

  let html='';
  for(const cat of getCatsWithItems()){
    const catItems=getCatItems(cat);
    // Partition: active needs, skipped needs, stocked
    const activeNeeds=sorted(
      catItems.filter(i=>i.status!=='full'&&!STATE.skippedIds.has(i.id)),
      STATE.sf.recent,STATE.sf.alpha);
    const skippedNeeds=catItems.filter(i=>i.status!=='full'&&STATE.skippedIds.has(i.id));
    const stockItems=sorted(catItems.filter(i=>i.status==='full'),STATE.sf.recent,STATE.sf.alpha);

    const showSkipped=STATE.sf.showSkipped;
    const visibleNeeds=activeNeeds;
    const visibleStocked=STATE.sf.needsOnly?[]:stockItems;
    const visibleSkipped=showSkipped?skippedNeeds:[];

    if(!visibleNeeds.length&&!visibleStocked.length&&!visibleSkipped.length) continue;
    const displayCount=visibleNeeds.length+(showSkipped?skippedNeeds.length:0)+(STATE.sf.needsOnly?0:stockItems.length);

    html+=`<div class="category-section">
      ${categoryHeader(cat, displayCount)}
      ${visibleNeeds.map(i=>shoppingItemCard(i)).join('')}
      ${visibleNeeds.length&&visibleStocked.length?'<div class="section-divider"><span>Already Stocked</span></div>':''}
      ${visibleStocked.map(i=>itemCard(i,false)).join('')}
      ${visibleSkipped.length?'<div class="section-divider"><span style="color:var(--text2);">Skipped this trip</span></div>':''}
      ${visibleSkipped.map(i=>shoppingItemCard(i,true)).join('')}
    </div>`;
  }
  if(!html) html=STATE.sf.needsOnly?empty('üéâ','Nothing needed!','Everything is stocked!'):empty('üõí','Nothing tracked yet!','Tap "+ Add" to start.');
  container.innerHTML=html;
}

function shoppingItemCard(item, isSkipped=false){
  const labels={out:'OUT',low:'LOW',full:'FULL'};
  const store=STATE.stores.find(s=>s.id===STATE.selectedStoreId);
  const storePrices=item.storePrices||{};
  const storePrice=store&&storePrices[store.id];
  const displayPrice=storePrice||item.estimatedPrice;
  const priceTag=displayPrice?`<div class="item-price-tag">~${fmt(displayPrice)}</div>`:'';
  const dotContent=item.status==='out'?'‚úï':item.status==='low'?'‚ñ≤':'‚úì';
  return `<div class="item-card status-${item.status}${isSkipped?' skipped-item':''}" style="${isSkipped?'opacity:0.45;':''}">
    <div class="status-dot" onclick="openDetail('${item.id}')">${dotContent}</div>
    <div class="item-info" onclick="openDetail('${item.id}')">
      <div class="item-name">${escHtml(item.name)}</div>
      <div class="item-meta">Updated ${timeAgo(item.updated)}</div>
      ${priceTag}
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
      <div class="status-badge">${labels[item.status]}</div>
      <button onclick="toggleSkipItem('${item.id}')" style="font-size:0.68rem;background:none;border:1px solid var(--border);border-radius:50px;padding:2px 8px;cursor:pointer;color:var(--text2);white-space:nowrap;">
        ${isSkipped?'‚Ü© Unskip':'‚è≠ Skip'}
      </button>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORES TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStoresTab(){
  document.getElementById('stats-bar').style.display='none';
  const container=document.getElementById('items-container');
  if(!STATE.stores.length){
    container.innerHTML=empty('üè™','No stores yet','Tap "+ Add" to add your favourite shops. Store-specific price estimates will appear here.');
    return;
  }
  let html='';
  for(const store of STATE.stores){
    const logs=STATE.shopLogs.filter(l=>l.storeId===store.id);
    const avgTotal=logs.length?logs.reduce((s,l)=>s+(l.actualTotal||l.estimatedTotal||0),0)/logs.length:null;
    const lastVisit=logs.length?Math.max(...logs.map(l=>l.date)):null;
    const storeCurrSym=currencySymbol(store.currency||STATE.currency);
    html+=`<div class="store-card" onclick="openStoreDetail('${store.id}')">
      <div class="store-card-top">
        <div class="store-icon">üè™</div>
        <div class="store-info">
          <div class="store-name">${escHtml(store.name)}</div>
          <div class="store-meta">${escHtml(store.city||'')}${store.currency&&store.currency!==STATE.currency?' ¬∑ '+store.currency:''}</div>
          <div class="store-visits">${logs.length} shop${logs.length!==1?'s':''} logged${lastVisit?' ¬∑ Last: '+formatDate(lastVisit):''}</div>
        </div>
        <div>
          <div class="store-avg">${avgTotal?storeCurrSym+avgTotal.toFixed(2):'‚Äî'}</div>
          <div class="store-avg-label">Avg. shop</div>
        </div>
      </div>
    </div>`;
  }
  container.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistoryTab(){
  document.getElementById('stats-bar').style.display='none';
  const container=document.getElementById('items-container');

  let logs=[...STATE.shopLogs].sort((a,b)=>b.date-a.date);

  // Date range filter
  if(STATE.hf.from){ const d=new Date(STATE.hf.from).getTime(); logs=logs.filter(l=>l.date>=d); }
  if(STATE.hf.to)  { const d=new Date(STATE.hf.to).getTime()+86399999; logs=logs.filter(l=>l.date<=d); }

  if(!logs.length){
    container.innerHTML=empty('üìã','No shop history yet','Log a shopping trip in the Shopping tab to see your history here.');
    return;
  }

  // Group by month
  const byMonth={};
  for(const log of logs){
    const mKey=new Date(log.date).toISOString().slice(0,7);
    if(!byMonth[mKey]) byMonth[mKey]=[];
    byMonth[mKey].push(log);
  }

  let html='';
  const totalSpend=logs.reduce((s,l)=>s+(l.actualTotal||l.estimatedTotal||0),0);
  html+=`<div style="background:var(--hist-accent);color:#fff;border-radius:14px;padding:14px 18px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;">
    <div><div style="font-family:'Fraunces',serif;font-size:1rem;font-weight:700;">Total Tracked Spend</div><div style="font-size:0.78rem;opacity:0.8;">${logs.length} shops logged</div></div>
    <div style="font-family:'Fraunces',serif;font-size:1.5rem;font-weight:700;">${fmt(totalSpend)}</div>
  </div>`;

  for(const mKey of Object.keys(byMonth)){
    const monthLogs=byMonth[mKey];
    const monthTotal=monthLogs.reduce((s,l)=>s+(l.actualTotal||l.estimatedTotal||0),0);
    html+=`<div class="history-month-label">${formatMonth(new Date(mKey+'-01').getTime())} <span style="float:right;font-size:0.8rem;font-weight:400;">${fmt(monthTotal)}</span></div>`;
    for(const log of monthLogs){
      const store=STATE.stores.find(s=>s.id===log.storeId);
      const storeName=store?store.name:(log.storeName||'Unknown Store');
      const total=log.actualTotal||log.estimatedTotal;
      const itemCount=(log.items||[]).filter(i=>i.bought).length;
      const needsConversion=store&&store.currency&&store.currency!==STATE.currency;
      const convertedChip=needsConversion?`<span class="converted-chip">~${STATE.currency}</span>`:'';
      html+=`<div class="shop-card" id="sc-${log.id}" onclick="toggleShopCard('${log.id}')">
        <div class="shop-card-top">
          <div>
            <div class="shop-card-store">${escHtml(storeName)}</div>
            <div class="shop-card-date">${formatDate(log.date)}</div>
            <div class="shop-card-items">${itemCount} item${itemCount!==1?'s':''} bought</div>
          </div>
          <div>
            <div class="shop-card-total">${total?fmt(total):'‚Äî'}${convertedChip}</div>
            <div class="shop-card-total-label">Total</div>
          </div>
        </div>
        <div class="shop-card-expanded" id="sce-${log.id}">
          ${renderReceiptLines(log)}
          <div class="btn-row" style="margin-top:12px;">
            <button class="btn btn-danger" style="font-size:0.8rem;padding:10px;" onclick="event.stopPropagation();confirmDeleteShop('${log.id}')">üóë Delete</button>
          </div>
        </div>
      </div>`;
    }
  }
  container.innerHTML=html;
}

function renderReceiptLines(log){
  if(!log.items||!log.items.length) return '<div style="color:var(--text2);font-size:0.82rem;">No items recorded.</div>';
  return log.items.filter(i=>i.bought).map(i=>`
    <div class="receipt-line">
      <span class="rl-name">${escHtml(i.itemName)}</span>
      <span>
        ${i.actualPrice?`<span class="rl-price">${fmt(i.actualPrice)}</span>`:''}
        ${i.estimatedPrice&&i.actualPrice&&Math.abs(i.actualPrice-i.estimatedPrice)>0.01?`<span class="rl-est">(est. ${fmt(i.estimatedPrice)})</span>`:''}
        ${!i.actualPrice&&i.estimatedPrice?`<span class="rl-est">~${fmt(i.estimatedPrice)}</span>`:''}
      </span>
    </div>`).join('');
}

function toggleShopCard(id){
  const el=document.getElementById('sc-'+id);
  if(el) el.classList.toggle('expanded');
}

function confirmDeleteShop(id){
  if(!confirm('Delete this shop log?')) return;
  deleteRecord('shops', id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ITEM CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddModalForCategory(cat){
  openAddModal();
  // After modal opens, pre-select the category
  setTimeout(()=>{
    const sel=document.getElementById('item-category-input');
    if(sel) sel.value=cat;
  }, 50);
}

function openAddModal(){
  STATE.editingItemId=null;
  document.getElementById('modal-title').textContent='Add Item';
  document.getElementById('modal-sub').textContent='';
  document.getElementById('save-btn').textContent='Add Item';
  document.getElementById('item-name-input').value='';
  document.getElementById('new-cat-input').value='';
  document.getElementById('item-price-input').value='';
  STATE.selectedStatus='full';
  populateCatSelect(null);
  updateStatusPicker();
  document.getElementById('price-prefix').textContent=currencySymbol(STATE.currency);
  openModal('add-overlay');
  setTimeout(()=>document.getElementById('item-name-input').focus(),300);
}

function openEditModal(item){
  STATE.editingItemId=item.id;
  document.getElementById('modal-title').textContent='Edit Item';
  document.getElementById('modal-sub').textContent='';
  document.getElementById('save-btn').textContent='Save Changes';
  document.getElementById('item-name-input').value=item.name;
  document.getElementById('new-cat-input').value='';
  document.getElementById('item-price-input').value=item.estimatedPrice||'';
  STATE.selectedStatus=item.status;
  populateCatSelect(item.category);
  updateStatusPicker();
  openModal('add-overlay');
}

function populateCatSelect(selected){
  const el=document.getElementById('item-category-input');
  el.innerHTML=`<option value="">Select a category‚Ä¶</option>`;
  STATE.categories.forEach(c=>el.innerHTML+=`<option value="${escHtml(c)}" ${c===selected?'selected':''}>${escHtml(c)}</option>`);
  // Render category management list
  const mgmt=document.getElementById('cat-manage-list');
  if(!mgmt) return;
  const custom=STATE.categories.filter(c=>!DEFAULT_CATS.includes(c));
  if(!custom.length){ mgmt.innerHTML=''; return; }
  mgmt.innerHTML=`<div style="font-size:0.72rem;color:var(--text2);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Custom categories</div>`+
    custom.map(c=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--surface2);border-radius:8px;margin-bottom:4px;">
      <span style="font-size:0.85rem;">${escHtml(c)}</span>
      <button onclick="deleteCategory('${escHtml(c)}')" style="background:none;border:none;cursor:pointer;color:#c0392b;font-size:0.8rem;padding:2px 6px;">üóë</button>
    </div>`).join('');
}

function selectStatus(s){ STATE.selectedStatus=s; updateStatusPicker(); }
function updateStatusPicker(){
  document.querySelectorAll('.status-option').forEach(el=>el.classList.toggle('selected',el.dataset.val===STATE.selectedStatus));
}

async function saveItem(){
  const name=document.getElementById('item-name-input').value.trim();
  let cat=document.getElementById('item-category-input').value;
  const priceRaw=document.getElementById('item-price-input').value;
  const estimatedPrice=priceRaw?Number(parseFloat(priceRaw).toFixed(2)):null;
  if(!name){document.getElementById('item-name-input').focus();return;}
  if(!cat) cat='Other';
  // Capture editingItemId BEFORE closing the modal ‚Äî closing triggers re-renders
  // that can reset STATE.editingItemId to null
  const editingId=STATE.editingItemId;
  STATE.editingItemId=null; // clear immediately so it can't bleed into next open
  closeModal('add-overlay');
  if(editingId){
    // Re-look up fresh from STATE in case Firebase updated it during the edit
    const existing=STATE.items.find(i=>i.id===editingId);
    if(existing){
      await saveRecord('items',{...existing,name,category:cat,status:STATE.selectedStatus,estimatedPrice,updated:Date.now()});
    }
  } else {
    await saveRecord('items',{id:uid(),name,category:cat,status:STATE.selectedStatus,estimatedPrice,updated:Date.now()});
  }
}

function openEditFromDetail(){
  // Capture the ID now ‚Äî the item object reference may go stale
  // if Firebase fires between closeModal and setTimeout
  const id=STATE.detailItemId;
  closeModal('detail-overlay');
  setTimeout(()=>{
    const item=STATE.items.find(i=>i.id===id);
    if(item) openEditModal(item);
  },200);
}

async function deleteItem(){
  const id=STATE.detailItemId;
  const item=STATE.items.find(i=>i.id===id);
  if(!item) return;
  if(!confirm(`Remove "${item.name}"?`)) return;
  // Clear state and close BEFORE the async delete so UI is clean
  STATE.detailItemId=null;
  closeModal('detail-overlay');
  await deleteRecord('items',id);
}

function openDetail(id){
  STATE.detailItemId=id;
  const item=STATE.items.find(i=>i.id===id);
  if(!item) return;
  document.getElementById('detail-title').textContent=item.name;
  const priceTxt=item.estimatedPrice?` ¬∑ ~${fmt(item.estimatedPrice)}`:'';
  document.getElementById('detail-sub').textContent=item.category+priceTxt;
  openModal('detail-overlay');
}

async function updateStatus(status){
  const item=STATE.items.find(i=>i.id===STATE.detailItemId);
  if(item){ await saveRecord('items',{...item,status,updated:Date.now()}); }
  closeModal('detail-overlay');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORE CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddStore(){
  STATE.editingStoreId=null;
  document.getElementById('add-store-title').textContent='Add Store';
  document.getElementById('store-name-input').value='';
  document.getElementById('store-city-input').value='';
  const sel=document.getElementById('store-currency-input');
  sel.innerHTML=CURRENCIES.map(c=>`<option value="${c.code}">${c.symbol} ${c.code} ‚Äî ${c.name}</option>`).join('');
  sel.value=STATE.currency;
  document.getElementById('btn-delete-store').style.display='none';
  openModal('add-store-overlay');
  setTimeout(()=>document.getElementById('store-name-input').focus(),300);
}

function openStoreDetail(id){
  STATE.editingStoreId=id;
  const store=STATE.stores.find(s=>s.id===id);
  if(!store) return;
  document.getElementById('add-store-title').textContent='Edit Store';
  document.getElementById('store-name-input').value=store.name;
  document.getElementById('store-city-input').value=store.city||'';
  const sel=document.getElementById('store-currency-input');
  sel.innerHTML=CURRENCIES.map(c=>`<option value="${c.code}">${c.symbol} ${c.code} ‚Äî ${c.name}</option>`).join('');
  sel.value=store.currency||STATE.currency;
  document.getElementById('btn-delete-store').style.display='block';
  openModal('add-store-overlay');
}

async function saveStore(){
  const name=document.getElementById('store-name-input').value.trim();
  const city=document.getElementById('store-city-input').value.trim();
  const currency=document.getElementById('store-currency-input').value;
  if(!name){document.getElementById('store-name-input').focus();return;}
  const existing=STATE.editingStoreId?STATE.stores.find(s=>s.id===STATE.editingStoreId):null;
  const store={
    id: existing?existing.id:uid(),
    name, city, currency,
  };
  await saveRecord('stores', store);
  closeModal('add-store-overlay');
}

async function deleteStore(){
  if(!STATE.editingStoreId) return;
  const store=STATE.stores.find(s=>s.id===STATE.editingStoreId);
  if(!store) return;
  if(!confirm(`Remove "${store.name}"? This won't delete your shop history for this store.`)) return;
  await deleteRecord('stores', STATE.editingStoreId);
  if(STATE.selectedStoreId===STATE.editingStoreId) STATE.selectedStoreId=null;
  closeModal('add-store-overlay');
}

// Store picker list ‚Äî with search filter
function renderStorePickList(filter){
  filter=(filter||'').toLowerCase();
  const container=document.getElementById('store-pick-list');
  if(!STATE.stores.length){
    container.innerHTML=`<div style="text-align:center;color:var(--text2);padding:24px 0;font-size:0.88rem;">No stores yet. Add one below.</div>`;
    return;
  }
  const filtered=STATE.stores.filter(s=>
    s.name.toLowerCase().includes(filter)||
    (s.city||'').toLowerCase().includes(filter)
  );
  if(!filtered.length){
    container.innerHTML=`<div style="text-align:center;color:var(--text2);padding:16px 0;font-size:0.88rem;">No stores match "${filter}"</div>`;
    return;
  }
  container.innerHTML=filtered.map(s=>`
    <div class="action-item ${s.id===STATE.selectedStoreId?'full':''}" onclick="selectStore('${s.id}')" style="margin-bottom:8px;">
      <span style="font-size:1.3rem;">üè™</span>
      <div style="flex:1;">
        <div>${escHtml(s.name)}</div>
        <div class="ai-sub">${escHtml(s.city||'')}${s.currency&&s.currency!==STATE.currency?' ¬∑ '+s.currency:''}</div>
      </div>
      ${s.id===STATE.selectedStoreId?'<span>‚úì</span>':''}
    </div>`).join('');
}

function selectStore(id){
  STATE.selectedStoreId=id;
  closeModal('store-pick-overlay');
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CATEGORY MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function addNewCategory(){
  const val=document.getElementById('new-cat-input').value.trim();
  if(!val) return;
  if(!STATE.categories.includes(val)){
    STATE.categories.push(val);
    await save('cats', STATE.categories);
  }
  populateCatSelect(val);
  document.getElementById('new-cat-input').value='';
}

async function deleteCategory(cat){
  const usedBy=STATE.items.filter(i=>i.category===cat);
  let msg=`Remove category "${cat}"?`;
  if(usedBy.length) msg+=`\n\n${usedBy.length} item${usedBy.length!==1?'s':''} use this category and will move to "Other".`;
  if(!confirm(msg)) return;
  STATE.categories=STATE.categories.filter(c=>c!==cat);
  await save('cats', STATE.categories);
  // Move affected items to Other
  for(const item of usedBy){
    await saveRecord('items',{...item,category:'Other',updated:Date.now()});
  }
  populateCatSelect(null);
}

// Override openModal for store-pick to also render the list
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOP LOGGING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLogShop(){
  const store=STATE.stores.find(s=>s.id===STATE.selectedStoreId);
  const storeSym=currencySymbol(store?store.currency:STATE.currency);
  document.getElementById('log-shop-sub').textContent=
    store?`Logging a shop at ${store.name}`:'Log this shopping trip';
  document.getElementById('log-total-prefix').textContent=storeSym;

  // Date default = today
  const today=new Date().toISOString().slice(0,10);
  document.getElementById('log-shop-date').value=today;
  document.getElementById('log-total-override').value='';
  document.getElementById('log-total-calc').textContent='‚Äî';

  // Build item list ‚Äî Out and Low items
  const needItems=STATE.items.filter(i=>i.status!=='full');
  const logList=document.getElementById('log-items-list');
  if(!needItems.length){
    logList.innerHTML=`<div style="color:var(--text2);font-size:0.85rem;padding:12px 0;">No items currently out or low.</div>`;
  } else {
    logList.innerHTML=needItems.map(item=>{
      const storePrices=item.storePrices||{};
      const storePrice=store&&storePrices[store.id];
      const price=storePrice||item.estimatedPrice||'';
      return `<div class="log-item-row">
        <div class="log-item-check" id="chk-${item.id}" onclick="toggleLogItem('${item.id}')">‚úì</div>
        <div class="log-item-name">${escHtml(item.name)}</div>
        <div class="log-item-price">
          <div class="currency-prefix">
            <span class="prefix">${storeSym}</span>
            <input class="form-input" id="lprice-${item.id}" type="number" min="0" step="0.01" value="${price}" placeholder="0.00" oninput="recalcLogTotal()" style="border-radius:0 10px 10px 0;" />
          </div>
        </div>
      </div>`;
    }).join('');
    // Default all checked
    needItems.forEach(item=>{
      document.getElementById('chk-'+item.id)?.classList.add('checked');
    });
  }
  recalcLogTotal();
  openModal('log-shop-overlay');
}

function toggleLogItem(id){
  const el=document.getElementById('chk-'+id);
  if(el) el.classList.toggle('checked');
  recalcLogTotal();
}

function recalcLogTotal(){
  const needItems=STATE.items.filter(i=>i.status!=='full');
  let total=0;
  for(const item of needItems){
    const chk=document.getElementById('chk-'+item.id);
    if(!chk||!chk.classList.contains('checked')) continue;
    const priceEl=document.getElementById('lprice-'+item.id);
    const price=priceEl?parseFloat(priceEl.value)||0:0;
    total+=price;
  }
  document.getElementById('log-total-calc').textContent=total>0?fmt(total,STATE.stores.find(s=>s.id===STATE.selectedStoreId)?.currency||STATE.currency):'‚Äî';
}

async function saveShopLog(){
  const dateVal=document.getElementById('log-shop-date').value;
  const dateTs=dateVal?new Date(dateVal).getTime():Date.now();
  const store=STATE.stores.find(s=>s.id===STATE.selectedStoreId);
  const storeCurrency=store?.currency||STATE.currency;

  const needItems=STATE.items.filter(i=>i.status!=='full');
  const logItems=needItems.map(item=>{
    const chk=document.getElementById('chk-'+item.id);
    const bought=chk&&chk.classList.contains('checked');
    const priceEl=document.getElementById('lprice-'+item.id);
    const actualPrice=priceEl&&priceEl.value?Number(parseFloat(priceEl.value).toFixed(2)):null;
    return {itemId:item.id,itemName:item.name,bought,estimatedPrice:item.estimatedPrice||null,actualPrice};
  });

  // Calc totals
  let calcTotal=0;
  logItems.filter(i=>i.bought).forEach(i=>calcTotal+=(i.actualPrice||i.estimatedPrice||0));
  const overrideVal=document.getElementById('log-total-override').value;
  const actualTotal=overrideVal?Number(parseFloat(overrideVal).toFixed(2)):calcTotal||null;

  const shopLog={
    id:uid(),
    storeId:STATE.selectedStoreId||null,
    storeName:store?store.name:'Unknown',
    date:dateTs,
    items:logItems,
    estimatedTotal:calcEstimatedTotal(),
    actualTotal,
    currency:storeCurrency,
  };
  await saveRecord('shops', shopLog);

  // Update item prices + mark bought items as full
  for(const li of logItems){
    if(!li.bought) continue;
    const item=STATE.items.find(i=>i.id===li.itemId);
    if(!item) continue;
    const updated={...item, status:'full', updated:Date.now()};
    if(li.actualPrice&&STATE.selectedStoreId){
      if(!updated.storePrices) updated.storePrices={};
      updated.storePrices[STATE.selectedStoreId]=li.actualPrice;
    }
    if(li.actualPrice){
      const old=updated.estimatedPrice||li.actualPrice;
      updated.estimatedPrice=Number(((old+li.actualPrice)/2).toFixed(2));
    }
    await saveRecord('items', updated);
  }

  closeModal('log-shop-overlay');
  alert(`Shop logged! ${logItems.filter(i=>i.bought).length} items marked as stocked.`);
  setMode('history');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COOK TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCookTab(){
  document.getElementById('stats-bar').style.display='none';
  document.getElementById('filter-bar').innerHTML='';
  const container=document.getElementById('items-container');
  if(!STATE.recipes.length){
    container.innerHTML=empty('üë®‚Äçüç≥','No recipes yet','Tap "+ Add" to create your first recipe.');
    return;
  }
  container.innerHTML=STATE.recipes.map(r=>`
    <div class="recipe-card" onclick="openRecipeDetail('${r.id}')">
      <div class="recipe-card-top">
        <div class="recipe-emoji">${escHtml(r.emoji||'üçΩÔ∏è')}</div>
        <div class="recipe-info">
          <div class="recipe-name">${escHtml(r.name)}</div>
          <div class="recipe-desc">${escHtml(r.description||'')}</div>
          <div class="recipe-meta">
            ${r.cookTime?`<span class="recipe-chip">‚è± ${escHtml(r.cookTime)}</span>`:''}
            <span class="recipe-chip">üß∫ ${(r.ingredients||[]).length} ingredients</span>
            <span class="recipe-chip">üìã ${(r.steps||[]).length} steps</span>
          </div>
        </div>
      </div>
    </div>`).join('');
}

function openRecipeDetail(id){
  const r=STATE.recipes.find(r=>r.id===id);
  if(!r) return;
  const container=document.getElementById('items-container');
  const ings=(r.ingredients||[]).map(i=>`
    <div class="ingredient-row">
      <span class="ingredient-qty">${escHtml(i.qty||'')}</span>
      <span class="ingredient-name">${escHtml(i.name)}</span>
    </div>`).join('');
  const steps=(r.steps||[]).map((s,idx)=>`
    <div class="step-row">
      <span class="step-num">${idx+1}</span>
      <span class="step-text">${escHtml(s)}</span>
    </div>`).join('');
  container.innerHTML=`
    <div class="recipe-detail-header">
      <div class="recipe-detail-emoji">${escHtml(r.emoji||'üçΩÔ∏è')}</div>
      <div class="recipe-detail-name">${escHtml(r.name)}</div>
      ${r.description?`<div class="recipe-detail-desc">${escHtml(r.description)}</div>`:''}
      <div class="recipe-detail-chips">
        ${r.cookTime?`<span class="recipe-detail-chip">‚è± ${escHtml(r.cookTime)}</span>`:''}
        <span class="recipe-detail-chip">üß∫ ${(r.ingredients||[]).length} ingredients</span>
        <span class="recipe-detail-chip">üìã ${(r.steps||[]).length} steps</span>
      </div>
      ${(r.steps||[]).length?`<button class="start-cooking-btn" onclick="startFocusMode('${r.id}')">üî• Start Cooking</button>`:''}
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button class="btn btn-secondary" style="flex:1;" onclick="renderCookTab()">‚Üê Back</button>
      <button class="btn btn-primary" style="flex:1;background:var(--cook-accent);" onclick="openRecipeEdit('${r.id}')">‚úèÔ∏è Edit Recipe</button>
    </div>
    ${(r.ingredients||[]).length?`<div class="recipe-section-title">Ingredients</div>${ings}`:''}
    ${(r.steps||[]).length?`<div class="recipe-section-title">Steps</div>${steps}`:''}
  `;
}

function toggleSkipItem(id){
  if(STATE.skippedIds.has(id)) STATE.skippedIds.delete(id);
  else STATE.skippedIds.add(id);
  renderShoppingTab();
  renderFilterBar();
}
function clearSkipped(){
  STATE.skippedIds.clear();
  STATE.sf.showSkipped=false;
  render();
}

// ‚îÄ‚îÄ Ingredient tab switcher ‚îÄ‚îÄ
function switchIngTab(tab){
  const isPantry=tab==='pantry';
  document.getElementById('ing-tab-pantry').style.background=isPantry?'var(--cook-accent)':'var(--surface2)';
  document.getElementById('ing-tab-pantry').style.color=isPantry?'#fff':'var(--text2)';
  document.getElementById('ing-tab-custom').style.background=isPantry?'var(--surface2)':'var(--cook-accent)';
  document.getElementById('ing-tab-custom').style.color=isPantry?'var(--text2)':'#fff';
  document.getElementById('ing-panel-pantry').style.display=isPantry?'flex':'none';
  document.getElementById('ing-panel-custom').style.display=isPantry?'none':'flex';
  document.getElementById('ing-custom-note').style.display=isPantry?'none':'block';
}

async function addCustomIngredient(){
  const name=document.getElementById('recipe-ing-custom-name').value.trim();
  const qty=document.getElementById('recipe-ing-custom-qty').value.trim();
  if(!name) return;
  // Add to recipe ingredients list
  _recipeIngredients.push({name,qty});
  renderRecipeIngredientsList();
  document.getElementById('recipe-ing-custom-name').value='';
  document.getElementById('recipe-ing-custom-qty').value='';
  // Check if item already exists in pantry (case-insensitive)
  const exists=STATE.items.find(i=>i.name.toLowerCase()===name.toLowerCase());
  if(!exists){
    // Create new pantry item as "out"
    const newItem={id:uid(),name,category:'Other',status:'out',estimatedPrice:null,updated:Date.now()};
    await saveRecord('items',newItem);
    // Also add to the dropdown for subsequent picks
    const opt=document.createElement('option');
    opt.value=name; opt.textContent=name;
    document.getElementById('recipe-ing-item-select').appendChild(opt);
  }
}
let _recipeIngredients=[]; // working copy during edit
let _recipeSteps=[];

function openRecipeEdit(id){
  STATE.editingRecipeId=id;
  const r=id?STATE.recipes.find(r=>r.id===id):null;
  document.getElementById('recipe-edit-title').textContent=r?'Edit Recipe':'New Recipe';
  document.getElementById('recipe-name-input').value=r?r.name:'';
  document.getElementById('recipe-desc-input').value=r?r.description||'':'';
  document.getElementById('recipe-emoji-input').value=r?r.emoji||'':'';
  document.getElementById('recipe-time-input').value=r?r.cookTime||'':'';
  document.getElementById('btn-delete-recipe').style.display=r?'block':'none';
  _recipeIngredients=r?(r.ingredients||[]).map(i=>({...i})):[];
  _recipeSteps=r?[...(r.steps||[])]:[];
  _editingStepIdx=null;
  _dragSrcIdx=null;
  // Populate item picker
  const sel=document.getElementById('recipe-ing-item-select');
  sel.innerHTML=`<option value="">Pick an item‚Ä¶</option>`+
    [...STATE.items].sort((a,b)=>a.name.localeCompare(b.name))
      .map(i=>`<option value="${escHtml(i.name)}">${escHtml(i.name)}</option>`).join('');
  renderRecipeIngredientsList();
  renderRecipeStepsList();
  openModal('recipe-edit-overlay');
}

function renderRecipeIngredientsList(){
  document.getElementById('recipe-ingredients-list').innerHTML=
    _recipeIngredients.map((ing,idx)=>`
      <div class="ingredient-row">
        <span class="ingredient-qty">${escHtml(ing.qty||'')}</span>
        <span class="ingredient-name">${escHtml(ing.name)}</span>
        <button class="ingredient-del" onclick="removeRecipeIngredient(${idx})">‚úï</button>
      </div>`).join('') || '<div style="color:var(--text2);font-size:0.85rem;padding:4px 0 8px;">No ingredients yet.</div>';
}

// Track which step is being inline-edited
let _editingStepIdx = null;
// Drag state
let _dragSrcIdx = null;

function renderRecipeStepsList(){
  const container = document.getElementById('recipe-steps-list');
  if(!_recipeSteps.length){
    container.innerHTML='<div style="color:var(--text2);font-size:0.85rem;padding:4px 0 8px;">No steps yet.</div>';
    return;
  }
  const isTouchDevice = (() => {
    try { return window.matchMedia('(hover:none)').matches || ('ontouchstart' in window); }
    catch(e) { return 'ontouchstart' in window; }
  })();
  container.innerHTML = _recipeSteps.map((s, idx) => {
    const isEditing = _editingStepIdx === idx;
    return `<div class="step-row" draggable="true" data-idx="${idx}" id="step-row-${idx}">
      ${isTouchDevice
        ? `<div class="step-actions" style="flex-direction:column;gap:0;">
             <button class="step-btn move" onclick="moveStep(${idx},-1)" title="Move up" ${idx===0?'style="opacity:0.15;pointer-events:none;"':''}>‚ñ≤</button>
             <button class="step-btn move" onclick="moveStep(${idx},1)" title="Move down" ${idx===_recipeSteps.length-1?'style="opacity:0.15;pointer-events:none;"':''}>‚ñº</button>
           </div>`
        : `<div class="step-drag-handle" title="Drag to reorder">‚†ø</div>`
      }
      <span class="step-num">${idx+1}</span>
      ${isEditing
        ? `<div class="step-edit-area">
             <textarea class="step-edit-textarea" id="step-edit-${idx}">${escHtml(s)}</textarea>
             <div class="step-edit-actions">
               <button class="btn btn-secondary" style="flex:1;padding:8px;" onclick="cancelEditStep()">Cancel</button>
               <button class="btn btn-primary" style="flex:1;padding:8px;background:var(--cook-accent);" onclick="saveEditStep(${idx})">Save</button>
             </div>
           </div>`
        : `<span class="step-text">${escHtml(s)}</span>`
      }
      ${isEditing ? '' : `
        <div class="step-actions">
          <button class="step-btn edit" onclick="startEditStep(${idx})" title="Edit">‚úèÔ∏è</button>
          <button class="step-btn del"  onclick="removeRecipeStep(${idx})" title="Delete">‚úï</button>
        </div>`
      }
    </div>`;
  }).join('');

  // Wire up drag-and-drop on the rendered rows (desktop only)
  if(!isTouchDevice) setupStepDragDrop();
}

function setupStepDragDrop(){
  const rows = document.querySelectorAll('#recipe-steps-list .step-row');
  rows.forEach(row => {
    row.addEventListener('dragstart', e => {
      _dragSrcIdx = parseInt(row.dataset.idx);
      row.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    row.addEventListener('dragend', () => {
      row.classList.remove('dragging');
      document.querySelectorAll('.step-row').forEach(r => r.classList.remove('drag-over'));
    });
    row.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.querySelectorAll('.step-row').forEach(r => r.classList.remove('drag-over'));
      row.classList.add('drag-over');
    });
    row.addEventListener('drop', e => {
      e.preventDefault();
      const destIdx = parseInt(row.dataset.idx);
      if(_dragSrcIdx === null || _dragSrcIdx === destIdx) return;
      const moved = _recipeSteps.splice(_dragSrcIdx, 1)[0];
      _recipeSteps.splice(destIdx, 0, moved);
      _dragSrcIdx = null;
      _editingStepIdx = null;
      renderRecipeStepsList();
    });
  });
}

function moveStep(idx, dir){
  const newIdx = idx + dir;
  if(newIdx < 0 || newIdx >= _recipeSteps.length) return;
  const tmp = _recipeSteps[idx];
  _recipeSteps[idx] = _recipeSteps[newIdx];
  _recipeSteps[newIdx] = tmp;
  _editingStepIdx = null;
  renderRecipeStepsList();
}

function startEditStep(idx){
  _editingStepIdx = idx;
  renderRecipeStepsList();
  // Focus the textarea and place cursor at end
  const ta = document.getElementById(`step-edit-${idx}`);
  if(ta){ ta.focus(); ta.selectionStart = ta.selectionEnd = ta.value.length; }
}

function saveEditStep(idx){
  const ta = document.getElementById(`step-edit-${idx}`);
  if(!ta) return;
  const val = ta.value.trim();
  if(val) _recipeSteps[idx] = val;
  _editingStepIdx = null;
  renderRecipeStepsList();
}

function cancelEditStep(){
  _editingStepIdx = null;
  renderRecipeStepsList();
}

function addRecipeIngredient(){
  const name=document.getElementById('recipe-ing-item-select').value;
  const qty=document.getElementById('recipe-ing-qty-input').value.trim();
  if(!name) return;
  _recipeIngredients.push({name,qty});
  document.getElementById('recipe-ing-qty-input').value='';
  document.getElementById('recipe-ing-item-select').value='';
  renderRecipeIngredientsList();
}

function removeRecipeIngredient(idx){
  _recipeIngredients.splice(idx,1);
  renderRecipeIngredientsList();
}

function addRecipeStep(){
  const text=document.getElementById('recipe-step-input').value.trim();
  if(!text) return;
  _recipeSteps.push(text);
  document.getElementById('recipe-step-input').value='';
  renderRecipeStepsList();
}

function removeRecipeStep(idx){
  _recipeSteps.splice(idx,1);
  renderRecipeStepsList();
}

async function saveRecipe(){
  const name=document.getElementById('recipe-name-input').value.trim();
  if(!name){ document.getElementById('recipe-name-input').focus(); return; }
  const editingId=STATE.editingRecipeId;
  STATE.editingRecipeId=null;
  closeModal('recipe-edit-overlay');
  const recipe={
    id: editingId||(uid()),
    name,
    description: document.getElementById('recipe-desc-input').value.trim(),
    emoji: document.getElementById('recipe-emoji-input').value.trim()||'üçΩÔ∏è',
    cookTime: document.getElementById('recipe-time-input').value.trim(),
    ingredients: [..._recipeIngredients],
    steps: [..._recipeSteps],
    updated: Date.now(),
  };
  await saveRecord('recipes', recipe);
  setMode('cook');
}

async function deleteRecipe(){
  const id=STATE.editingRecipeId;
  if(!id) return;
  if(!confirm('Delete this recipe?')) return;
  STATE.editingRecipeId=null;
  closeModal('recipe-edit-overlay');
  await deleteRecord('recipes', id);
  setMode('cook');
}

// ‚îÄ‚îÄ Focus / Cooking Mode ‚îÄ‚îÄ
function startFocusMode(id){
  const r=STATE.recipes.find(r=>r.id===id);
  if(!r||(r.steps||[]).length===0) return;
  STATE.focusRecipeId=id;
  STATE.focusStep=0;
  STATE.focusGrabbed={};
  document.getElementById('focus-recipe-name').textContent=r.emoji+' '+r.name;
  document.getElementById('focus-ingredients-panel').classList.remove('open');
  document.getElementById('btn-toggle-ingredients').textContent='üß∫ Show Ingredients';
  renderFocusStep();
  // Wake Lock ‚Äî keep screen on
  if('wakeLock' in navigator){
    navigator.wakeLock.request('screen').catch(()=>{});
  }
  document.getElementById('focus-overlay').classList.add('active');
  document.body.style.overflow='hidden';
}

function exitFocusMode(){
  document.getElementById('focus-overlay').classList.remove('active');
  document.body.style.overflow='';
  STATE.focusRecipeId=null;
}

function renderFocusStep(){
  const r=STATE.recipes.find(r=>r.id===STATE.focusRecipeId);
  if(!r) return;
  const steps=r.steps||[];
  const current=STATE.focusStep;
  const area=document.getElementById('focus-steps-area');

  // Time remaining calculation
  const timeEl=document.getElementById('focus-time-remaining');
  const totalMins=parseTimeToMinutes(r.cookTime);
  if(totalMins && steps.length && current < steps.length){
    const minsPerStep = totalMins / steps.length;
    const remaining = Math.round(minsPerStep * (steps.length - current));
    timeEl.textContent = `‚è± ~${remaining} min remaining`;
  } else {
    timeEl.textContent = r.cookTime ? `‚è± ${r.cookTime} total` : '';
  }

  if(current>=steps.length){
    area.innerHTML=`<div class="focus-complete-banner">
      <div class="big-emoji">üéâ</div>
      <h2>All done!</h2>
      <p>${escHtml(r.name)} is ready. Enjoy!</p>
    </div>`;
    document.getElementById('btn-focus-next').textContent='üè† Back to Recipes';
    document.getElementById('btn-focus-next').className='focus-next-btn done';
    timeEl.textContent='';
    return;
  }

  const doneHtml=steps.slice(0,current).map((s,i)=>`
    <div class="focus-done-item">
      <span class="done-check">‚úì</span>
      <span>Step ${i+1}: ${escHtml(s.length>50?s.slice(0,50)+'‚Ä¶':s)}</span>
    </div>`).join('');

  const upcomingHtml=steps.slice(current+1).map((s,i)=>`
    <div class="focus-upcoming-item">
      <span class="focus-upcoming-num">${current+i+2}</span>
      <span>${escHtml(s)}</span>
    </div>`).join('');

  area.innerHTML=`
    <div class="focus-done-list">${doneHtml}</div>
    <div class="focus-current-step">
      <div class="focus-step-label">Step ${current+1} of ${steps.length}</div>
      <div class="focus-step-text">${escHtml(steps[current])}</div>
    </div>
    <div class="focus-upcoming">${upcomingHtml}</div>`;

  const btn=document.getElementById('btn-focus-next');
  btn.textContent=current===steps.length-1?'‚úì Finish Cooking ‚Üí':'Mark Step Done ‚Üí';
  btn.className='focus-next-btn';

  const ings=r.ingredients||[];
  document.getElementById('focus-ingredients-panel').innerHTML=
    ings.length?ings.map((ing,idx)=>`
      <div class="focus-ing-item ${STATE.focusGrabbed[idx]?'grabbed':''}" onclick="toggleFocusGrab(${idx})">
        <span class="focus-ing-qty">${escHtml(ing.qty||'')}</span>
        <span>${escHtml(ing.name)}</span>
      </div>`).join('')
    :'<div style="color:rgba(255,255,255,0.4);font-size:0.85rem;">No ingredients listed.</div>';
}

// Parse cook time string like "45 min", "1h 30m", "2 hours" ‚Üí minutes
function parseTimeToMinutes(str){
  if(!str) return null;
  str=str.toLowerCase();
  let mins=0;
  const h=str.match(/(\d+)\s*h/); if(h) mins+=parseInt(h[1])*60;
  const m=str.match(/(\d+)\s*m/); if(m) mins+=parseInt(m[1]);
  if(!mins){ const n=str.match(/(\d+)/); if(n) mins=parseInt(n[1]); }
  return mins||null;
}

function advanceFocusStep(){
  const r=STATE.recipes.find(r=>r.id===STATE.focusRecipeId);
  if(!r) return;
  if(STATE.focusStep>=r.steps.length){
    exitFocusMode();
    return;
  }
  STATE.focusStep++;
  // Smooth scroll to top of steps area
  document.getElementById('focus-steps-area').scrollTo({top:0,behavior:'smooth'});
  renderFocusStep();
}

function toggleFocusGrab(idx){
  STATE.focusGrabbed[idx]=!STATE.focusGrabbed[idx];
  renderFocusStep();
}

function toggleFocusIngredients(){
  const panel=document.getElementById('focus-ingredients-panel');
  const btn=document.getElementById('btn-toggle-ingredients');
  const open=panel.classList.toggle('open');
  btn.textContent=open?'üß∫ Hide Ingredients':'üß∫ Show Ingredients';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEAL PLAN TAB ‚Äî Day / Week / Month / Templates
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MEAL_SLOTS = ['breakfast','lunch','dinner','snacks'];
const MEAL_SLOT_LABELS = {breakfast:'üåÖ Breakfast',lunch:'‚òÄÔ∏è Lunch',dinner:'üåô Dinner',snacks:'üçé Snacks'};
const TEMPLATE_DAYS = ['mon','tue','wed','thu','fri','sat','sun'];
const TEMPLATE_DAY_LABELS = {mon:'Mon',tue:'Tue',wed:'Wed',thu:'Thu',fri:'Fri',sat:'Sat',sun:'Sun'};

function dateStr(d){ return d.toISOString().slice(0,10); }
function todayStr(){ return dateStr(new Date()); }
function getMealDay(ds){ return STATE.mealPlan[ds] || {breakfast:[],lunch:[],dinner:[],snacks:[]}; }
function mealEntryCount(ds){ const d=getMealDay(ds); return MEAL_SLOTS.reduce((n,s)=>n+(d[s]||[]).length,0); }
function entryEmoji(e){ return e.type==='recipe'?(STATE.recipes.find(r=>r.id===e.id)||{emoji:'üçΩÔ∏è'}).emoji||'üçΩÔ∏è':catEmoji((STATE.items.find(i=>i.id===e.id)||{}).category||''); }

// Get Monday of the week containing date d
function getMonday(d){ const c=new Date(d); c.setHours(0,0,0,0); const day=c.getDay(); c.setDate(c.getDate()-(day===0?6:day-1)); return c; }
function addDays(d,n){ const c=new Date(d); c.setDate(c.getDate()+n); return c; }
// Day-of-week string mon/tue/etc for a Date
function dowKey(d){ return ['sun','mon','tue','wed','thu','fri','sat'][d.getDay()]; }

// ‚îÄ‚îÄ MAIN RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMealTab(){
  document.getElementById('stats-bar').style.display='none';
  document.getElementById('filter-bar').innerHTML='';
  const container=document.getElementById('items-container');
  if(!STATE.selectedMealDate) STATE.selectedMealDate=todayStr();

  const viewBar=`<div class="meal-view-bar">
    <button class="meal-view-btn ${STATE.mealView==='day'?'active':''}" onclick="setMealView('day')">üìÖ Day</button>
    <button class="meal-view-btn ${STATE.mealView==='week'?'active':''}" onclick="setMealView('week')">üìÜ Week</button>
    <button class="meal-view-btn ${STATE.mealView==='month'?'active':''}" onclick="setMealView('month')">üóì Month</button>
    <button class="meal-view-btn ${STATE.mealView==='templates'?'active':''}" onclick="setMealView('templates')">üìã Templates</button>
  </div>`;

  if(STATE.mealView==='day')       container.innerHTML=viewBar+renderDayView();
  else if(STATE.mealView==='week') container.innerHTML=viewBar+renderWeekView();
  else if(STATE.mealView==='month')container.innerHTML=viewBar+renderMonthView();
  else                             container.innerHTML=viewBar+renderTemplatesView();
}

function setMealView(v){ STATE.mealView=v; renderMealTab(); }

// ‚îÄ‚îÄ DAY VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDayView(){
  const today=todayStr();
  const ds=STATE.selectedMealDate||today;
  const day=getMealDay(ds);
  const selDate=new Date(ds+'T12:00:00');
  const isToday=ds===today;
  const titleStr=selDate.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'});

  // Check for any recipe entries to enable shop button
  const hasRecipes=MEAL_SLOTS.some(s=>(day[s]||[]).some(e=>e.type==='recipe'));

  const prevDs=dateStr(addDays(selDate,-1));
  const nextDs=dateStr(addDays(selDate,1));

  const slotsHtml=MEAL_SLOTS.map(slot=>{
    const entries=day[slot]||[];
    return `<div class="meal-slot">
      <div class="meal-slot-header">
        <span class="meal-slot-name">${MEAL_SLOT_LABELS[slot]}</span>
        <div class="meal-slot-add" onclick="openMealPicker('${ds}','${slot}')">Ôºã</div>
      </div>
      ${entries.map((e,idx)=>`
        <div class="meal-entry">
          <div class="meal-entry-emoji">${entryEmoji(e)}</div>
          <div class="meal-entry-name">${escHtml(e.name)}</div>
          <button class="meal-entry-del" onclick="removeMealEntry('${ds}','${slot}',${idx})">‚úï</button>
        </div>`).join('')||`<div class="meal-empty-slot">Nothing planned yet</div>`}
    </div>`;
  }).join('');

  return `<div class="meal-day-header">
    <button class="meal-day-nav" onclick="selectMealDate('${prevDs}')">‚Äπ</button>
    <div style="text-align:center;flex:1;">
      <div class="meal-day-title">${titleStr}</div>
      ${isToday?'<span class="meal-today-chip">Today</span>':''}
    </div>
    <button class="meal-day-nav" onclick="selectMealDate('${nextDs}')">‚Ä∫</button>
  </div>
  ${hasRecipes?`<div style="margin-bottom:12px;"><button class="meal-shop-btn" style="width:100%;" onclick="addMealDayToShop('${ds}')">üõí Mark missing ingredients as Out</button></div>`:''}
  <div class="meal-day-view">${slotsHtml}</div>`;
}

// ‚îÄ‚îÄ WEEK VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWeekView(){
  const today=new Date(); today.setHours(0,0,0,0);
  const baseMonday=getMonday(today);
  const monday=addDays(baseMonday, STATE.mealWeekOffset*7);
  const days=Array.from({length:7},(_,i)=>addDays(monday,i));
  const dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const weekTitle=`${monday.toLocaleDateString(undefined,{month:'short',day:'numeric'})} ‚Äì ${addDays(monday,6).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;

  const cells=days.map((d,i)=>{
    const ds=dateStr(d);
    const isToday=dateStr(d)===dateStr(today);
    const day=getMealDay(ds);
    const allEntries=MEAL_SLOTS.flatMap(s=>(day[s]||[]).slice(0,2));
    const extra=MEAL_SLOTS.reduce((n,s)=>n+(day[s]||[]).length,0)-allEntries.length;
    return `<div class="week-cell ${isToday?'today':''}" onclick="selectMealDate('${ds}');setMealView('day')">
      <div class="wc-num">${d.getDate()}</div>
      ${allEntries.map(e=>`<span class="wc-label">${entryEmoji(e)} ${escHtml(e.name)}</span>`).join('')}
      ${extra>0?`<span class="wc-label" style="color:var(--meal-accent);">+${extra} more</span>`:''}
    </div>`;
  }).join('');

  return `<div class="week-nav">
    <div class="week-nav-title">${weekTitle}</div>
    <div class="week-nav-btns">
      <button class="week-nav-btn" onclick="STATE.mealWeekOffset--;renderMealTab()">‚Äπ</button>
      <button class="week-nav-btn" onclick="STATE.mealWeekOffset=0;renderMealTab()">Today</button>
      <button class="week-nav-btn" onclick="STATE.mealWeekOffset++;renderMealTab()">‚Ä∫</button>
    </div>
  </div>
  <div class="week-grid">
    <div class="week-grid-header">${dayNames.map(n=>`<div class="week-grid-dayname">${n}</div>`).join('')}</div>
    <div class="week-row">${cells}</div>
  </div>
  <div style="margin-top:10px;text-align:center;font-size:0.8rem;color:var(--text2);">Tap any day to see full details</div>`;
}

// ‚îÄ‚îÄ MONTH VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMonthView(){
  const today=new Date(); today.setHours(0,0,0,0);
  const ref=new Date(today.getFullYear(), today.getMonth()+STATE.mealMonthOffset, 1);
  const year=ref.getFullYear(), month=ref.getMonth();
  const monthTitle=ref.toLocaleDateString(undefined,{month:'long',year:'numeric'});

  // Grid starts on Monday
  const firstDay=new Date(year,month,1);
  const startOffset=(firstDay.getDay()===0?6:firstDay.getDay()-1);
  const gridStart=addDays(firstDay,-startOffset);
  const daysInMonth=new Date(year,month+1,0).getDate();
  const totalCells=Math.ceil((startOffset+daysInMonth)/7)*7;

  const dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  let rows='', cells='';
  for(let i=0;i<totalCells;i++){
    const d=addDays(gridStart,i);
    const ds=dateStr(d);
    const isToday=ds===dateStr(today);
    const isOther=d.getMonth()!==month;
    const cnt=mealEntryCount(ds);
    const day=getMealDay(ds);
    const firstEntry=MEAL_SLOTS.map(s=>(day[s]||[])[0]).find(Boolean);
    cells+=`<div class="month-cell ${isToday?'today':''} ${isOther?'other-month':''}" onclick="selectMealDate('${ds}');setMealView('day')">
      <div class="mc-num">${d.getDate()}</div>
      ${cnt>0?`<div class="mc-dots">${Array.from({length:Math.min(cnt,4)},()=>'<div class="mc-dot"></div>').join('')}</div>`:''}
      ${firstEntry?`<div class="mc-preview">${entryEmoji(firstEntry)} ${escHtml(firstEntry.name)}</div>`:''}
    </div>`;
    if((i+1)%7===0){ rows+=`<div class="month-row">${cells}</div>`; cells=''; }
  }

  return `<div class="month-nav">
    <div class="month-nav-title">${monthTitle}</div>
    <div style="display:flex;gap:6px;align-items:center;">
      <div class="month-nav-btns">
        <button class="month-nav-btn" onclick="STATE.mealMonthOffset--;renderMealTab()">‚Äπ</button>
        <button class="month-nav-btn" onclick="STATE.mealMonthOffset=0;renderMealTab()">This Month</button>
        <button class="month-nav-btn" onclick="STATE.mealMonthOffset++;renderMealTab()">‚Ä∫</button>
      </div>
      <button class="month-template-btn" onclick="openApplyTemplatePicker()">üìã Apply Template</button>
    </div>
  </div>
  <div class="month-grid">
    <div class="month-grid-header">${dayNames.map(n=>`<div class="month-grid-dayname">${n}</div>`).join('')}</div>
    ${rows}
  </div>
  <div style="margin-top:10px;text-align:center;font-size:0.8rem;color:var(--text2);">Tap any day to edit ¬∑ Blue dots = meals planned</div>`;
}

// ‚îÄ‚îÄ TEMPLATES VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTemplatesView(){
  const templates=STATE.mealTemplates;
  const intro=`<div style="background:var(--meal-light);border-radius:var(--radius);padding:14px 16px;margin-bottom:14px;font-size:0.85rem;color:var(--meal-accent);">
    <strong>Weekly templates</strong> let you plan a whole week of meals at once, then apply them to fill your month. Great for school weeks, seasonal rotations, or any recurring schedule.
  </div>`;
  const newBtn=`<button onclick="openTemplateEdit(null)" style="width:100%;padding:14px;background:var(--meal-accent);color:#fff;border:none;border-radius:var(--radius);font-family:'Fraunces',serif;font-size:1rem;font-weight:700;cursor:pointer;margin-bottom:14px;">Ôºã New Template</button>`;

  if(!templates.length) return intro+newBtn+`<div style="text-align:center;padding:30px;color:var(--text2);font-size:0.88rem;">No templates yet. Create one above!</div>`;

  const cards=templates.map(t=>{
    const dayPreviews=TEMPLATE_DAYS.map(dow=>{
      const entries=(t.days||{})[dow]||[];
      const chips=entries.slice(0,2).map(e=>`<span class="template-meal-chip">${entryEmoji(e)} ${escHtml(e.name)}</span>`).join('');
      const extra=entries.length>2?`<span class="template-meal-chip" style="background:var(--border);">+${entries.length-2}</span>`:'';
      return `<div class="template-day"><div class="template-day-name">${TEMPLATE_DAY_LABELS[dow]}</div>${chips}${extra}</div>`;
    }).join('');
    return `<div class="template-card">
      <div class="template-card-top">
        <div class="template-name">${escHtml(t.name)}</div>
        <div class="template-actions">
          <button class="template-btn" onclick="openApplyTemplate('${t.id}')">‚ñ∂ Apply</button>
          <button class="template-btn" onclick="openTemplateEdit('${t.id}')">‚úèÔ∏è Edit</button>
        </div>
      </div>
      <div class="template-week-grid">${dayPreviews}</div>
    </div>`;
  }).join('');

  return intro+newBtn+cards;
}

// ‚îÄ‚îÄ MEAL PICKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _mealPickerTab='recipes';
let _templatePickerCtx=null; // {templateId, dow, slotIdx} when picking for a template

function openMealPicker(ds, slot, templateCtx=null){
  if(templateCtx){ _templatePickerCtx=templateCtx; STATE.mealPickerSlot=null; }
  else { STATE.mealPickerSlot={ds,slot}; _templatePickerCtx=null; }
  _mealPickerTab='recipes';
  const label=templateCtx
    ? `Add to ${TEMPLATE_DAY_LABELS[templateCtx.dow]} template`
    : `${MEAL_SLOT_LABELS[slot]} ‚Äî ${new Date(ds+'T12:00:00').toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})}`;
  document.getElementById('meal-picker-title').textContent=label;
  document.getElementById('meal-picker-search').value='';
  document.getElementById('mpt-recipes').classList.add('active');
  document.getElementById('mpt-items').classList.remove('active');
  renderMealPickerList('');
  openModal('meal-picker-overlay');
  setTimeout(()=>document.getElementById('meal-picker-search').focus(),300);
}

function switchMealPickerTab(tab){
  _mealPickerTab=tab;
  document.getElementById('mpt-recipes').classList.toggle('active',tab==='recipes');
  document.getElementById('mpt-items').classList.toggle('active',tab==='items');
  renderMealPickerList(document.getElementById('meal-picker-search').value);
}

function renderMealPickerList(filter){
  filter=(filter||'').toLowerCase();
  const list=document.getElementById('meal-picker-list');
  if(_mealPickerTab==='recipes'){
    const results=STATE.recipes.filter(r=>r.name.toLowerCase().includes(filter)||(r.description||'').toLowerCase().includes(filter));
    if(!results.length){ list.innerHTML=`<div style="text-align:center;color:var(--text2);padding:20px;font-size:0.88rem;">${filter?'No recipes match.':'No recipes yet ‚Äî add some in the Cook tab!'}</div>`; return; }
    list.innerHTML=results.map(r=>`
      <div class="meal-picker-item" onclick="addMealEntry('recipe','${r.id}','${escHtml(r.name)}','${escHtml(r.emoji||'üçΩÔ∏è')}')">
        <div class="meal-picker-item-emoji">${escHtml(r.emoji||'üçΩÔ∏è')}</div>
        <div style="flex:1;">
          <div class="meal-picker-item-name">${escHtml(r.name)}</div>
          <div class="meal-picker-item-meta">${(r.ingredients||[]).length} ingredients${r.cookTime?' ¬∑ '+r.cookTime:''}</div>
        </div>
      </div>`).join('');
  } else {
    const results=STATE.items.filter(i=>i.name.toLowerCase().includes(filter)).sort((a,b)=>a.name.localeCompare(b.name));
    if(!results.length){ list.innerHTML=`<div style="text-align:center;color:var(--text2);padding:20px;font-size:0.88rem;">No items match.</div>`; return; }
    list.innerHTML=results.map(i=>`
      <div class="meal-picker-item" onclick="addMealEntry('item','${i.id}','${escHtml(i.name)}','')">
        <div class="meal-picker-item-emoji">${catEmoji(i.category)}</div>
        <div style="flex:1;">
          <div class="meal-picker-item-name">${escHtml(i.name)}</div>
          <div class="meal-picker-item-meta">${escHtml(i.category)} ¬∑ ${i.status}</div>
        </div>
      </div>`).join('');
  }
}

async function addMealEntry(type, id, name, emoji){
  closeModal('meal-picker-overlay');
  if(_templatePickerCtx){
    // Adding to a template day
    const {templateId, dow}=_templatePickerCtx;
    const t=STATE.mealTemplates.find(t=>t.id===templateId);
    if(!t) return;
    const days={...t.days};
    days[dow]=[...(days[dow]||[]),{type,id,name,emoji}];
    await saveRecord('mealTemplates',{...t,days});
    renderTemplateDayEditor(templateId);
  } else {
    const {ds, slot}=STATE.mealPickerSlot;
    const day=getMealDay(ds);
    const slotArr=[...(day[slot]||[]),{type,id,name,emoji}];
    await set(ref(db,`families/${STATE.familyCode}/mealPlan/${ds}`),{...day,[slot]:slotArr});
  }
}

async function removeMealEntry(ds, slot, idx){
  const day=getMealDay(ds);
  const slotArr=[...(day[slot]||[])];
  slotArr.splice(idx,1);
  await set(ref(db,`families/${STATE.familyCode}/mealPlan/${ds}`),{...day,[slot]:slotArr});
}

// ‚îÄ‚îÄ SHOPPING FROM MEAL PLAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addMealDayToShop(ds){
  const day=getMealDay(ds);
  const entries=MEAL_SLOTS.flatMap(s=>(day[s]||[]).filter(e=>e.type==='recipe'));
  let added=0;
  for(const entry of entries){
    const recipe=STATE.recipes.find(r=>r.id===entry.id);
    if(!recipe) continue;
    for(const ing of (recipe.ingredients||[])){
      const pantryItem=STATE.items.find(i=>i.name.toLowerCase()===ing.name.toLowerCase());
      if(pantryItem&&pantryItem.status==='full'){
        await saveRecord('items',{...pantryItem,status:'out',updated:Date.now()});
        added++;
      } else if(!pantryItem){
        await saveRecord('items',{id:uid(),name:ing.name,category:'Other',status:'out',estimatedPrice:null,updated:Date.now()});
        added++;
      }
    }
  }
  if(added>0){ showToast(`‚úÖ ${added} item${added!==1?'s':''} marked as Out`); setMode('shopping'); }
  else showToast('üéâ Everything already stocked!');
}

// ‚îÄ‚îÄ TEMPLATES CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _workingTemplate=null; // {id,name,days:{mon:[],tue:[],...}} during edit

function openTemplateEdit(id){
  STATE.editingTemplateId=id;
  const t=id?STATE.mealTemplates.find(t=>t.id===id):null;
  _workingTemplate=t
    ? {id:t.id,name:t.name,days:JSON.parse(JSON.stringify(t.days||{}))}
    : {id:uid(),name:'',days:{}};
  document.getElementById('template-edit-title').textContent=t?'Edit Template':'New Template';
  document.getElementById('template-name-input').value=_workingTemplate.name;
  document.getElementById('btn-delete-template').style.display=t?'block':'none';
  renderTemplateDaysEditor();
  openModal('template-edit-overlay');
}

function renderTemplateDaysEditor(){
  const ed=document.getElementById('template-days-editor');
  ed.innerHTML=TEMPLATE_DAYS.map(dow=>{
    const entries=(_workingTemplate.days[dow]||[]);
    return `<div style="margin-bottom:12px;">
      <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--meal-accent);margin-bottom:5px;">${TEMPLATE_DAY_LABELS[dow]}</div>
      <div id="tpl-day-${dow}">
        ${entries.map((e,idx)=>`
          <div class="meal-entry" style="margin-bottom:4px;">
            <div class="meal-entry-emoji">${entryEmoji(e)}</div>
            <div class="meal-entry-name">${escHtml(e.name)}</div>
            <button class="meal-entry-del" onclick="removeTemplateEntry('${dow}',${idx})">‚úï</button>
          </div>`).join('')}
      </div>
      <button onclick="openMealPicker(null,null,{templateId:'${_workingTemplate.id}',dow:'${dow}'})"
        style="width:100%;padding:7px;background:var(--meal-light);color:var(--meal-accent);border:1.5px dashed var(--meal-accent);border-radius:8px;font-size:0.8rem;cursor:pointer;font-weight:600;">Ôºã Add meal</button>
    </div>`;
  }).join('');
}

// Re-render just the day section after adding to a template (without closing modal)
function renderTemplateDayEditor(templateId){
  const t=STATE.mealTemplates.find(t=>t.id===templateId);
  if(!t||!_workingTemplate) return;
  // Sync working copy from Firebase state
  _workingTemplate.days=JSON.parse(JSON.stringify(t.days||{}));
  renderTemplateDaysEditor();
}

function removeTemplateEntry(dow, idx){
  const arr=[...(_workingTemplate.days[dow]||[])];
  arr.splice(idx,1);
  _workingTemplate.days[dow]=arr;
  renderTemplateDaysEditor();
}

async function saveTemplate(){
  const name=document.getElementById('template-name-input').value.trim();
  if(!name){ document.getElementById('template-name-input').focus(); return; }
  _workingTemplate.name=name;
  closeModal('template-edit-overlay');
  await saveRecord('mealTemplates',_workingTemplate);
  showToast(`Template "${name}" saved`);
}

async function deleteTemplate(){
  if(!STATE.editingTemplateId) return;
  if(!confirm('Delete this template?')) return;
  const id=STATE.editingTemplateId;
  closeModal('template-edit-overlay');
  await deleteRecord('mealTemplates',id);
  showToast('Template deleted');
}

// ‚îÄ‚îÄ APPLY TEMPLATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openApplyTemplatePicker(){
  // From month view ‚Äî show template picker then apply modal
  if(!STATE.mealTemplates.length){ showToast('No templates yet ‚Äî create one first!'); return; }
  // Use the first template by default; a proper picker can be a future enhancement
  // For now open apply with first template pre-selected
  openApplyTemplate(STATE.mealTemplates[0].id);
}

function openApplyTemplate(templateId){
  STATE.applyTemplateId=templateId;
  const t=STATE.mealTemplates.find(t=>t.id===templateId);
  if(!t) return;
  document.getElementById('apply-template-sub').textContent=`Apply "${t.name}" template:`;

  // Set week label
  const today=new Date(); today.setHours(0,0,0,0);
  const monday=addDays(getMonday(today),STATE.mealWeekOffset*7);
  const sunday=addDays(monday,6);
  document.getElementById('apply-week-label').textContent=
    `${monday.toLocaleDateString(undefined,{month:'short',day:'numeric'})} ‚Äì ${sunday.toLocaleDateString(undefined,{month:'short',day:'numeric'})}`;

  // Set month label
  const ref=new Date(today.getFullYear(),today.getMonth()+STATE.mealMonthOffset,1);
  document.getElementById('apply-month-label').textContent=
    `Fills all of ${ref.toLocaleDateString(undefined,{month:'long',year:'numeric'})}`;

  openModal('apply-template-overlay');
}

async function confirmApplyTemplate(){
  const scope=document.querySelector('input[name="apply-scope"]:checked')?.value||'week';
  const t=STATE.mealTemplates.find(t=>t.id===STATE.applyTemplateId);
  if(!t) return;
  closeModal('apply-template-overlay');

  const today=new Date(); today.setHours(0,0,0,0);
  let days=[];

  if(scope==='week'){
    const monday=addDays(getMonday(today),STATE.mealWeekOffset*7);
    days=Array.from({length:7},(_,i)=>addDays(monday,i));
  } else {
    // Fill entire month
    const firstOfMonth=new Date(today.getFullYear(),today.getMonth()+STATE.mealMonthOffset,1);
    const daysInMonth=new Date(firstOfMonth.getFullYear(),firstOfMonth.getMonth()+1,0).getDate();
    days=Array.from({length:daysInMonth},(_,i)=>new Date(firstOfMonth.getFullYear(),firstOfMonth.getMonth(),i+1));
  }

  let applied=0;
  for(const d of days){
    const ds=dateStr(d);
    const dow=dowKey(d);
    const templateEntries=t.days[dow]||[];
    if(!templateEntries.length) continue;
    const existing=getMealDay(ds);
    const existingCount=MEAL_SLOTS.reduce((n,s)=>n+(existing[s]||[]).length,0);
    if(existingCount>0) continue; // don't overwrite days that already have meals
    const updated={...existing, dinner:[...templateEntries]};
    await set(ref(db,`families/${STATE.familyCode}/mealPlan/${ds}`),updated);
    applied++;
  }

  showToast(`Applied to ${applied} day${applied!==1?'s':''}`);
  renderMealTab();
}

function selectMealDate(ds){ STATE.selectedMealDate=ds; STATE.mealView='day'; renderMealTab(); }
function scrollMealToToday(){ STATE.selectedMealDate=todayStr(); STATE.mealView='day'; renderMealTab(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEEDBACK SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openFeedback(){
  STATE.feedbackStar=0;
  STATE.feedbackFeature=STATE.mode==='admin'?'overall':STATE.mode;
  // Pre-select the current tab's pill
  document.querySelectorAll('.feature-pill').forEach(p=>{
    p.classList.toggle('selected', p.dataset.f===STATE.feedbackFeature);
  });
  updateStarDisplay();
  document.getElementById('feedback-comment-section').style.display='none';
  document.getElementById('feedback-comment-input').value='';
  openModal('feedback-overlay');
}

function selectFeedbackFeature(el){
  STATE.feedbackFeature=el.dataset.f;
  document.querySelectorAll('.feature-pill').forEach(p=>p.classList.toggle('selected',p.dataset.f===STATE.feedbackFeature));
}

function setFeedbackStar(n){
  STATE.feedbackStar=n;
  updateStarDisplay();
  document.getElementById('feedback-comment-section').style.display='block';
}

function updateStarDisplay(){
  document.querySelectorAll('.star-btn').forEach(b=>{
    b.classList.toggle('lit', parseInt(b.dataset.v)<=STATE.feedbackStar);
  });
}

async function submitFeedback(){
  if(!STATE.feedbackStar){ alert('Please choose a star rating first!'); return; }
  const comment=document.getElementById('feedback-comment-input').value.trim();
  const entry={
    id: uid(),
    feature: STATE.feedbackFeature,
    stars: STATE.feedbackStar,
    comment,
    familyCode: STATE.familyCode||'anonymous',
    ts: Date.now(),
  };
  try{
    await set(ref(db,`feedback/${entry.id}`),entry);
    closeModal('feedback-overlay');
    // Little thank-you toast
    showToast('Thank you for your feedback! ‚òÖ');
  }catch(e){
    alert('Could not submit feedback. Please try again.');
  }
}

function showToast(msg){
  let t=document.getElementById('toast');
  if(!t){
    t=document.createElement('div');
    t.id='toast';
    t.style.cssText='position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:50px;font-size:0.85rem;z-index:999;opacity:0;transition:opacity 0.3s;pointer-events:none;white-space:nowrap;';
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.opacity='1';
  setTimeout(()=>t.style.opacity='0',2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAdminData(){
  try{
    const snap=await get(ref(db,'feedback'));
    STATE.adminFeedback=snap.exists()?Object.values(snap.val()):[];
  }catch(e){ STATE.adminFeedback=[]; }
}

function getFilteredFeedback(){
  const f=STATE.adminFilter;
  return STATE.adminFeedback.filter(item=>{
    if(item.stars < f.minStars || item.stars > f.maxStars) return false;
    if(f.feature !== 'all' && item.feature !== f.feature) return false;
    if(f.hasComment && !item.comment) return false;
    if(f.dateFrom){
      const from=new Date(f.dateFrom).setHours(0,0,0,0);
      if(item.ts < from) return false;
    }
    if(f.dateTo){
      const to=new Date(f.dateTo).setHours(23,59,59,999);
      if(item.ts > to) return false;
    }
    return true;
  });
}

function renderAdminTab(){
  document.getElementById('stats-bar').style.display='none';
  document.getElementById('filter-bar').innerHTML='';
  document.getElementById('btn-feedback-fab').style.display='none';
  const container=document.getElementById('items-container');

  if(!STATE.adminFeedback.length){
    container.innerHTML=`<div style="text-align:center;padding:40px 20px;">
      <div style="font-size:3rem;margin-bottom:12px;">üì≠</div>
      <div style="font-family:'Fraunces',serif;font-size:1.4rem;color:#e0e0ff;margin-bottom:8px;">No feedback yet</div>
      <div style="color:#888;font-size:0.88rem;">Feedback from users will appear here.</div>
      <button onclick="refreshAdminData()" style="margin-top:16px;background:#1e1e3f;color:#7b8cde;border:1.5px solid #3a3a6a;border-radius:50px;padding:10px 20px;cursor:pointer;font-size:0.85rem;">‚Üª Refresh</button>
    </div>`;
    return;
  }

  const features=['all','pantry','shopping','stores','history','cook','meal','overall'];
  const featureLabels={all:'All Features',pantry:'üè† Pantry',shopping:'üõí Shopping',stores:'üè™ Stores',history:'üìã History',cook:'üë®‚Äçüç≥ Cook',meal:'üìÖ Meal Plan',overall:'‚≠ê Overall'};
  const f=STATE.adminFilter;
  const filtered=getFilteredFeedback();

  // Summary stats on filtered set
  const totalRatings=STATE.adminFeedback.length;
  const filteredCount=filtered.length;
  const avgStars=filteredCount?(filtered.reduce((s,x)=>s+x.stars,0)/filteredCount).toFixed(1):'‚Äî';
  const withComments=filtered.filter(x=>x.comment).length;

  // Export bar
  const exportBar=`<div class="admin-export-bar">
    <button class="admin-export-btn" onclick="copyAllFeedback()">üìã Copy All</button>
    <button class="admin-export-btn" onclick="exportFeedbackCSV()">‚¨á Export CSV</button>
    <button class="admin-export-btn" onclick="refreshAdminData()">‚Üª Refresh</button>
  </div>`;

  // Filters
  const filterBar=`<div class="admin-filters">
    <div class="admin-filter-group">
      <div class="admin-filter-label">Feature</div>
      <select class="admin-filter-select" onchange="STATE.adminFilter.feature=this.value;renderAdminTab()">
        ${features.map(ff=>`<option value="${ff}" ${f.feature===ff?'selected':''}>${featureLabels[ff]}</option>`).join('')}
      </select>
    </div>
    <div class="admin-filter-group" style="min-width:80px;max-width:90px;">
      <div class="admin-filter-label">Min ‚òÖ</div>
      <select class="admin-filter-select" onchange="STATE.adminFilter.minStars=+this.value;renderAdminTab()">
        ${[0,1,2,3,4,5].map(n=>`<option value="${n}" ${f.minStars===n?'selected':''}>${n===0?'Any':n+'+'}</option>`).join('')}
      </select>
    </div>
    <div class="admin-filter-group" style="min-width:80px;max-width:90px;">
      <div class="admin-filter-label">Max ‚òÖ</div>
      <select class="admin-filter-select" onchange="STATE.adminFilter.maxStars=+this.value;renderAdminTab()">
        ${[5,4,3,2,1].map(n=>`<option value="${n}" ${f.maxStars===n?'selected':''}>${n}‚òÖ</option>`).join('')}
      </select>
    </div>
    <div class="admin-filter-group">
      <div class="admin-filter-label">From date</div>
      <input type="date" class="admin-filter-input" value="${f.dateFrom}" onchange="STATE.adminFilter.dateFrom=this.value;renderAdminTab()" />
    </div>
    <div class="admin-filter-group">
      <div class="admin-filter-label">To date</div>
      <input type="date" class="admin-filter-input" value="${f.dateTo}" onchange="STATE.adminFilter.dateTo=this.value;renderAdminTab()" />
    </div>
    <div class="admin-filter-group" style="min-width:100px;">
      <div class="admin-filter-label">Has comment</div>
      <select class="admin-filter-select" onchange="STATE.adminFilter.hasComment=this.value==='yes';renderAdminTab()">
        <option value="no" ${!f.hasComment?'selected':''}>All</option>
        <option value="yes" ${f.hasComment?'selected':''}>With comment</option>
      </select>
    </div>
    ${(f.minStars>0||f.maxStars<5||f.feature!=='all'||f.dateFrom||f.dateTo||f.hasComment)?
      `<button onclick="STATE.adminFilter={minStars:0,maxStars:5,feature:'all',dateFrom:'',dateTo:'',hasComment:false};renderAdminTab()" style="align-self:flex-end;background:#3a3a6a;color:#ccc;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:0.8rem;">‚úï Clear filters</button>`:''}
  </div>`;

  // Overview
  const overview=`<div class="admin-section">
    <h3>Overview${filteredCount<totalRatings?` ‚Äî showing ${filteredCount} of ${totalRatings}`:` ‚Äî ${totalRatings} total`}</h3>
    <div class="admin-stat"><span class="admin-stat-label">Ratings shown</span><span class="admin-stat-val">${filteredCount}</span></div>
    <div class="admin-stat"><span class="admin-stat-label">Average score</span><span class="admin-stat-val">‚òÖ ${avgStars}</span></div>
    <div class="admin-stat"><span class="admin-stat-label">With comments</span><span class="admin-stat-val">${withComments}</span></div>
  </div>`;

  // Per-feature sections (respecting filter)
  const activeFeaturesInFilter = f.feature==='all'
    ? ['pantry','shopping','stores','history','cook','meal','overall']
    : [f.feature];

  const sections=activeFeaturesInFilter.map(feat=>{
    const items=filtered.filter(x=>x.feature===feat).sort((a,b)=>b.ts-a.ts);
    if(!items.length) return '';
    const avg=(items.reduce((s,x)=>s+x.stars,0)/items.length).toFixed(1);
    return `<div class="admin-section">
      <h3>${featureLabels[feat]||feat} ‚Äî avg ‚òÖ${avg} (${items.length} rating${items.length!==1?'s':''})</h3>
      ${items.map(item=>`
        <div class="feedback-card">
          <div class="feedback-stars">${'‚òÖ'.repeat(item.stars)}${'‚òÜ'.repeat(5-item.stars)}</div>
          ${item.comment?`<div class="feedback-comment">"${escHtml(item.comment)}"</div>`:''}
          <div class="feedback-meta">${escHtml(item.familyCode||'anon')} ¬∑ ${new Date(item.ts).toLocaleDateString('en-IE')}</div>
        </div>`).join('')}
    </div>`;
  }).join('');

  container.innerHTML=exportBar+filterBar+overview+(sections||`<div style="text-align:center;padding:20px;color:#666;font-size:0.88rem;">No feedback matches your filters.</div>`);
}

function copyAllFeedback(){
  const filtered=getFilteredFeedback().sort((a,b)=>b.ts-a.ts);
  const featureLabels={pantry:'Pantry',shopping:'Shopping',stores:'Stores',history:'History',cook:'Cook',meal:'Meal Plan',overall:'Overall'};
  const text=filtered.map(item=>
    `${'‚òÖ'.repeat(item.stars)}${'‚òÜ'.repeat(5-item.stars)} [${featureLabels[item.feature]||item.feature}]\n`+
    (item.comment?`"${item.comment}"\n`:'')+
    `${item.familyCode||'anon'} ¬∑ ${new Date(item.ts).toLocaleDateString('en-IE')}`
  ).join('\n\n');
  navigator.clipboard.writeText(text).then(()=>showToast(`Copied ${filtered.length} feedback item${filtered.length!==1?'s':''}!`)).catch(()=>{
    // Fallback ‚Äî create a textarea
    const ta=document.createElement('textarea');
    ta.value=text; ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast(`Copied ${filtered.length} items!`);
  });
}

function exportFeedbackCSV(){
  const filtered=getFilteredFeedback().sort((a,b)=>b.ts-a.ts);
  const rows=[['Stars','Feature','Comment','Family Code','Date']];
  filtered.forEach(item=>rows.push([
    item.stars,
    item.feature,
    (item.comment||'').replace(/"/g,'""'),
    item.familyCode||'anon',
    new Date(item.ts).toLocaleDateString('en-IE')
  ]));
  const csv=rows.map(r=>r.map(cell=>`"${cell}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`our-kitchen-feedback-${todayStr()}.csv`;
  a.click(); URL.revokeObjectURL(url);
  showToast('CSV downloaded!');
}

async function refreshAdminData(){
  await loadAdminData();
  renderAdminTab();
  showToast('Feedback refreshed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){
  if(id==='store-pick-overlay'){
    document.getElementById('store-search-input').value='';
    renderStorePickList('');
  }
  document.getElementById(id).classList.add('open');
  document.body.style.overflow='hidden';
}
function closeModal(id){
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow='';
}
function handleOverlayClick(e,id){
  if(e.target===document.getElementById(id)) closeModal(id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BIND ALL EVENTS ‚Äî called once DOM is ready, after module loads
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindEvents(){
  // Onboarding
  document.getElementById('btn-finish-onboard').addEventListener('click', finishOnboard);
  document.getElementById('btn-join-family').addEventListener('click', joinFamily);
  document.getElementById('join-code-input').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());

  // Header
  document.getElementById('family-badge-btn').addEventListener('click', () => { renderFamilyModal(); openModal('family-overlay'); });

  // Bottom nav tabs
  document.getElementById('tab-pantry').addEventListener('click',   () => setMode('pantry'));
  document.getElementById('tab-shopping').addEventListener('click', () => setMode('shopping'));
  document.getElementById('tab-cook').addEventListener('click',     () => setMode('cook'));
  document.getElementById('tab-meal').addEventListener('click',     () => setMode('meal'));
  document.getElementById('tab-more').addEventListener('click',     () => openMoreDrawer());
  document.getElementById('main-add-btn').addEventListener('click', handleMainAdd);

  // More drawer
  document.getElementById('more-drawer-backdrop').addEventListener('click', closeMoreDrawer);
  document.getElementById('drawer-stores').addEventListener('click',  () => { closeMoreDrawer(); setMode('stores'); });
  document.getElementById('drawer-history').addEventListener('click', () => { closeMoreDrawer(); setMode('history'); });
  document.getElementById('drawer-install').addEventListener('click', () => { closeMoreDrawer(); openInstallModal(); });
  document.getElementById('drawer-family').addEventListener('click',  () => { closeMoreDrawer(); renderFamilyModal(); openModal('family-overlay'); });
  document.getElementById('store-selector-bar').addEventListener('click', () => openModal('store-pick-overlay'));
  document.getElementById('btn-log-shop').addEventListener('click', openLogShop);

  // Add/Edit item modal
  document.getElementById('btn-cancel-add').addEventListener('click', () => closeModal('add-overlay'));
  document.getElementById('save-btn').addEventListener('click', saveItem);
  document.querySelectorAll('.status-option').forEach(el =>
    el.addEventListener('click', () => selectStatus(el.dataset.val))
  );

  // Item detail modal
  document.getElementById('action-out').addEventListener('click',  () => updateStatus('out'));
  document.getElementById('action-low').addEventListener('click',  () => updateStatus('low'));
  document.getElementById('action-full').addEventListener('click', () => updateStatus('full'));
  document.getElementById('btn-edit-item').addEventListener('click',   openEditFromDetail);
  document.getElementById('btn-delete-item').addEventListener('click', deleteItem);

  // Family modal ‚Äî buttons rendered dynamically via renderFamilyModal()

  // Store picker modal
  document.getElementById('btn-cancel-store-pick').addEventListener('click', () => closeModal('store-pick-overlay'));
  document.getElementById('btn-add-store-from-pick').addEventListener('click', () => { closeModal('store-pick-overlay'); openModal('add-store-overlay'); });

  // Add store modal
  document.getElementById('btn-cancel-store').addEventListener('click', () => closeModal('add-store-overlay'));
  document.getElementById('btn-save-store').addEventListener('click', saveStore);
  document.getElementById('btn-delete-store').addEventListener('click', deleteStore);

  // Store search
  document.getElementById('store-search-input').addEventListener('input', e => renderStorePickList(e.target.value));

  // Log shop modal
  document.getElementById('btn-cancel-log').addEventListener('click', () => closeModal('log-shop-overlay'));
  document.getElementById('btn-save-log').addEventListener('click', saveShopLog);
  document.getElementById('log-total-override').addEventListener('input', recalcLogTotal);

  document.getElementById('btn-add-cat').addEventListener('click', addNewCategory);

  // Meal picker modal
  document.getElementById('btn-cancel-meal-picker').addEventListener('click', () => closeModal('meal-picker-overlay'));
  document.getElementById('meal-picker-search').addEventListener('input', e => renderMealPickerList(e.target.value));

  // Template edit modal
  document.getElementById('btn-cancel-template').addEventListener('click', () => closeModal('template-edit-overlay'));
  document.getElementById('btn-save-template').addEventListener('click', saveTemplate);
  document.getElementById('btn-delete-template').addEventListener('click', deleteTemplate);

  // Apply template modal
  document.getElementById('btn-cancel-apply-template').addEventListener('click', () => closeModal('apply-template-overlay'));
  document.getElementById('btn-confirm-apply-template').addEventListener('click', confirmApplyTemplate);

  // Feedback
  document.getElementById('btn-feedback-fab').addEventListener('click', openFeedback);
  document.getElementById('btn-cancel-feedback').addEventListener('click', () => closeModal('feedback-overlay'));
  document.getElementById('btn-submit-feedback').addEventListener('click', submitFeedback);
  document.getElementById('btn-exit-focus').addEventListener('click', exitFocusMode);
  document.getElementById('btn-focus-next').addEventListener('click', advanceFocusStep);
  document.getElementById('btn-toggle-ingredients').addEventListener('click', toggleFocusIngredients);
  document.getElementById('btn-cancel-recipe').addEventListener('click', () => {
    const hasName = document.getElementById('recipe-name-input').value.trim();
    const hasIngredients = _recipeIngredients.length > 0;
    const hasSteps = _recipeSteps.length > 0;
    if(hasName || hasIngredients || hasSteps){
      if(!confirm('Discard this recipe? All unsaved changes will be lost.')) return;
    }
    STATE.editingRecipeId = null;
    closeModal('recipe-edit-overlay');
  });
  document.getElementById('btn-save-recipe').addEventListener('click', saveRecipe);
  document.getElementById('btn-delete-recipe').addEventListener('click', deleteRecipe);
  document.getElementById('btn-add-ingredient').addEventListener('click', addRecipeIngredient);
  document.getElementById('recipe-ing-qty-input').addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); addRecipeIngredient(); }});
  document.getElementById('btn-add-custom-ingredient').addEventListener('click', addCustomIngredient);
  document.getElementById('recipe-ing-custom-name').addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); addCustomIngredient(); }});
  document.getElementById('btn-add-step').addEventListener('click', addRecipeStep);
  document.getElementById('recipe-step-input').addEventListener('keydown', e => { if(e.key==='Enter' && e.ctrlKey){ e.preventDefault(); addRecipeStep(); }});
  // NOTE: No backdrop-click-to-close on recipe modal ‚Äî too easy to lose work
  // NOTE: No backdrop-click-to-close on template-edit-overlay ‚Äî same reason

  // ‚îÄ‚îÄ Unified backdrop-click-to-close for all other overlays ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Any tap on the dark backdrop (i.e. the overlay element itself, not the modal
  // inside it) dismisses the sheet. recipe-edit and template-edit are excluded
  // because they hold unsaved work that would be lost silently.
  [
    'add-overlay',
    'detail-overlay',
    'family-overlay',
    'store-pick-overlay',
    'add-store-overlay',
    'log-shop-overlay',
    'meal-picker-overlay',
    'apply-template-overlay',
    'feedback-overlay',
    'pwa-install-overlay',
    'shop-detail-overlay',
  ].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('click', e => {
      if(e.target === el) closeModal(id);
    });
  });

  // Expose functions used in dynamically-rendered innerHTML onclick attributes
  window.openDetail              = openDetail;
  window.openStoreDetail         = openStoreDetail;
  window.selectStore             = selectStore;
  window.toggleShopCard          = toggleShopCard;
  window.confirmDeleteShop       = confirmDeleteShop;
  window.toggleLogItem           = toggleLogItem;
  window.toggleFilter            = toggleFilter;
  window.toggleShopFilter        = toggleShopFilter;
  window.deleteCategory          = deleteCategory;
  window.openAddModalForCategory = openAddModalForCategory;
  window.openRecipeDetail        = openRecipeDetail;
  window.openRecipeEdit          = openRecipeEdit;
  window.startFocusMode          = startFocusMode;
  window.toggleFocusGrab         = toggleFocusGrab;
  window.removeRecipeIngredient  = removeRecipeIngredient;
  window.removeRecipeStep        = removeRecipeStep;
  window.startEditStep           = startEditStep;
  window.saveEditStep            = saveEditStep;
  window.cancelEditStep          = cancelEditStep;
  window.moveStep                = moveStep;
  window.renderCookTab           = renderCookTab;
  window.toggleSkipItem          = toggleSkipItem;
  window.clearSkipped            = clearSkipped;
  window.switchIngTab            = switchIngTab;
  // Meal plan
  window.selectMealDate          = selectMealDate;
  window.setMealView             = setMealView;
  window.openMealPicker          = openMealPicker;
  window.switchMealPickerTab     = switchMealPickerTab;
  window.addMealEntry            = addMealEntry;
  window.removeMealEntry         = removeMealEntry;
  window.addMealDayToShop        = addMealDayToShop;
  window.openTemplateEdit        = openTemplateEdit;
  window.removeTemplateEntry     = removeTemplateEntry;
  window.openApplyTemplate       = openApplyTemplate;
  window.openApplyTemplatePicker = openApplyTemplatePicker;
  // Feedback
  window.selectFeedbackFeature   = selectFeedbackFeature;
  window.setFeedbackStar         = setFeedbackStar;
  // Admin
  window.refreshAdminData        = refreshAdminData;
  window.copyAllFeedback         = copyAllFeedback;
  window.exportFeedbackCSV       = exportFeedbackCSV;
  window.STATE                   = STATE;
  window.quickSwitchFamily       = quickSwitchFamily;
  window.startNicknameEdit       = startNicknameEdit;
  window.saveNickname            = saveNickname;
  window.cancelNicknameEdit      = cancelNicknameEdit;
  window.confirmRemoveFamily     = confirmRemoveFamily;
  window.renderFamilyModal       = renderFamilyModal;
  window.copyFamilyCode          = copyFamilyCode;
  window.switchFamily            = switchFamily;
  window.openMoreDrawer          = openMoreDrawer;
  window.closeMoreDrawer         = closeMoreDrawer;
  window.renderFilterBar         = renderFilterBar;
  window.renderHistoryTab        = renderHistoryTab;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA INSTALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function detectPlatform(){
  const ua = navigator.userAgent;
  const isIOS     = /iphone|ipad|ipod/i.test(ua);
  const isAndroid = /android/i.test(ua);
  const isSamsungBrowser = /samsungbrowser/i.test(ua);
  const isFirefox = /firefox/i.test(ua);
  const isChrome  = /chrome/i.test(ua) && !/edg/i.test(ua);
  const isEdge    = /edg\//i.test(ua);
  const isSafari  = /safari/i.test(ua) && !isChrome && !isEdge && !isFirefox;
  const isMac     = /macintosh/i.test(ua) && !isIOS;
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  return { isIOS, isAndroid, isChrome, isEdge, isSafari, isFirefox, isSamsungBrowser, isMac, isStandalone };
}

function getPWAInstructions(p){
  if(p.isStandalone){
    return {
      installed: true,
      html: `<div style="text-align:center;padding:10px 0;">
        <div style="font-size:3rem;margin-bottom:10px;">‚úÖ</div>
        <div style="font-weight:600;margin-bottom:6px;">Already installed!</div>
        <div style="font-size:0.85rem;color:var(--text2);">Our Kitchen is running as an installed app.</div>
      </div>`
    };
  }

  if(p.isIOS && p.isSafari){
    return { native: false, html: `
      <div style="font-size:0.88rem;color:var(--text2);margin-bottom:14px;">Follow these steps in <strong>Safari</strong>:</div>
      <div class="pwa-step"><span class="pwa-step-num">1</span><span>Tap the <strong>Share</strong> button <span style="font-size:1.1rem;">‚éô</span> at the bottom of Safari</span></div>
      <div class="pwa-step"><span class="pwa-step-num">2</span><span>Scroll down and tap <strong>"Add to Home Screen"</strong></span></div>
      <div class="pwa-step"><span class="pwa-step-num">3</span><span>Tap <strong>"Add"</strong> in the top-right corner</span></div>
      <div style="margin-top:14px;padding:10px 12px;background:var(--accent-light);border-radius:10px;font-size:0.8rem;color:var(--accent);">
        üçé This only works in <strong>Safari</strong>. If you're using Chrome or Firefox on iOS, open this page in Safari first.
      </div>`
    };
  }

  if(p.isIOS && !p.isSafari){
    return { native: false, html: `
      <div style="font-size:0.88rem;color:var(--text2);margin-bottom:14px;">You're on iOS but not in Safari.</div>
      <div class="pwa-step"><span class="pwa-step-num">1</span><span>Copy this page's URL</span></div>
      <div class="pwa-step"><span class="pwa-step-num">2</span><span>Open <strong>Safari</strong> and paste the URL</span></div>
      <div class="pwa-step"><span class="pwa-step-num">3</span><span>Tap the <strong>Share ‚éô</strong> button ‚Üí <strong>"Add to Home Screen"</strong></span></div>`
    };
  }

  if(p.isAndroid && (p.isChrome || p.isEdge || p.isSamsungBrowser)){
    // These support beforeinstallprompt ‚Äî show native button if available, otherwise manual
    return { native: true, html: `
      <div style="font-size:0.88rem;color:var(--text2);margin-bottom:14px;">Tap the button below, or do it manually:</div>
      <div class="pwa-step"><span class="pwa-step-num">1</span><span>Tap the <strong>‚ãÆ menu</strong> in the top-right of your browser</span></div>
      <div class="pwa-step"><span class="pwa-step-num">2</span><span>Tap <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong></span></div>
      <div class="pwa-step"><span class="pwa-step-num">3</span><span>Tap <strong>"Add"</strong> to confirm</span></div>`
    };
  }

  if(p.isAndroid && p.isFirefox){
    return { native: false, html: `
      <div style="font-size:0.88rem;color:var(--text2);margin-bottom:14px;">In <strong>Firefox for Android</strong>:</div>
      <div class="pwa-step"><span class="pwa-step-num">1</span><span>Tap the <strong>‚ãÆ menu</strong></span></div>
      <div class="pwa-step"><span class="pwa-step-num">2</span><span>Tap <strong>"Install"</strong></span></div>`
    };
  }

  if(p.isChrome || p.isEdge){
    // Desktop Chrome/Edge
    return { native: true, html: `
      <div style="font-size:0.88rem;color:var(--text2);margin-bottom:14px;">In <strong>${p.isEdge ? 'Edge' : 'Chrome'}</strong> on desktop:</div>
      <div class="pwa-step"><span class="pwa-step-num">1</span><span>Look for the <strong>install icon ‚äï</strong> in the address bar (right side)</span></div>
      <div class="pwa-step"><span class="pwa-step-num">2</span><span>Click it and select <strong>"Install"</strong></span></div>
      <div style="margin-top:10px;font-size:0.8rem;color:var(--text2);">Or use the button below if it appears.</div>`
    };
  }

  if(p.isMac && p.isSafari){
    return { native: false, html: `
      <div style="font-size:0.88rem;color:var(--text2);margin-bottom:14px;">In <strong>Safari on Mac</strong>:</div>
      <div class="pwa-step"><span class="pwa-step-num">1</span><span>Click <strong>File</strong> in the menu bar</span></div>
      <div class="pwa-step"><span class="pwa-step-num">2</span><span>Click <strong>"Add to Dock‚Ä¶"</strong></span></div>
      <div class="pwa-step"><span class="pwa-step-num">3</span><span>Click <strong>"Add"</strong></span></div>`
    };
  }

  // Generic fallback
  return { native: false, html: `
    <div style="font-size:0.88rem;color:var(--text2);margin-bottom:14px;">To add this app to your home screen:</div>
    <div class="pwa-step"><span class="pwa-step-num">1</span><span>Open your browser's <strong>menu</strong></span></div>
    <div class="pwa-step"><span class="pwa-step-num">2</span><span>Look for <strong>"Add to Home Screen"</strong> or <strong>"Install"</strong></span></div>`
  };
}

function openInstallModal(){
  const p = detectPlatform();
  const instructions = getPWAInstructions(p);

  document.getElementById('pwa-install-steps').innerHTML = instructions.html;

  const nativeBtnRow = document.getElementById('pwa-native-btn-row');
  const nativeBtn = document.getElementById('btn-pwa-native-install');

  if(!instructions.installed && instructions.native && _pwaPrompt){
    nativeBtnRow.style.display = 'block';
    nativeBtn.onclick = async () => {
      _pwaPrompt.prompt();
      const result = await _pwaPrompt.userChoice;
      if(result.outcome === 'accepted'){
        _pwaPrompt = null;
        closeModal('pwa-install-overlay');
        showToast('üì≤ Our Kitchen added to your Home Screen!');
      }
    };
  } else {
    nativeBtnRow.style.display = 'none';
  }

  if(instructions.installed){
    document.getElementById('btn-pwa-install').classList.add('installed');
  }

  openModal('pwa-install-overlay');
}
window.openInstallModal = openInstallModal;

function initPWA(){
  // Mark as installed if already running standalone
  const p = detectPlatform();
  if(p.isStandalone){
    _pwaInstalled = true;
    const btn = document.getElementById('btn-pwa-install');
    if(btn) btn.classList.add('installed');
  }

  // Capture the native install prompt when browser offers it
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    _pwaPrompt = e;
  });

  // On successful install
  window.addEventListener('appinstalled', () => {
    _pwaInstalled = true;
    _pwaPrompt = null;
    const btn = document.getElementById('btn-pwa-install');
    if(btn) btn.classList.add('installed');
    showToast('üì≤ Our Kitchen added to your Home Screen!');
  });

  // Wire up the header button ‚Äî always opens the modal
  const btn = document.getElementById('btn-pwa-install');
  if(btn) btn.addEventListener('click', openInstallModal);

  // Wire up close button
  const closeBtn = document.getElementById('btn-close-pwa-modal');
  if(closeBtn) closeBtn.addEventListener('click', () => closeModal('pwa-install-overlay'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
bindEvents();
initPWA();
init();
</script>
</body>
</html>
