<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Math Adventure</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800;900&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Nunito',sans-serif;background:#fdf6ee;min-height:100vh;}
    button{cursor:pointer;font-family:'Nunito',sans-serif;}
    input,textarea{font-family:'Nunito',sans-serif;}
    :root{
      --cream:#fdf6ee;--sun:#FFD166;--coral:#FF6B6B;--mint:#06D6A0;
      --sky:#4ECDC4;--blue:#2D6BE4;--navy:#1a3a6b;--purple:#9B5DE5;
      --peach:#FF9F7F;--text:#2c2c2c;--muted:#8a8a9a;--card:#fffdf9;
    }
    @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pop{0%,100%{transform:scale(1)}50%{transform:scale(1.13)}}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
    @keyframes confettiFall{to{transform:translateY(110vh) rotate(720deg);opacity:0}}
    @keyframes starPop{0%{transform:scale(0) rotate(-30deg);opacity:0}60%{transform:scale(1.35) rotate(5deg)}100%{transform:scale(1) rotate(0);opacity:1}}
    .profile-edit-btn:active{transform:scale(0.97)!important;box-shadow:0 2px 10px rgba(0,0,0,0.1)!important;}
    .profile-edit-btn:hover{transform:translateY(-2px);box-shadow:0 6px 28px rgba(0,0,0,0.13)!important;}
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>
  <script type="text/babel" data-presets="react">
const { useState, useEffect } = React;
// ---
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Nunito',sans-serif;background:#fdf6ee;min-height:100vh;}
    button{cursor:pointer;font-family:'Nunito',sans-serif;}
    input{font-family:'Nunito',sans-serif;}
    :root{
      --cream:#fdf6ee;--sun:#FFD166;--coral:#FF6B6B;--mint:#06D6A0;
      --sky:#4ECDC4;--blue:#2D6BE4;--navy:#1a3a6b;--purple:#9B5DE5;
      --peach:#FF9F7F;--text:#2c2c2c;--muted:#8a8a9a;--card:#fffdf9;
    }
    @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pop{0%,100%{transform:scale(1)}50%{transform:scale(1.13)}}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
    @keyframes confettiFall{to{transform:translateY(110vh) rotate(720deg);opacity:0}}
    @keyframes starPop{0%{transform:scale(0) rotate(-30deg);opacity:0}60%{transform:scale(1.35) rotate(5deg)}100%{transform:scale(1) rotate(0);opacity:1}}
  `}</style>
);

// ---

// Country system: each grade has names/labels per country.
// The grade id is the canonical age-based key (K, 1-12).
// Irish: Junior Infants ‚Üí 6th class (primary), 1st‚Äì6th year (secondary)
// UK (England/Wales): Reception ‚Üí Y11/Y12/Y13
// US: Kindergarten ‚Üí Grade 12
const COUNTRY_LABELS = {
  IE: {
    flag:"üáÆüá™", name:"Ireland",
    grades:{
      "K": {label:"JI",  name:"Junior Infants"},
      "1": {label:"SI",  name:"Senior Infants"},
      "2": {label:"1st", name:"1st Class"},
      "3": {label:"2nd", name:"2nd Class"},
      "4": {label:"3rd", name:"3rd Class"},
      "5": {label:"4th", name:"4th Class"},
      "6": {label:"5th", name:"5th Class"},
      "7": {label:"6th", name:"6th Class"},
      "8": {label:"1Y",  name:"1st Year"},
      "9": {label:"2Y",  name:"2nd Year"},
      "10":{label:"3Y",  name:"3rd Year (Junior Cert)"},
      "11":{label:"5Y",  name:"5th Year"},
      "12":{label:"6Y",  name:"6th Year (Leaving Cert)"},
    }
  },
  UK: {
    flag:"üá¨üáß", name:"UK",
    grades:{
      "K": {label:"Rec", name:"Reception"},
      "1": {label:"Y1",  name:"Year 1"},
      "2": {label:"Y2",  name:"Year 2"},
      "3": {label:"Y3",  name:"Year 3"},
      "4": {label:"Y4",  name:"Year 4"},
      "5": {label:"Y5",  name:"Year 5"},
      "6": {label:"Y6",  name:"Year 6"},
      "7": {label:"Y7",  name:"Year 7"},
      "8": {label:"Y8",  name:"Year 8"},
      "9": {label:"Y9",  name:"Year 9"},
      "10":{label:"Y10", name:"Year 10 (GCSE)"},
      "11":{label:"Y11", name:"Year 11 (GCSE)"},
      "12":{label:"Y13", name:"Year 13 (A-Level)"},
    }
  },
  US: {
    flag:"üá∫üá∏", name:"US",
    grades:{
      "K": {label:"K",   name:"Kindergarten"},
      "1": {label:"G1",  name:"1st Grade"},
      "2": {label:"G2",  name:"2nd Grade"},
      "3": {label:"G3",  name:"3rd Grade"},
      "4": {label:"G4",  name:"4th Grade"},
      "5": {label:"G5",  name:"5th Grade"},
      "6": {label:"G6",  name:"6th Grade"},
      "7": {label:"G7",  name:"7th Grade"},
      "8": {label:"G8",  name:"8th Grade"},
      "9": {label:"G9",  name:"9th Grade"},
      "10":{label:"G10", name:"10th Grade"},
      "11":{label:"G11", name:"11th Grade"},
      "12":{label:"G12", name:"12th Grade"},
    }
  },
};

function getGradeLabel(gradeId, country) {
  return COUNTRY_LABELS[country]?.grades[gradeId]?.label || gradeId;
}
function getGradeName(gradeId, country) {
  return COUNTRY_LABELS[country]?.grades[gradeId]?.name || `Grade ${gradeId}`;
}

// Master grade list ‚Äî id is the canonical key, age is always shown
const GRADES = [
  { id:"K",  age:"4‚Äì5",  color:"#FFD166", emoji:"üéí",
    topics:["counting","addition_basic","subtraction_basic","shapes"] },
  { id:"1",  age:"5‚Äì6",  color:"#FFB347", emoji:"üå±",
    topics:["addition_basic","subtraction_basic","counting","place_value_10"] },
  { id:"2",  age:"6‚Äì7",  color:"#FF9F7F", emoji:"üåø",
    topics:["addition","subtraction","place_value","skip_counting"] },
  { id:"3",  age:"7‚Äì8",  color:"#06D6A0", emoji:"üåä",
    topics:["multiplication","division","addition","subtraction","fractions_intro"] },
  { id:"4",  age:"8‚Äì9",  color:"#4ECDC4", emoji:"‚≠ê",
    topics:["multiplication","division","fractions","decimals_intro","place_value"] },
  { id:"5",  age:"9‚Äì10", color:"#2D6BE4", emoji:"üîÆ",
    topics:["multiplication","division","fractions","decimals","percentages_intro"] },
  { id:"6",  age:"10‚Äì11",color:"#9B5DE5", emoji:"üöÄ",
    topics:["fractions","decimals","percentages","integers","ratios"] },
  { id:"7",  age:"11‚Äì12",color:"#E040FB", emoji:"üî¨",
    topics:["integers","ratios","algebra_intro","geometry_basic","percentages"] },
  { id:"8",  age:"12‚Äì13",color:"#FF6B6B", emoji:"üìê",
    topics:["algebra_intro","algebra_linear","geometry_basic","statistics_intro","fractions"] },
  { id:"9",  age:"13‚Äì14",color:"#F06292", emoji:"üìä",
    topics:["algebra_linear","algebra_expand","geometry_angles","statistics_intro","pythagoras"] },
  { id:"10", age:"14‚Äì15",color:"#26C6DA", emoji:"üßÆ",
    topics:["algebra_linear","algebra_expand","pythagoras","trig_intro","statistics_intro"] },
  { id:"11", age:"15‚Äì16",color:"#66BB6A", emoji:"üìà",
    topics:["trig_intro","trig_advanced","algebra_quadratic","statistics_advanced","sequences"] },
  { id:"12", age:"16‚Äì18",color:"#8D6E63", emoji:"üéì",
    topics:["algebra_quadratic","trig_advanced","calculus_intro","sequences","statistics_advanced"] },
];

const TOPIC_LABELS = {
  counting:"Counting", addition_basic:"Basic Addition", addition:"Addition",
  subtraction_basic:"Basic Subtraction", subtraction:"Subtraction",
  multiplication:"Multiplication", division:"Division",
  place_value:"Place Value", place_value_10:"Place Value (10s)",
  skip_counting:"Skip Counting", shapes:"Shapes & Patterns",
  fractions_intro:"Intro to Fractions", fractions:"Fractions",
  decimals_intro:"Intro to Decimals", decimals:"Decimals",
  percentages_intro:"Intro to %", percentages:"Percentages",
  integers:"Integers", ratios:"Ratios",
  algebra_intro:"Intro to Algebra", algebra_linear:"Linear Equations",
  algebra_expand:"Expanding & Factoring", algebra_quadratic:"Quadratic Equations",
  geometry_basic:"Geometry Basics", geometry_angles:"Angles & Triangles",
  statistics_intro:"Intro to Statistics", statistics_advanced:"Statistics",
  pythagoras:"Pythagoras' Theorem", trig_intro:"Intro to Trigonometry",
  trig_advanced:"Trigonometry", sequences:"Sequences & Series",
  calculus_intro:"Intro to Calculus",
};

const TOPIC_EMOJIS = {
  counting:"üî¢", addition_basic:"‚ûï", addition:"‚ûï",
  subtraction_basic:"‚ûñ", subtraction:"‚ûñ", multiplication:"‚úñÔ∏è",
  division:"‚ûó", place_value:"üìä", place_value_10:"üìä",
  skip_counting:"‚è≠Ô∏è", shapes:"üî∑", fractions_intro:"ü•ß",
  fractions:"ü•ß", decimals_intro:"üî∏", decimals:"üî∏",
  percentages_intro:"%", percentages:"%", integers:"¬±", ratios:"‚öñÔ∏è",
  algebra_intro:"üî§", algebra_linear:"üìè", algebra_expand:"üîì",
  algebra_quadratic:"üìê", geometry_basic:"üìê", geometry_angles:"üìê",
  statistics_intro:"üìä", statistics_advanced:"üìä", pythagoras:"üìê",
  trig_intro:"üìê", trig_advanced:"üìê", sequences:"üî¢", calculus_intro:"‚à´",
};

const TOPIC_RESOURCES = {
  counting:          ["Count real objects at home ‚Äî spoons, toys, steps!", "Draw a number line and point to each number", "Khan Academy Kids: Counting & Numbers"],
  addition_basic:    ["Use fingers or counters to count up from the bigger number", "Make 'fact family' triangles (2+3=5, 5-3=2)", "Khan Academy: Basic Addition"],
  addition:          ["Try 'make a 10' ‚Äî fill up to 10 first, then add the rest", "Use base-10 blocks or draw hundreds/tens/ones", "IXL Math: Addition practice"],
  subtraction_basic: ["Start at the big number, count backwards on a number line", "Act it out with objects ‚Äî take some away, count what's left", "Khan Academy: Subtraction basics"],
  subtraction:       ["Check by adding your answer back to the smaller number", "Draw a number line for tricky problems", "IXL Math: Subtraction"],
  multiplication:    ["Sing times tables ‚Äî tons of fun songs on YouTube!", "Draw arrays: rows √ó columns of dots", "Multiplication.com: Games & songs"],
  division:          ["Think 'how many groups of __ fit in __?'", "Use the related times table fact to help", "Khan Academy: Intro to Division"],
  place_value:       ["Bundle straws into groups of 10 to see tens & ones", "Draw a chart: Hundreds | Tens | Ones", "Khan Academy: Place Value"],
  place_value_10:    ["Practice with coins: 10c = 1 ten! Group objects in tens", "Write in expanded form: 47 = 40 + 7", "Khan Academy: Tens and Ones"],
  skip_counting:     ["Clap or jump while skip-counting ‚Äî make it physical!", "Highlight every 2nd (or 5th, 10th) number on a 100-chart", "ABCya: Skip Counting games"],
  shapes:            ["Go on a shape hunt around your house!", "Draw each shape and count its sides & corners", "Khan Academy Kids: Shapes"],
  fractions_intro:   ["Fold paper into equal parts and shade some in", "Use a real pizza ‚Äî 'How many slices out of how many total?'", "Khan Academy: Intro to Fractions"],
  fractions:         ["Draw fraction bars side by side to compare", "Use fraction tiles or strips of paper", "Khan Academy: Fractions"],
  decimals_intro:    ["Use money ‚Äî cents are hundredths, 10c coins are tenths!", "Draw a number line from 0 to 1 split into 10 parts", "Khan Academy: Intro to Decimals"],
  decimals:          ["Always line up the decimal points before adding", "Use grid paper where each small square = 0.01", "IXL: Decimals practice"],
  percentages_intro: ["Percent = out of 100. Imagine a 10√ó10 grid!", "50% = half, 25% = quarter ‚Äî start with those anchors", "Khan Academy: Intro to Percentages"],
  percentages:       ["To find 10%, just move the decimal one place left", "Build from 10%: 20% = double 10%, 15% = 10% + half of 10%", "IXL: Percentages"],
  integers:          ["Use a number line that goes left of zero into negatives", "Think of temperature: above zero vs below zero", "Khan Academy: Negative Numbers"],
  ratios:            ["Draw the ratio as coloured circles ‚Äî e.g. 2 red : 3 blue", "Think of ratios as a recipe you can scale up or down", "Khan Academy: Intro to Ratios"],
  algebra_intro:     ["Think of the letter as a mystery box ‚Äî what number fits?", "Draw a balance scale: both sides must be equal", "Khan Academy: Intro to Algebra"],
  algebra_linear:    ["Do the same thing to both sides of the equation", "Work backwards: undo each operation step by step", "Khan Academy: Linear Equations"],
  algebra_expand:    ["FOIL method for brackets: First, Outer, Inner, Last", "Factoring is expanding in reverse ‚Äî look for common factors", "Khan Academy: Expanding & Factoring"],
  algebra_quadratic: ["Try factoring first, then the quadratic formula if needed", "x = (‚àíb ¬± ‚àö(b¬≤‚àí4ac)) / 2a ‚Äî write it on a card!", "Khan Academy: Quadratic Equations"],
  geometry_basic:    ["Draw diagrams ‚Äî geometry is visual!", "Remember: angles in a triangle always add to 180¬∞", "Khan Academy: Basic Geometry"],
  geometry_angles:   ["Angles on a straight line add to 180¬∞; full turn = 360¬∞", "Use a protractor to measure and draw angles accurately", "Khan Academy: Angles"],
  statistics_intro:  ["Mean = sum √∑ count. Median = middle value when sorted", "Draw a tally chart to organise data before calculating", "Khan Academy: Statistics Intro"],
  statistics_advanced:["Standard deviation measures spread ‚Äî not just the centre", "Draw a box-and-whisker plot to visualise the distribution", "Khan Academy: Statistics"],
  pythagoras:        ["a¬≤ + b¬≤ = c¬≤ ‚Äî c is always the longest side (hypotenuse)", "Draw the triangle and label sides before calculating", "Khan Academy: Pythagorean Theorem"],
  trig_intro:        ["SOH-CAH-TOA ‚Äî write it on your hand!", "Label O (opposite), A (adjacent), H (hypotenuse) first", "Khan Academy: Intro to Trigonometry"],
  trig_advanced:     ["Know the unit circle ‚Äî sin, cos, tan for key angles", "Practice converting between degrees and radians", "Khan Academy: Trigonometry"],
  sequences:         ["Find the pattern first: what changes between each term?", "Arithmetic: add a fixed amount. Geometric: multiply by a fixed ratio", "Khan Academy: Sequences"],
  calculus_intro:    ["Differentiation finds the slope; integration finds the area", "Power rule: d/dx(x‚Åø) = nx‚Åø‚Åª¬π", "Khan Academy: Calculus"],
};

const ENCOURAGEMENTS = {
  perfect: ["üèÜ PERFECT! You're a Math Superstar!", "üåü Absolutely flawless ‚Äî every single one!", "üí´ 100%! You completely crushed it today!"],
  great:   ["üéâ Amazing work! You really know this stuff!", "‚≠ê Super impressive ‚Äî you're on fire!", "üåà Brilliant job! You should feel so proud!"],
  good:    ["üòä Really nice work! You're building great skills!", "üëç Solid effort! Every practice makes you stronger!", "üåª Great job! You're growing more capable every day!"],
  growing: ["üí™ You showed up and tried hard ‚Äî that's the most important thing!", "üå± Every expert started exactly where you are. Keep going!", "ü§ó Your brain grew today ‚Äî even the tricky ones make you smarter!"],
};

const MASTERY_THRESHOLD = 80;
const AVATARS = ["ü¶ã","üê¨","ü¶ä","üêº","ü¶Ñ","üê∏","ü¶Å","üê®","ü¶ú","üêô","üåª","üåü","üé®","üé∏","üöÄ"];

// ---
function rnd(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

// Fisher-Yates shuffle, then fix any same-neighbor repeats (by topic)
function smartShuffle(arr) {
  const a = [...arr];
  // Fisher-Yates
  for (let i = a.length - 1; i > 0; i--) {
    const j = rnd(0, i);
    [a[i], a[j]] = [a[j], a[i]];
  }
  // Repair same-topic neighbors: scan and swap offenders with a later non-matching card
  for (let i = 1; i < a.length; i++) {
    if (a[i].topic === a[i - 1].topic) {
      // find next card with a different topic
      let swapIdx = -1;
      for (let k = i + 1; k < a.length; k++) {
        if (a[k].topic !== a[i - 1].topic && (i === 1 || a[k].topic !== a[i - 2]?.topic)) {
          swapIdx = k; break;
        }
      }
      if (swapIdx !== -1) [a[i], a[swapIdx]] = [a[swapIdx], a[i]];
    }
  }
  return a;
}

function generateProblem(topic, difficulty) {
  const hard = difficulty === "hard", easy = difficulty === "easy";
  let q, a, hint = "";
  switch (topic) {
    case "counting": { const n=easy?rnd(2,10):hard?rnd(20,50):rnd(10,20); q=`What comes after ${n-1}?`; a=n; break; }
    case "shapes": { const sh=[{n:"triangle",s:3},{n:"square",s:4},{n:"pentagon",s:5},{n:"hexagon",s:6}]; const s=sh[rnd(0,sh.length-1)]; q=`How many sides does a ${s.n} have?`; a=s.s; break; }
    case "addition_basic": { const x=easy?rnd(1,5):rnd(1,9),y=easy?rnd(1,4):rnd(1,9); q=`${x} + ${y} = ?`; a=x+y; break; }
    case "addition": { const max=easy?20:hard?999:99; const x=rnd(1,max),y=rnd(1,max); q=`${x} + ${y} = ?`; a=x+y; break; }
    case "subtraction_basic": { const b=easy?rnd(2,9):rnd(3,12),c=rnd(1,b); q=`${b} ‚àí ${c} = ?`; a=b-c; break; }
    case "subtraction": { const max=easy?20:hard?999:99; const x=rnd(Math.ceil(max/2),max),y=rnd(1,x); q=`${x} ‚àí ${y} = ?`; a=x-y; break; }
    case "multiplication": { const tMax=easy?5:hard?12:10; const x=rnd(2,tMax),y=rnd(2,tMax); q=`${x} √ó ${y} = ?`; a=x*y; hint="Times tables!"; break; }
    case "division": { const d=easy?rnd(2,5):hard?rnd(2,12):rnd(2,9); const ans=rnd(2,hard?12:9); q=`${d*ans} √∑ ${d} = ?`; a=ans; break; }
    case "place_value": case "place_value_10": { const n=topic==="place_value_10"?rnd(11,99):rnd(100,999); const tens=Math.floor(n/10)%10; q=`In the number ${n},\nhow many tens?`; a=tens; hint="Look at the tens place"; break; }
    case "skip_counting": { const step=[2,3,5,10][rnd(0,3)]; const start=step*rnd(1,5); q=`${start}, ${start+step}, ${start+2*step}, __?`; a=start+3*step; hint=`Skip by ${step}s`; break; }
    case "fractions_intro": { const dens=[2,3,4]; const d=dens[rnd(0,2)]; const n2=rnd(1,d-1); q=`${n2} out of ${d} equal parts.\nWrite the fraction:`; a=`${n2}/${d}`; break; }
    case "fractions": { const d=rnd(2,8); const n1=rnd(1,d-1),n2=rnd(1,d-n1); q=`${n1}/${d}  +  ${n2}/${d}  = ?/${d}`; a=n1+n2; hint="Add the top numbers!"; break; }
    case "decimals_intro": case "decimals": { const x=parseFloat((rnd(10,99)/10).toFixed(1)),y=parseFloat((rnd(10,99)/10).toFixed(1)); q=`${x} + ${y} = ?`; a=parseFloat((x+y).toFixed(1)); break; }
    case "percentages_intro": case "percentages": { const pcts=[10,25,50]; const p=pcts[rnd(0,pcts.length-1)]; const n2=rnd(2,10)*10; q=`What is ${p}% of ${n2}?`; a=n2*p/100; hint=`${p}% = ${p}/100`; break; }
    case "integers": { const x=rnd(-9,9),y=rnd(-9,9); q=`${x>=0?x:`(${x})`} + ${y>=0?y:`(${y})`} = ?`; a=x+y; hint="Use a number line"; break; }
    case "ratios": { const x=rnd(1,6),y=rnd(1,6),m=rnd(2,4); q=`${x} : ${y}  =  ? : ${y*m}`; a=x*m; hint="Scale both parts equally"; break; }
    // ---
    case "algebra_intro": { const a2=rnd(1,9),b2=rnd(1,20); q=`x + ${a2} = ${a2+b2}\nFind x`; a=b2; hint="Subtract from both sides"; break; }
    case "algebra_linear": {
      if (easy) { const a2=rnd(2,9),b2=rnd(1,20); q=`${a2}x = ${a2*b2}\nFind x`; a=b2; hint="Divide both sides by "+a2; }
      else if (hard) { const a2=rnd(2,8),b2=rnd(1,6),c2=rnd(1,20); q=`${a2}x + ${b2} = ${a2*c2+b2}\nFind x`; a=c2; hint="Subtract "+b2+", then divide by "+a2; }
      else { const a2=rnd(2,9),b2=rnd(2,15); q=`${a2}x ‚àí ${b2} = ${a2*rnd(2,8)-b2}\nFind x`; const ans2=Math.round((parseFloat(q.split("=")[1])+b2)/a2); a=ans2; hint="Add "+b2+", then divide by "+a2; }
      break;
    }
    case "algebra_expand": {
      const a2=rnd(1,5),b2=rnd(1,5),c2=rnd(1,5),d2=rnd(1,5);
      if (easy) { q=`Expand: ${a2}(x + ${b2})`; a=`${a2}x + ${a2*b2}`; hint="Multiply "+a2+" by each term"; }
      else { q=`Expand: (x + ${b2})(x + ${d2})`; a=`x¬≤ + ${b2+d2}x + ${b2*d2}`; hint="FOIL: First, Outer, Inner, Last"; }
      break;
    }
    case "algebra_quadratic": {
      const r1=rnd(1,7),r2=rnd(1,7);
      q=`Solve: x¬≤ ‚àí ${r1+r2}x + ${r1*r2} = 0\nFind x`; a=`${r1} or ${r2}`; hint="Factor: (x‚àía)(x‚àíb)=0"; break;
    }
    case "geometry_basic": {
      const sides=rnd(3,6); const angle=Math.round(180*(sides-2)/sides);
      q=`Interior angle of a regular ${sides}-sided polygon?`; a=angle; hint=`(${sides}‚àí2) √ó 180 √∑ ${sides}`; break;
    }
    case "geometry_angles": {
      const types=[
        {q:"Angles in a triangle add to __¬∞", a:180},
        {q:"Angles on a straight line add to __¬∞", a:180},
        {q:"Angles in a full turn = __¬∞", a:360},
        ()=>{ const x=rnd(20,80); return {q:`One angle is ${x}¬∞.\nIts supplement is __¬∞`, a:180-x, hint:"Supplementary angles add to 180¬∞"}; },
        ()=>{ const x=rnd(20,80); return {q:`One angle is ${x}¬∞.\nIts complement is __¬∞`, a:90-x, hint:"Complementary angles add to 90¬∞"}; },
      ];
      const pick=types[rnd(0,types.length-1)];
      const chosen=typeof pick==="function"?pick():pick;
      q=chosen.q; a=chosen.a; hint=chosen.hint||""; break;
    }
    case "statistics_intro": {
      const nums=Array.from({length:5},()=>rnd(1,20)).sort((x,y)=>x-y);
      const types=["mean","median","mode"];
      const type=types[rnd(0,2)];
      if(type==="mean"){ a=parseFloat((nums.reduce((s,n)=>s+n,0)/nums.length).toFixed(1)); q=`Mean of:\n${nums.join(", ")}`; hint="Sum √∑ count"; }
      else if(type==="median"){ a=nums[2]; q=`Median of:\n${nums.join(", ")}`; hint="Middle value (already sorted!)"; }
      else { const m=nums[rnd(1,3)]; const arr=[...nums,m].sort((x,y)=>x-y); a=m; q=`Mode of:\n${arr.join(", ")}`; hint="Most frequent value"; }
      break;
    }
    case "statistics_advanced": {
      const n1=rnd(2,8),n2=rnd(2,8),n3=rnd(2,8),n4=rnd(2,8),n5=rnd(2,8);
      const mean=parseFloat(((n1+n2+n3+n4+n5)/5).toFixed(1));
      q=`Mean of ${n1}, ${n2}, ${n3}, ${n4}, ${n5}?`; a=mean; hint="Add all, divide by 5"; break;
    }
    case "pythagoras": {
      const triples=[[3,4,5],[5,12,13],[8,15,17],[6,8,10]];
      const [a2,b2,c2]=triples[rnd(0,triples.length-1)];
      if(rnd(0,1)){ q=`Right triangle:\na=${a2}, b=${b2}\nFind c (hypotenuse)`; a=c2; hint="c¬≤ = a¬≤ + b¬≤"; }
      else { q=`Right triangle:\na=${a2}, c=${c2}\nFind b`; a=b2; hint="b¬≤ = c¬≤ ‚àí a¬≤"; }
      break;
    }
    case "trig_intro": {
      const angles=[30,45,60];
      const ang=angles[rnd(0,2)];
      const vals={30:{sin:"0.5",cos:"0.866",tan:"0.577"},45:{sin:"0.707",cos:"0.707",tan:"1"},60:{sin:"0.866",cos:"0.5",tan:"1.732"}};
      const fn=["sin","cos","tan"][rnd(0,2)];
      q=`${fn}(${ang}¬∞) = ?`; a=parseFloat(vals[ang][fn]); hint="SOH-CAH-TOA"; break;
    }
    case "trig_advanced": {
      const ang=[0,30,45,60,90][rnd(0,4)];
      const fn=["sin","cos"][rnd(0,1)];
      const exact={sin:{0:"0",30:"¬Ω",45:"‚àö2/2",60:"‚àö3/2",90:"1"},cos:{0:"1",30:"‚àö3/2",45:"‚àö2/2",60:"¬Ω",90:"0"}};
      q=`Exact value:\n${fn}(${ang}¬∞) = ?`; a=exact[fn][ang]; hint="Learn the unit circle values"; break;
    }
    case "sequences": {
      if(easy||rnd(0,1)){ // arithmetic
        const first=rnd(1,10),diff=rnd(1,8);
        const terms=[first,first+diff,first+2*diff,first+3*diff];
        q=`${terms.join(", ")}, __?\n(Arithmetic sequence)`; a=first+4*diff; hint=`Common difference = ${diff}`;
      } else { // geometric
        const first=rnd(1,5),ratio=rnd(2,3);
        const terms=[first,first*ratio,first*ratio*ratio,first*ratio*ratio*ratio];
        q=`${terms.join(", ")}, __?\n(Geometric sequence)`; a=first*Math.pow(ratio,4); hint=`Common ratio = ${ratio}`;
      }
      break;
    }
    case "calculus_intro": {
      const n2=rnd(2,6),c2=rnd(1,5);
      if(easy||rnd(0,1)){ q=`Differentiate:\nf(x) = ${c2}x^${n2}`; a=`${c2*n2}x^${n2-1}`; hint=`Power rule: d/dx(ax‚Åø) = anx^(n-1)`; }
      else { q=`Differentiate:\nf(x) = x^${n2} + ${c2}`; a=`${n2}x^${n2-1}`; hint="Constants differentiate to 0"; }
      break;
    }
    default: { q="1 + 1 = ?"; a=2; }
  }
  return { question:q, answer:a, hint, topic };
}

function generateChoices(correct) {
  const cs = String(correct);
  const set = new Set([cs]);
  const offsets = [1,2,3,5,10,-1,-2,-3,-5,4,-4,7,-7];
  let tries = 0;
  while (set.size < 4 && tries < 80) {
    tries++;
    const num = parseFloat(cs);
    if (!isNaN(num)) {
      const off = offsets[rnd(0,offsets.length-1)];
      const w = parseFloat((num+off).toFixed(2));
      if (w >= 0) set.add(String(w));
    } else if (cs.includes("/")) {
      const [n,d] = cs.split("/").map(Number);
      const wn = Math.max(1, n + rnd(-2,2));
      const w = `${wn}/${d}`;
      if (w !== cs) set.add(w);
    }
  }
  let fill = 1;
  while (set.size < 4) { set.add(String(parseFloat(cs||"0") + fill*13)); fill++; }
  return [...set].sort(() => Math.random()-0.5);
}

// ---
const SK          = "mathAdventure_v4";
const SK_COUNTRY  = "mathAdventure_country";
const SK_FAMILY   = "mathAdventure_family";
const SK_PARENT   = "mathAdventure_parentMode";
const SK_LABELS   = "mathAdventure_labels";

function loadProfiles()  { try { return JSON.parse(localStorage.getItem(SK)||"[]");      } catch { return []; } }
function saveProfiles(p) { try { localStorage.setItem(SK, JSON.stringify(p));            } catch {} }
function loadCountry()   { try { return localStorage.getItem(SK_COUNTRY)||"IE";          } catch { return "IE"; } }
function saveCountry(c)  { try { localStorage.setItem(SK_COUNTRY, c);                    } catch {} }
function loadFamilyCode(){ try { return localStorage.getItem(SK_FAMILY)||null;           } catch { return null; } }
function saveFamilyCode(c){try { localStorage.setItem(SK_FAMILY, c);                    } catch {} }
function loadCustomLabels(){try{return JSON.parse(localStorage.getItem(SK_LABELS)||"null")||DEFAULT_MASTERY_LABELS;}catch{return DEFAULT_MASTERY_LABELS;}}
function saveCustomLabels(l){try{localStorage.setItem(SK_LABELS,JSON.stringify(l));}catch{}}

// Generate a memorable 6-char family code  e.g. "MAT-7K2"
function genFamilyCode() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let s = "MA-";
  for (let i=0;i<4;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

function makeProfile(name, gradeId, avatar) {
  return { id:Date.now()+Math.random(), name, gradeId, avatar, topicProgress:{}, quizHistory:[], createdAt:Date.now() };
}

// ---
const DEFAULT_MASTERY_LABELS = {
  mastered: { label:"Mastered",  emoji:"‚úì",  bg:"#d4f7ec", color:"#0d6e4f" },
  learning: { label:"Learning",  emoji:"üìà", bg:"#fff3cd", color:"#856404" },
  growing:  { label:"Growing",   emoji:"üå±", bg:"#fde8ed", color:"#cc2244" },
  new:      { label:"New",       emoji:"‚ú®", bg:"#f0f0f0", color:"#888"    },
};

function getTopicMastery(profile, topic) {
  const p = profile.topicProgress[topic];
  if (!p||p.attempts<5) return "new";
  const pct = (p.correct/p.attempts)*100;
  if (pct>=MASTERY_THRESHOLD) return "mastered";
  if (pct>=50) return "learning";
  return "growing";
}
function getTopicPct(profile, topic) {
  const p = profile.topicProgress[topic];
  if (!p||p.attempts===0) return null;
  return Math.round((p.correct/p.attempts)*100);
}

// ---
// üîß REPLACE the values below with your own Firebase project config.
//    In Firebase console: Project Settings ‚Üí Your apps ‚Üí SDK setup ‚Üí Config
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyCxqGRhdCyh92LyiFvrTi6ETTiFKVhDvUM",
  authDomain:        "homeschool-math.firebaseapp.com",
  databaseURL:       "https://homeschool-math-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:         "homeschool-math",
  storageBucket:     "homeschool-math.firebasestorage.app",
  messagingSenderId: "275309549483",
  appId:             "1:275309549483:web:945998a87f4e58b96f24ee",
};

// Lazy Firebase loader ‚Äî only imports when needed so the app works without Firebase too
let _db = null;
async function getDb() {
  if (_db) return _db;
  try {
    const { initializeApp, getApps } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getFirestore, collection, addDoc, getDocs, query, orderBy, where }
      = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
    const app = getApps().length ? getApps()[0] : initializeApp(FIREBASE_CONFIG);
    _db = { db: getFirestore(app), collection, addDoc, getDocs, query, orderBy, where };
    return _db;
  } catch(e) { console.warn("Firebase unavailable:", e); return null; }
}

async function submitFeedback(familyCode, entry) {
  const fb = await getDb();
  if (!fb) return false;
  try {
    const { db, collection, addDoc } = fb;
    await addDoc(collection(db, "feedback"), {
      familyCode, ...entry, ts: Date.now()
    });
    return true;
  } catch(e) { console.error("submitFeedback:", e); return false; }
}

async function loadAllFeedback() {
  const fb = await getDb();
  if (!fb) return [];
  try {
    const { db, collection, getDocs, query, orderBy } = fb;
    const snap = await getDocs(query(collection(db, "feedback"), orderBy("ts","desc")));
    return snap.docs.map(d=>({id:d.id,...d.data()}));
  } catch(e) { console.error("loadAllFeedback:", e); return []; }
}

async function saveFamilyToFirebase(familyCode, profiles) {
  const fb = await getDb();
  if (!fb) return;
  try {
    const { db, collection, addDoc, getDocs, query, where } = fb;
    // Upsert: store latest snapshot under this family code
    await addDoc(collection(db, "families"), { familyCode, profiles, ts: Date.now() });
  } catch(e) { console.warn("saveFamilyToFirebase:", e); }
}

async function loadFamilyFromFirebase(familyCode) {
  const fb = await getDb();
  if (!fb) return null;
  try {
    const { db, collection, getDocs, query, where, orderBy } = fb;
    const snap = await getDocs(
      query(collection(db,"families"), where("familyCode","==",familyCode), orderBy("ts","desc"))
    );
    if (snap.empty) return null;
    return snap.docs[0].data().profiles || null;
  } catch(e) { console.warn("loadFamilyFromFirebase:", e); return null; }
}

// PIN constants (hashed client-side ‚Äî fine for a family app)
const PARENT_PIN_HASH = "1234"; // change this to your preferred parent PIN
const ADMIN_PIN_HASH  = "9999"; // change this to your admin PIN

// ---
function Page({ children }) {
  return (
    <div style={{minHeight:"100vh",
      background:"linear-gradient(160deg,#fdf6ee 0%,#f0f8ff 50%,#fef0f5 100%)",
      backgroundAttachment:"fixed",padding:"16px"}}>
      <div style={{maxWidth:600,margin:"0 auto"}}>{children}</div>
    </div>
  );
}

function ProgressBar({ pct, color="#06D6A0", height=10 }) {
  return (
    <div style={{background:"#eee",borderRadius:30,height,overflow:"hidden",flex:1,minWidth:40}}>
      <div style={{width:`${Math.min(100,Math.max(0,pct))}%`,height:"100%",borderRadius:30,
        background:`linear-gradient(90deg,${color}88,${color})`,transition:"width 0.6s ease"}}/>
    </div>
  );
}

function MasteryBadge({ status, labels }) {
  const map = labels || DEFAULT_MASTERY_LABELS;
  const s = map[status] || map.new;
  return <span style={{background:s.bg,color:s.color,borderRadius:20,padding:"3px 10px",
    fontSize:"0.72rem",fontWeight:800,whiteSpace:"nowrap"}}>{s.label} {s.emoji}</span>;
}

function Stars({ count, max=3 }) {
  return (
    <div style={{display:"flex",gap:6,justifyContent:"center",margin:"8px 0"}}>
      {Array.from({length:max},(_,i)=>(
        <span key={i} style={{fontSize:"2rem",
          animation:i<count?`starPop 0.4s ${i*0.15}s ease both`:"none",
          opacity:i<count?1:0.2,filter:i<count?"none":"grayscale(1)"}}>‚≠ê</span>
      ))}
    </div>
  );
}

function Confetti() {
  const pieces = Array.from({length:32},(_,i)=>({
    id:i,x:Math.random()*100,
    color:["#FFD166","#06D6A0","#FF6B6B","#9B5DE5","#4ECDC4","#2D6BE4"][i%6],
    size:rnd(8,16),delay:Math.random()*1.2,dur:1.4+Math.random()*1.4
  }));
  return (
    <div style={{position:"fixed",inset:0,pointerEvents:"none",overflow:"hidden",zIndex:999}}>
      {pieces.map(p=>(
        <div key={p.id} style={{position:"absolute",left:`${p.x}%`,top:"-20px",
          width:p.size,height:p.size,borderRadius:"3px",background:p.color,
          animation:`confettiFall ${p.dur}s ${p.delay}s ease-in forwards`}}/>
      ))}
    </div>
  );
}

// ---
function FeedbackWidget({ familyCode, profiles }) {
  const [open,    setOpen]    = useState(false);
  const [stars,   setStars]   = useState(0);
  const [hover,   setHover]   = useState(0);
  const [comment, setComment] = useState("");
  const [who,     setWho]     = useState("");
  const [sending, setSending] = useState(false);
  const [sent,    setSent]    = useState(false);

  const handleSubmit = async () => {
    if (!stars) return;
    setSending(true);
    const ok = await submitFeedback(familyCode, {
      stars, comment: comment.trim(), who: who.trim() || "Anonymous",
      profileCount: profiles.length,
    });
    setSending(false);
    if (ok !== false) { setSent(true); setTimeout(()=>{ setSent(false); setOpen(false); setStars(0); setComment(""); setWho(""); }, 2200); }
  };

  return (
    <>
      {/* Floating star button */}
      <button onClick={()=>setOpen(true)} style={{
        position:"fixed", bottom:20, right:20, zIndex:800,
        background:"linear-gradient(135deg,#FFD166,#FF9F7F)",
        border:"none", borderRadius:"50%", width:52, height:52,
        fontSize:"1.5rem", boxShadow:"0 4px 18px rgba(255,160,60,0.45)",
        display:"flex",alignItems:"center",justifyContent:"center",
        cursor:"pointer", transition:"transform 0.15s",
      }}
        onMouseEnter={e=>e.currentTarget.style.transform="scale(1.12)"}
        onMouseLeave={e=>e.currentTarget.style.transform="scale(1)"}
        title="Leave feedback"
      >‚≠ê</button>

      {/* Modal */}
      {open && (
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.45)",zIndex:900,
          display:"flex",alignItems:"center",justifyContent:"center",padding:16}}
          onClick={e=>{if(e.target===e.currentTarget)setOpen(false);}}>
          <div style={{background:"#fffdf9",borderRadius:24,padding:28,maxWidth:400,width:"100%",
            boxShadow:"0 8px 40px rgba(0,0,0,0.18)",animation:"fadeUp 0.3s ease"}}>
            {sent ? (
              <div style={{textAlign:"center",padding:"20px 0"}}>
                <div style={{fontSize:"3rem",marginBottom:10}}>üéâ</div>
                <div style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.4rem",fontWeight:800,color:"var(--navy)"}}>
                  Thank you so much!
                </div>
                <p style={{color:"var(--muted)",fontWeight:600,marginTop:6}}>Your feedback helps us improve.</p>
              </div>
            ) : (
              <>
                <div style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.25rem",fontWeight:800,color:"var(--navy)",marginBottom:4}}>
                  ‚≠ê How are we doing?
                </div>
                <p style={{color:"var(--muted)",fontWeight:600,fontSize:"0.85rem",marginBottom:16,lineHeight:1.5}}>
                  We'd love to hear from you! Your feedback helps make Math Adventure better for every family.
                </p>

                {/* Star picker */}
                <div style={{display:"flex",gap:6,justifyContent:"center",marginBottom:16}}>
                  {[1,2,3,4,5].map(n=>(
                    <button key={n} onClick={()=>setStars(n)}
                      onMouseEnter={()=>setHover(n)} onMouseLeave={()=>setHover(0)}
                      style={{fontSize:"2.2rem",border:"none",background:"transparent",
                        cursor:"pointer",transition:"transform 0.1s",
                        transform:(hover||stars)>=n?"scale(1.2)":"scale(1)",
                        filter:(hover||stars)>=n?"none":"grayscale(1) opacity(0.35)"}}>
                      ‚≠ê
                    </button>
                  ))}
                </div>
                {stars>0 && (
                  <div style={{textAlign:"center",fontSize:"0.8rem",fontWeight:700,color:"var(--muted)",marginBottom:12}}>
                    {["","üòû That's tough to hear","üòê Room to improve","üôÇ Glad it's helping","üòä That's great!","ü§© You made our day!"][stars]}
                  </div>
                )}

                {/* Who */}
                <label style={S.inputLabel}>Your name (optional)</label>
                <input style={{...S.input,marginBottom:12}} placeholder="e.g. Emma or Dad"
                  value={who} onChange={e=>setWho(e.target.value)} maxLength={30}/>

                {/* Comment */}
                <label style={S.inputLabel}>Comments (optional)</label>
                <textarea value={comment} onChange={e=>setComment(e.target.value)}
                  placeholder="What do you love? What could be better? Any topic requests?"
                  maxLength={400}
                  style={{...S.input,height:90,resize:"vertical",marginBottom:20,fontFamily:"Nunito,sans-serif",lineHeight:1.5}}/>

                <div style={{display:"flex",gap:10}}>
                  <button style={{...S.btnSecondary,flex:1}} onClick={()=>setOpen(false)}>Cancel</button>
                  <button style={{...S.btnPrimary,flex:2,
                    opacity:stars&&!sending?1:0.45}}
                    disabled={!stars||sending}
                    onClick={handleSubmit}>
                    {sending?"Sending‚Ä¶":"Send Feedback ‚úàÔ∏è"}
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </>
  );
}

// ---
function PinModal({ title, subtitle, correctPin, onSuccess, onCancel }) {
  const [digits, setDigits] = useState("");
  const [err,    setErr]    = useState(false);

  const submit = () => {
    if (digits === correctPin) { onSuccess(); }
    else { setErr(true); setDigits(""); setTimeout(()=>setErr(false),800); }
  };

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:950,
      display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
      <div style={{background:"#fffdf9",borderRadius:24,padding:28,maxWidth:340,width:"100%",
        animation:`${err?"shake":"fadeUp"} 0.3s ease`,boxShadow:"0 8px 40px rgba(0,0,0,0.2)"}}>
        <div style={{textAlign:"center",marginBottom:16}}>
          <div style={{fontSize:"2.5rem",marginBottom:6}}>üîí</div>
          <div style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.2rem",fontWeight:800,color:"var(--navy)"}}>{title}</div>
          {subtitle&&<p style={{color:"var(--muted)",fontSize:"0.83rem",fontWeight:600,marginTop:4}}>{subtitle}</p>}
        </div>
        <input type="password" inputMode="numeric" maxLength={6}
          value={digits} onChange={e=>setDigits(e.target.value.replace(/\D/g,""))}
          onKeyDown={e=>e.key==="Enter"&&submit()}
          autoFocus
          style={{...S.input,textAlign:"center",fontSize:"1.4rem",letterSpacing:6,marginBottom:16}}
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        {err && <div style={{color:"var(--coral)",fontWeight:700,fontSize:"0.83rem",textAlign:"center",marginBottom:8}}>
          Incorrect PIN ‚Äî try again
        </div>}
        <div style={{display:"flex",gap:10}}>
          <button style={{...S.btnSecondary,flex:1}} onClick={onCancel}>Cancel</button>
          <button style={{...S.btnPrimary,flex:2}} onClick={submit}>Unlock</button>
        </div>
      </div>
    </div>
  );
}

// ---
function FamilySetup({ onComplete }) {
  const [mode,    setMode]    = useState("choice"); // "choice" | "join"
  const [code,    setCode]    = useState("");
  const [loading, setLoading] = useState(false);
  const [err,     setErr]     = useState("");

  const createFamily = () => {
    const fc = genFamilyCode();
    saveFamilyCode(fc);
    onComplete(fc);
  };

  const joinFamily = async () => {
    const trimmed = code.trim().toUpperCase();
    if (trimmed.length < 5) { setErr("Please enter a valid family code."); return; }
    setLoading(true); setErr("");
    const remoteProfiles = await loadFamilyFromFirebase(trimmed);
    setLoading(false);
    if (remoteProfiles) {
      saveFamilyCode(trimmed);
      saveProfiles(remoteProfiles);
      onComplete(trimmed, remoteProfiles);
    } else {
      // Code not found in Firebase yet ‚Äî still accept it (offline mode)
      saveFamilyCode(trimmed);
      onComplete(trimmed, null);
    }
  };

  return (
    <div style={{position:"fixed",inset:0,background:"linear-gradient(160deg,#fdf6ee,#f0f8ff)",
      zIndex:980,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}>
      <div style={{...S.card,maxWidth:420,width:"100%",textAlign:"center",animation:"fadeUp 0.4s ease"}}>
        <div style={{fontSize:"3rem",marginBottom:8}}>üë®‚Äçüë©‚Äçüëß‚Äçüëß</div>
        <h1 style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.8rem",fontWeight:900,color:"var(--navy)",marginBottom:4}}>
          Welcome to Math Adventure!
        </h1>
        <p style={{color:"var(--muted)",fontWeight:600,fontSize:"0.9rem",lineHeight:1.6,marginBottom:24}}>
          Create a Family Code to get started, or join an existing family to share profiles across devices.
        </p>

        {mode === "choice" ? (
          <>
            <button style={{...S.btnPrimary,width:"100%",marginBottom:12}} onClick={createFamily}>
              üè† Create a New Family
            </button>
            <button style={{...S.btnSecondary,width:"100%"}} onClick={()=>setMode("join")}>
              üîó Join with Family Code
            </button>
          </>
        ) : (
          <>
            <label style={{...S.inputLabel,textAlign:"left"}}>Family Code</label>
            <input style={{...S.input,textAlign:"center",fontSize:"1.2rem",letterSpacing:3,textTransform:"uppercase"}}
              placeholder="e.g. MA-WXYZ"
              value={code} onChange={e=>setCode(e.target.value.toUpperCase())}
              onKeyDown={e=>e.key==="Enter"&&joinFamily()}
              maxLength={10}/>
            {err && <div style={{color:"var(--coral)",fontWeight:700,fontSize:"0.82rem",marginBottom:8}}>{err}</div>}
            <div style={{display:"flex",gap:10,marginTop:8}}>
              <button style={{...S.btnSecondary,flex:1}} onClick={()=>setMode("choice")}>‚Üê Back</button>
              <button style={{...S.btnPrimary,flex:2,opacity:loading?0.5:1}} disabled={loading} onClick={joinFamily}>
                {loading?"Joining‚Ä¶":"Join Family ‚Üí"}
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}

// ---
function AdminPanel({ onClose }) {
  const [feedback, setFeedback] = useState(null);
  const [filter,   setFilter]   = useState(0); // 0=all

  useEffect(()=>{
    loadAllFeedback().then(setFeedback);
  }, []);

  const shown = feedback
    ? feedback.filter(f=>filter===0||f.stars===filter)
    : null;

  const avg = feedback && feedback.length
    ? (feedback.reduce((s,f)=>s+f.stars,0)/feedback.length).toFixed(1)
    : "‚Äî";

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",zIndex:970,
      display:"flex",alignItems:"flex-start",justifyContent:"center",padding:16,overflowY:"auto"}}>
      <div style={{background:"#fffdf9",borderRadius:24,padding:24,maxWidth:640,width:"100%",
        marginTop:20,boxShadow:"0 8px 40px rgba(0,0,0,0.25)",animation:"fadeUp 0.3s ease"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16}}>
          <div style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.4rem",fontWeight:800,color:"var(--navy)"}}>
            üõ°Ô∏è Admin ‚Äî All Feedback
          </div>
          <button style={S.backBtn} onClick={onClose}>‚úï Close</button>
        </div>

        {/* Stats */}
        <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap"}}>
          <div style={{background:"#eaf0ff",borderRadius:16,padding:"10px 18px",fontWeight:800,color:"var(--blue)",fontSize:"0.9rem"}}>
            üìù {feedback?.length??"‚Ä¶"} reviews
          </div>
          <div style={{background:"#fff8e1",borderRadius:16,padding:"10px 18px",fontWeight:800,color:"#856404",fontSize:"0.9rem"}}>
            ‚≠ê Avg {avg}
          </div>
        </div>

        {/* Star filter */}
        <div style={{display:"flex",gap:6,marginBottom:16,flexWrap:"wrap"}}>
          {[0,5,4,3,2,1].map(n=>(
            <button key={n} onClick={()=>setFilter(n)} style={{
              border:`2px solid ${filter===n?"var(--blue)":"#e0e0e0"}`,
              background:filter===n?"#eaf0ff":"#fafafa",borderRadius:20,
              padding:"5px 12px",fontWeight:700,fontSize:"0.8rem",
              color:filter===n?"var(--blue)":"var(--muted)"}}>
              {n===0?"All":`${"‚≠ê".repeat(n)}`}
            </button>
          ))}
        </div>

        {/* List */}
        {shown===null ? (
          <div style={{textAlign:"center",padding:32,color:"var(--muted)",fontWeight:600}}>Loading‚Ä¶</div>
        ) : shown.length===0 ? (
          <div style={{textAlign:"center",padding:32,color:"var(--muted)",fontWeight:600}}>No feedback yet.</div>
        ) : (
          <div style={{display:"flex",flexDirection:"column",gap:10,maxHeight:500,overflowY:"auto"}}>
            {shown.map(f=>(
              <div key={f.id} style={{background:"#f9f9f9",borderRadius:14,padding:"12px 16px",border:"1px solid #eee"}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4,flexWrap:"wrap"}}>
                  <span style={{fontSize:"0.95rem"}}>{"‚≠ê".repeat(f.stars)}</span>
                  <span style={{fontWeight:800,fontSize:"0.85rem",color:"var(--navy)"}}>{f.who||"Anonymous"}</span>
                  <span style={{fontSize:"0.72rem",color:"var(--muted)",marginLeft:"auto"}}>
                    {new Date(f.ts).toLocaleDateString()}
                  </span>
                  <span style={{background:"#eaf0ff",color:"var(--blue)",borderRadius:20,
                    padding:"2px 8px",fontSize:"0.7rem",fontWeight:700}}>
                    {f.familyCode}
                  </span>
                </div>
                {f.comment && <p style={{fontSize:"0.83rem",color:"var(--text)",lineHeight:1.5,margin:0}}>{f.comment}</p>}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// ---
function ParentPanel({ profiles, country, familyCode, labels, onUpdateLabels, onClose }) {
  const [tab, setTab] = useState("overview"); // "overview" | "labels"
  const [editLabels, setEditLabels] = useState({...labels});

  const handleSaveLabels = () => { onUpdateLabels(editLabels); };

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.55)",zIndex:960,
      display:"flex",alignItems:"flex-start",justifyContent:"center",padding:16,overflowY:"auto"}}>
      <div style={{background:"#fffdf9",borderRadius:24,padding:24,maxWidth:600,width:"100%",
        marginTop:20,boxShadow:"0 8px 40px rgba(0,0,0,0.2)",animation:"fadeUp 0.3s ease"}}>

        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:4}}>
          <div style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.3rem",fontWeight:800,color:"var(--navy)"}}>
            üë®‚Äçüë©‚Äçüëß Parent & Teacher Mode
          </div>
          <button style={S.backBtn} onClick={onClose}>‚úï Close</button>
        </div>
        <div style={{fontSize:"0.78rem",color:"var(--muted)",fontWeight:600,marginBottom:16}}>
          Family code: <strong style={{color:"var(--navy)",letterSpacing:2}}>{familyCode}</strong>
          <span style={{marginLeft:8,fontSize:"0.72rem",opacity:0.7}}>¬∑ Share this so family members can join on other devices</span>
        </div>

        {/* Tabs */}
        <div style={{display:"flex",gap:8,marginBottom:20}}>
          {[["overview","üìä Overview"],["labels","üè∑Ô∏è Custom Labels"]].map(([t,l])=>(
            <button key={t} onClick={()=>setTab(t)} style={{
              border:`2px solid ${tab===t?"var(--blue)":"#e0e0e0"}`,
              background:tab===t?"#eaf0ff":"#fafafa",borderRadius:20,
              padding:"7px 16px",fontWeight:800,fontSize:"0.85rem",
              color:tab===t?"var(--blue)":"var(--muted)"}}>
              {l}
            </button>
          ))}
        </div>

        {tab==="overview" && (
          <div style={{display:"flex",flexDirection:"column",gap:16}}>
            {profiles.map(profile=>{
              const grade = GRADES.find(g=>g.id===profile.gradeId);
              const gName = getGradeName(profile.gradeId, country);
              const topics = grade?.topics||[];
              const topicStats = topics.map(t=>({
                t,
                status:getTopicMastery(profile,t),
                pct:getTopicPct(profile,t),
              }));
              const strengths = topicStats.filter(x=>x.status==="mastered");
              const weak      = topicStats.filter(x=>x.status==="growing");
              const inProg    = topicStats.filter(x=>x.status==="learning");
              const recent    = profile.quizHistory.slice(-3).reverse();

              return (
                <div key={profile.id} style={{border:`2px solid ${grade?.color||"#eee"}`,
                  borderRadius:18,padding:16,background:`linear-gradient(135deg,${grade?.color||"#eee"}11,#fff)`}}>
                  <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:12}}>
                    <span style={{fontSize:"2rem"}}>{profile.avatar}</span>
                    <div>
                      <div style={{fontWeight:800,fontSize:"1rem",color:"var(--navy)"}}>{profile.name}</div>
                      <div style={{fontSize:"0.78rem",color:"var(--muted)",fontWeight:600}}>{grade?.emoji} {gName} ¬∑ Age {grade?.age}</div>
                    </div>
                    <div style={{marginLeft:"auto",textAlign:"right"}}>
                      <div style={{fontSize:"0.72rem",color:"var(--muted)",fontWeight:600}}>{profile.quizHistory.length} quizzes</div>
                    </div>
                  </div>

                  {strengths.length>0 && (
                    <div style={{marginBottom:8}}>
                      <div style={{fontSize:"0.72rem",fontWeight:800,color:"#0d6e4f",marginBottom:4,textTransform:"uppercase"}}>üí™ Strengths</div>
                      <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
                        {strengths.map(x=>(
                          <span key={x.t} style={{background:"#d4f7ec",color:"#0d6e4f",
                            borderRadius:20,padding:"2px 9px",fontSize:"0.73rem",fontWeight:700}}>
                            {TOPIC_EMOJIS[x.t]} {TOPIC_LABELS[x.t]}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  {inProg.length>0 && (
                    <div style={{marginBottom:8}}>
                      <div style={{fontSize:"0.72rem",fontWeight:800,color:"#856404",marginBottom:4,textTransform:"uppercase"}}>üìà In Progress</div>
                      <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
                        {inProg.map(x=>(
                          <span key={x.t} style={{background:"#fff3cd",color:"#856404",
                            borderRadius:20,padding:"2px 9px",fontSize:"0.73rem",fontWeight:700}}>
                            {TOPIC_EMOJIS[x.t]} {TOPIC_LABELS[x.t]} {x.pct!==null?`${x.pct}%`:""}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  {weak.length>0 && (
                    <div style={{marginBottom:8}}>
                      <div style={{fontSize:"0.72rem",fontWeight:800,color:"#cc2244",marginBottom:4,textTransform:"uppercase"}}>üéØ Needs Attention</div>
                      <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
                        {weak.map(x=>(
                          <span key={x.t} style={{background:"#fde8ed",color:"#cc2244",
                            borderRadius:20,padding:"2px 9px",fontSize:"0.73rem",fontWeight:700}}>
                            {TOPIC_EMOJIS[x.t]} {TOPIC_LABELS[x.t]} {x.pct!==null?`${x.pct}%`:""}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  {recent.length>0 && (
                    <div>
                      <div style={{fontSize:"0.72rem",fontWeight:800,color:"var(--muted)",marginBottom:4,textTransform:"uppercase"}}>Recent quizzes</div>
                      <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                        {recent.map((q,i)=>(
                          <span key={i} style={{background:"#f0f0f0",borderRadius:12,
                            padding:"3px 10px",fontSize:"0.73rem",fontWeight:700,color:"var(--text)"}}>
                            {q.pct}% ¬∑ {new Date(q.date).toLocaleDateString("en-IE",{day:"numeric",month:"short"})}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {tab==="labels" && (
          <div>
            <p style={{color:"var(--muted)",fontWeight:600,fontSize:"0.85rem",marginBottom:16,lineHeight:1.5}}>
              Rename the progress labels shown to students. Use words that feel encouraging and right for your family.
            </p>
            {["mastered","learning","growing","new"].map(key=>{
              const def = DEFAULT_MASTERY_LABELS[key];
              const cur = editLabels[key];
              return (
                <div key={key} style={{marginBottom:14}}>
                  <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6}}>
                    <span style={{background:def.bg,color:def.color,borderRadius:20,
                      padding:"3px 10px",fontSize:"0.75rem",fontWeight:800,minWidth:90,textAlign:"center"}}>
                      Default: {def.label}
                    </span>
                    <span style={{fontSize:"0.78rem",color:"var(--muted)",fontWeight:600}}>‚Üí shown as:</span>
                  </div>
                  <div style={{display:"flex",gap:8}}>
                    <input style={{...S.input,marginBottom:0,flex:2}}
                      value={cur.label}
                      onChange={e=>setEditLabels(prev=>({...prev,[key]:{...prev[key],label:e.target.value}}))}
                      placeholder={def.label} maxLength={20}/>
                    <input style={{...S.input,marginBottom:0,flex:1,textAlign:"center"}}
                      value={cur.emoji}
                      onChange={e=>setEditLabels(prev=>({...prev,[key]:{...prev[key],emoji:e.target.value}}))}
                      placeholder={def.emoji} maxLength={4}/>
                  </div>
                  <div style={{fontSize:"0.7rem",color:"var(--muted)",fontWeight:600,marginTop:4}}>
                    Preview: <span style={{background:cur.bg,color:cur.color,borderRadius:20,padding:"2px 9px",fontWeight:800}}>{cur.label} {cur.emoji}</span>
                  </div>
                </div>
              );
            })}
            <button style={{...S.btnPrimary,width:"100%",marginTop:8}} onClick={handleSaveLabels}>
              Save Labels ‚úì
            </button>
            <button style={{...S.btnSecondary,width:"100%",marginTop:8}}
              onClick={()=>{ setEditLabels({...DEFAULT_MASTERY_LABELS}); onUpdateLabels(DEFAULT_MASTERY_LABELS); }}>
              Reset to Defaults
            </button>
          </div>
        )}
      </div>
    </div>
  );

// ---
function MathAdventure() {
  const [profiles,      setProfilesRaw] = useState(()=>loadProfiles());
  const [activeProfile, setActiveProfile] = useState(null);
  const [screen,        setScreen]      = useState("home");
  const [gameConfig,    setGameConfig]  = useState(null);
  const [quizResult,    setQuizResult]  = useState(null);
  const [showConfetti,  setShowConfetti]= useState(false);
  const [country,       setCountryRaw]  = useState(()=>loadCountry());
  const [familyCode,    setFamilyCode]  = useState(()=>loadFamilyCode());
  const [labels,        setLabelsRaw]   = useState(()=>loadCustomLabels());

  // Overlays
  const [showFamilySetup, setShowFamilySetup] = useState(!loadFamilyCode());
  const [showParentPin,   setShowParentPin]   = useState(false);
  const [showAdminPin,    setShowAdminPin]    = useState(false);
  const [showParent,      setShowParent]      = useState(false);
  const [showAdmin,       setShowAdmin]       = useState(false);

  const setCountry  = (c) => { setCountryRaw(c);  saveCountry(c); };
  const setLabels   = (l) => { setLabelsRaw(l);   saveCustomLabels(l); };
  const setProfiles = (p) => { setProfilesRaw(p); saveProfiles(p); };

  const patchProfile = (id, fn) => {
    const next = profiles.map(p => p.id===id ? fn(p) : p);
    setProfiles(next);
    setActiveProfile(prev => prev?.id===id ? fn(prev) : prev);
  };

  const recordAnswers = (profileId, topic, correct, wrong) =>
    patchProfile(profileId, p => {
      const prev = p.topicProgress[topic]||{attempts:0,correct:0};
      return {...p, topicProgress:{...p.topicProgress,
        [topic]:{attempts:prev.attempts+correct+wrong, correct:prev.correct+correct}}};
    });

  const recordQuizResult = (profileId, topics, score, total) =>
    patchProfile(profileId, p => ({...p,
      quizHistory:[...p.quizHistory.slice(-49),
        {date:Date.now(),topics,score,total,pct:Math.round((score/total)*100)}]}));

  const goHome = () => { setScreen("home"); setActiveProfile(null); setGameConfig(null); setQuizResult(null); };
  const goDash = () => { setScreen("dashboard"); setGameConfig(null); setQuizResult(null); };

  const handleFamilyComplete = (fc, remoteProfiles) => {
    setFamilyCode(fc);
    if (remoteProfiles) setProfiles(remoteProfiles);
    setShowFamilySetup(false);
  };

  return (
    <>
      {showConfetti && <Confetti/>}

      {showFamilySetup && <FamilySetup onComplete={handleFamilyComplete}/>}

      {showParentPin && (
        <PinModal title="Parent & Teacher Mode" subtitle="Enter your parent PIN to continue"
          correctPin={PARENT_PIN_HASH}
          onSuccess={()=>{ setShowParentPin(false); setShowParent(true); }}
          onCancel={()=>setShowParentPin(false)}/>
      )}
      {showAdminPin && (
        <PinModal title="Admin Mode" subtitle="Enter the admin PIN"
          correctPin={ADMIN_PIN_HASH}
          onSuccess={()=>{ setShowAdminPin(false); setShowAdmin(true); }}
          onCancel={()=>setShowAdminPin(false)}/>
      )}
      {showParent && (
        <ParentPanel
          profiles={profiles} country={country} familyCode={familyCode}
          labels={labels} onUpdateLabels={(l)=>{ setLabels(l); }}
          onClose={()=>setShowParent(false)}/>
      )}
      {showAdmin && <AdminPanel onClose={()=>setShowAdmin(false)}/>}

      {!showFamilySetup && familyCode && (
        <FeedbackWidget familyCode={familyCode} profiles={profiles}/>
      )}

      {screen==="home" && (
        <HomeScreen
          profiles={profiles}
          country={country}
          labels={labels}
          familyCode={familyCode}
          onSetCountry={setCountry}
          onSelectProfile={(p)=>{ setActiveProfile(p); setScreen("dashboard"); }}
          onCreateProfile={()=>setScreen("createProfile")}
          onParentMode={()=>setShowParentPin(true)}
          onAdminMode={()=>setShowAdminPin(true)}
        />
      )}

      {screen==="createProfile" && (
        <CreateProfile
          country={country}
          onSave={(profile)=>{
            const updated=[...profiles,profile];
            setProfiles(updated);
            setActiveProfile(profile);
            setScreen("dashboard");
          }}
          onBack={()=>setScreen("home")}
        />
      )}

      {screen==="dashboard" && activeProfile && (
        <Dashboard
          profile={activeProfile}
          country={country}
          labels={labels}
          onFlash={()=>setScreen("flashSetup")}
          onQuiz={()=>setScreen("quizSetup")}
          onProgress={()=>setScreen("profileView")}
          onEdit={()=>setScreen("editProfile")}
          onHome={goHome}
        />
      )}

      {screen==="flashSetup" && activeProfile && (
        <FlashSetup
          profile={activeProfile}
          country={country}
          onStart={(cfg)=>{ setGameConfig(cfg); setScreen("flashGame"); }}
          onBack={goDash}
        />
      )}

      {screen==="quizSetup" && activeProfile && (
        <QuizSetup
          profile={activeProfile}
          country={country}
          onStart={(cfg)=>{ setGameConfig(cfg); setScreen("quizGame"); }}
          onBack={goDash}
        />
      )}

      {screen==="flashGame" && gameConfig && (
        <FlashGame config={gameConfig} onExit={goDash}/>
      )}

      {screen==="quizGame" && gameConfig && (
        <QuizGame
          config={gameConfig}
          onComplete={(result)=>{
            const topicMap={};
            result.answers.forEach(({topic,correct})=>{
              if(!topicMap[topic]) topicMap[topic]={correct:0,wrong:0};
              correct ? topicMap[topic].correct++ : topicMap[topic].wrong++;
            });
            Object.entries(topicMap).forEach(([t,v])=>
              recordAnswers(activeProfile.id,t,v.correct,v.wrong));
            recordQuizResult(activeProfile.id,gameConfig.topics,result.score,result.total);
            setQuizResult(result);
            if(result.pct>=80){ setShowConfetti(true); setTimeout(()=>setShowConfetti(false),3500); }
            setScreen("quizResult");
          }}
          onExit={goDash}
        />
      )}

      {screen==="quizResult" && quizResult && (
        <QuizResult
          result={quizResult}
          onRetry={()=>{ setQuizResult(null); setGameConfig(null); setScreen("quizSetup"); }}
          onHome={goDash}
        />
      )}

      {screen==="profileView" && activeProfile && (
        <ProfileView
          profile={activeProfile}
          country={country}
          labels={labels}
          onBack={goDash}
          onDelete={()=>{
            if(window.confirm(`Delete ${activeProfile.name}'s profile? This can't be undone.`)){
              setProfiles(profiles.filter(p=>p.id!==activeProfile.id));
              goHome();
            }
          }}
        />
      )}

      {screen==="editProfile" && activeProfile && (
        <EditProfile
          profile={activeProfile}
          country={country}
          onSave={(updated)=>{
            patchProfile(activeProfile.id, () => updated);
            setScreen("dashboard");
          }}
          onBack={goDash}
        />
      )}
    </>
  );
}


// ---
function HomeScreen({ profiles, country, labels, familyCode, onSetCountry, onSelectProfile, onCreateProfile, onParentMode, onAdminMode }) {
  const cl = COUNTRY_LABELS[country];
  return (
    <Page>
      <div style={{textAlign:"center",padding:"36px 0 16px",animation:"fadeUp 0.5s ease"}}>
        <div style={{fontSize:"3rem",marginBottom:6}}>üåü</div>
        <h1 style={{fontFamily:"'Baloo 2',cursive",fontSize:"clamp(2.2rem,7vw,3.4rem)",
          fontWeight:900,color:"var(--navy)",letterSpacing:"-1px",
          textShadow:"2px 3px 0 rgba(26,58,107,0.1)"}}>Math Adventure</h1>
        <p style={{color:"var(--muted)",fontWeight:700,fontSize:"0.95rem",marginTop:4}}>
          A joyful homeschool maths companion
        </p>
      </div>

      {/* Family code + mode buttons */}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",
        marginBottom:10,flexWrap:"wrap",gap:8}}>
        <div style={{fontSize:"0.72rem",color:"var(--muted)",fontWeight:700,
          background:"#f0f0f0",borderRadius:20,padding:"4px 12px",letterSpacing:1}}>
          üè† {familyCode}
        </div>
        <div style={{display:"flex",gap:6}}>
          <button style={{...S.backBtn,fontSize:"0.75rem",padding:"5px 12px"}} onClick={onParentMode}>
            üë®‚Äçüë©‚Äçüëß Parent Mode
          </button>
          <button style={{...S.backBtn,fontSize:"0.75rem",padding:"5px 12px",opacity:0.5}} onClick={onAdminMode}>
            üõ°Ô∏è
          </button>
        </div>
      </div>

      {/* Country switcher */}
      <div style={{...S.card,padding:"14px 18px",marginBottom:14,animation:"fadeUp 0.4s 0.05s ease both"}}>
        <div style={{fontSize:"0.78rem",fontWeight:800,color:"var(--muted)",textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:8}}>
          üåç Curriculum
        </div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
          {Object.entries(COUNTRY_LABELS).map(([code,cl])=>(
            <button key={code} onClick={()=>onSetCountry(code)} style={{
              border:`2px solid ${country===code?"var(--blue)":"#e0e0e0"}`,
              background:country===code?"#eaf0ff":"#fafafa",
              borderRadius:20,padding:"7px 16px",fontFamily:"Nunito,sans-serif",
              fontWeight:800,fontSize:"0.88rem",
              color:country===code?"var(--blue)":"var(--muted)",
              transition:"all 0.18s"}}>
              {cl.flag} {cl.name}
            </button>
          ))}
        </div>
        <div style={{marginTop:8,fontSize:"0.76rem",color:"var(--muted)",fontWeight:600}}>
          Showing: <strong style={{color:"var(--navy)"}}>{cl.flag} {cl.name}</strong> grade names ¬∑ Ages are always displayed
        </div>
      </div>

      {profiles.length===0 ? (
        <div style={{...S.card,textAlign:"center",animation:"fadeUp 0.5s 0.1s ease both"}}>
          <div style={{fontSize:"2.8rem",marginBottom:10}}>üë®‚Äçüë©‚Äçüëß‚Äçüëß</div>
          <h2 style={S.cardTitle}>Welcome, Family!</h2>
          <p style={{color:"var(--muted)",marginBottom:20,lineHeight:1.6,fontWeight:600,fontSize:"0.95rem"}}>
            Create a profile for each learner to track progress,<br/>earn mastery badges, and make maths fun!
          </p>
          <button style={S.btnPrimary} onClick={onCreateProfile}>+ Add First Learner</button>
        </div>
      ) : (
        <>
          <div style={{...S.sectionLabel,animation:"fadeUp 0.4s 0.1s ease both"}}>üëã Who's learning today?</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(130px,1fr))",gap:12,marginBottom:16}}>
            {profiles.map((p,i) => {
              const grade = GRADES.find(g=>g.id===p.gradeId);
              return (
                <button key={p.id}
                  style={{...S.profileCard,borderColor:grade?.color||"#ddd",
                    animation:`fadeUp 0.4s ${0.1+i*0.07}s ease both`}}
                  onClick={()=>onSelectProfile(p)}>
                  <div style={{fontSize:"2.4rem",marginBottom:5}}>{p.avatar}</div>
                  <div style={{fontWeight:800,fontSize:"0.95rem",color:"var(--text)"}}>{p.name}</div>
                  <div style={{fontSize:"0.72rem",color:"var(--muted)",fontWeight:700,marginTop:2}}>
                    {getGradeName(p.gradeId, country)}
                  </div>
                  <div style={{marginTop:5,background:(grade?.color||"#ccc")+"33",color:grade?.color,
                    borderRadius:20,padding:"2px 10px",fontSize:"0.68rem",fontWeight:800}}>
                    {grade?.emoji} {getGradeLabel(p.gradeId, country)} ¬∑ {grade?.age}
                  </div>
                </button>
              );
            })}
            <button style={{...S.addProfileBtn,animation:`fadeUp 0.4s ${0.1+profiles.length*0.07}s ease both`}}
              onClick={onCreateProfile}>
              <span style={{fontSize:"1.7rem"}}>Ôºã</span>
              <span style={{fontWeight:800,fontSize:"0.82rem",color:"var(--muted)"}}>Add Learner</span>
            </button>
          </div>
        </>
      )}
    </Page>
  );
}

// ---
function CreateProfile({ country, onSave, onBack }) {
  const [name,    setName]    = useState("");
  const [gradeId, setGradeId] = useState("3");
  const [avatar,  setAvatar]  = useState("ü¶ã");
  return (
    <Page>
      <div style={{...S.card,animation:"fadeUp 0.4s ease"}}>
        <button style={S.backBtn} onClick={onBack}>‚Üê Back</button>
        <h2 style={{...S.cardTitle,marginTop:12,marginBottom:20}}>‚ú® Create a Learner Profile</h2>

        <label style={S.inputLabel}>Name</label>
        <input style={S.input} placeholder="e.g. Emma" value={name}
          onChange={e=>setName(e.target.value)} maxLength={20}/>

        <label style={S.inputLabel}>Year / Class</label>
        <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6,marginBottom:20}}>
          {GRADES.map(g=>(
            <button key={g.id} onClick={()=>setGradeId(g.id)} style={{
              border:`3px solid ${gradeId===g.id?g.color:"#e0e0e0"}`,
              background:gradeId===g.id?g.color+"22":"#fafafa",
              borderRadius:12,padding:"8px 4px",fontFamily:"Nunito,sans-serif",transition:"all 0.18s"}}>
              <div style={{fontSize:"1.1rem"}}>{g.emoji}</div>
              <div style={{fontWeight:800,fontSize:"0.78rem",color:"var(--text)",lineHeight:1.2}}>{getGradeLabel(g.id,country)}</div>
              <div style={{fontSize:"0.58rem",color:"var(--muted)",marginTop:1}}>{g.age}</div>
            </button>
          ))}
        </div>

        <label style={S.inputLabel}>Choose an Avatar</label>
        <div style={{display:"flex",flexWrap:"wrap",gap:8,marginBottom:24}}>
          {AVATARS.map(av=>(
            <button key={av} onClick={()=>setAvatar(av)} style={{
              fontSize:"1.8rem",border:`3px solid ${avatar===av?"var(--mint)":"transparent"}`,
              borderRadius:12,padding:"6px",
              background:avatar===av?"#e8fdf6":"transparent",transition:"all 0.15s"}}>
              {av}
            </button>
          ))}
        </div>

        <button style={{...S.btnPrimary,width:"100%",opacity:name.trim()?1:0.5}}
          disabled={!name.trim()}
          onClick={()=>onSave(makeProfile(name.trim(),gradeId,avatar))}>
          Create Profile üéâ
        </button>
      </div>
    </Page>
  );
}

// ---
function EditProfile({ profile, country, onSave, onBack }) {
  const [name,    setName]    = useState(profile.name);
  const [gradeId, setGradeId] = useState(profile.gradeId);
  const [avatar,  setAvatar]  = useState(profile.avatar);

  const hasChanges = name.trim() !== profile.name || gradeId !== profile.gradeId || avatar !== profile.avatar;
  const gradeChanged = gradeId !== profile.gradeId;

  return (
    <Page>
      <div style={{...S.card, animation:"fadeUp 0.4s ease"}}>
        <button style={S.backBtn} onClick={onBack}>‚Üê Back</button>
        <h2 style={{...S.cardTitle, marginTop:12, marginBottom:4}}>‚úèÔ∏è Edit Profile</h2>
        <p style={{color:"var(--muted)",fontWeight:600,fontSize:"0.84rem",marginBottom:20,lineHeight:1.5}}>
          Update {profile.name}'s name, year, or avatar anytime.
        </p>

        <label style={S.inputLabel}>Name</label>
        <input style={S.input} value={name}
          onChange={e=>setName(e.target.value)} maxLength={20}/>

        <label style={S.inputLabel}>Year / Class</label>
        <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6,marginBottom:gradeChanged?8:20}}>
          {GRADES.map(g=>(
            <button key={g.id} onClick={()=>setGradeId(g.id)} style={{
              border:`3px solid ${gradeId===g.id?g.color:"#e0e0e0"}`,
              background:gradeId===g.id?g.color+"22":"#fafafa",
              borderRadius:12,padding:"8px 4px",fontFamily:"Nunito,sans-serif",transition:"all 0.18s"}}>
              <div style={{fontSize:"1.1rem"}}>{g.emoji}</div>
              <div style={{fontWeight:800,fontSize:"0.78rem",color:"var(--text)",lineHeight:1.2}}>{getGradeLabel(g.id,country)}</div>
              <div style={{fontSize:"0.58rem",color:"var(--muted)",marginTop:1}}>{g.age}</div>
            </button>
          ))}
        </div>

        {gradeChanged && (
          <div style={{background:"#fff8e1",border:"2px solid #FFD166",borderRadius:12,
            padding:"10px 14px",marginBottom:20,fontSize:"0.8rem",fontWeight:700,color:"#856404",lineHeight:1.5}}>
            üìö Switching year will show new topics on the dashboard. Quiz history is kept safe!
          </div>
        )}

        <label style={S.inputLabel}>Avatar</label>
        <div style={{display:"flex",flexWrap:"wrap",gap:8,marginBottom:24}}>
          {AVATARS.map(av=>(
            <button key={av} onClick={()=>setAvatar(av)} style={{
              fontSize:"1.8rem",border:`3px solid ${avatar===av?"var(--mint)":"transparent"}`,
              borderRadius:12,padding:"6px",
              background:avatar===av?"#e8fdf6":"transparent",transition:"all 0.15s"}}>
              {av}
            </button>
          ))}
        </div>

        <button
          style={{...S.btnPrimary, width:"100%", opacity:name.trim()&&hasChanges?1:0.45}}
          disabled={!name.trim()||!hasChanges}
          onClick={()=>onSave({...profile, name:name.trim(), gradeId, avatar})}>
          Save Changes ‚úì
        </button>
      </div>
    </Page>
  );
}

// ---
function Dashboard({ profile, country, labels, onFlash, onQuiz, onProgress, onEdit, onHome }) {
  const grade = GRADES.find(g=>g.id===profile.gradeId);
  const gradeName = getGradeName(profile.gradeId, country);
  const gradeLabel = getGradeLabel(profile.gradeId, country);
  const recentPct = profile.quizHistory.length>0
    ? Math.round(profile.quizHistory.slice(-5).reduce((s,q)=>s+q.pct,0)/Math.min(5,profile.quizHistory.length))
    : null;
  return (
    <Page>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:14,flexWrap:"wrap",gap:8}}>
        <button style={S.backBtn} onClick={onHome}>‚Üê Home</button>
        <button style={S.backBtn} onClick={onProgress}>üìä Progress</button>
      </div>

      {/* Tappable profile banner ‚Äî active state works on both mobile and desktop */}
      <style>{`.profile-edit-btn:active { transform: scale(0.97) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important; } .profile-edit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(0,0,0,0.13) !important; }`}</style>
      <button className="profile-edit-btn" onClick={onEdit} style={{
        ...S.card, width:"100%", textAlign:"left", cursor:"pointer",
        background:`linear-gradient(135deg,${grade.color}22,#fffdf9)`,
        borderColor:grade.color, animation:"fadeUp 0.4s ease",
        position:"relative", transition:"box-shadow 0.18s, transform 0.15s",
        display:"block",
      }}>
        <div style={{display:"flex",alignItems:"center",gap:14,flexWrap:"wrap"}}>
          <div style={{fontSize:"3.2rem"}}>{profile.avatar}</div>
          <div style={{flex:1}}>
            <h2 style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.55rem",color:"var(--text)",fontWeight:800}}>
              Hi, {profile.name}! üëã
            </h2>
            <div style={{color:"var(--muted)",fontWeight:700,fontSize:"0.88rem"}}>
              {grade.emoji} {gradeName} ¬∑ Age {grade.age}
            </div>
            {recentPct!==null&&(
              <div style={{marginTop:5,display:"inline-block",background:"#fff",borderRadius:20,
                padding:"3px 12px",fontSize:"0.78rem",fontWeight:800,color:grade.color,
                border:`2px solid ${grade.color}44`}}>
                Recent avg: {recentPct}% ‚ú®
              </div>
            )}
          </div>
          <div style={{fontSize:"1.1rem",opacity:0.35,flexShrink:0}}>‚úèÔ∏è</div>
        </div>
        <div style={{marginTop:8,fontSize:"0.72rem",color:"var(--muted)",fontWeight:600,opacity:0.7,textAlign:"right"}}>
          Tap to edit profile
        </div>
      </button>

      <div style={S.sectionLabel}>üéÆ What would you like to do?</div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,marginBottom:18}}>
        <button style={{...S.modeCard,borderColor:"#FFD166",animation:"fadeUp 0.4s 0.1s ease both"}} onClick={onFlash}>
          <span style={{fontSize:"2.6rem"}}>‚ö°</span>
          <span style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.15rem",fontWeight:800,color:"var(--text)"}}>Flash Cards</span>
          <span style={{fontSize:"0.75rem",color:"var(--muted)",fontWeight:700}}>Practice at your own pace</span>
        </button>
        <button style={{...S.modeCard,borderColor:"#9B5DE5",animation:"fadeUp 0.4s 0.15s ease both"}} onClick={onQuiz}>
          <span style={{fontSize:"2.6rem"}}>üß†</span>
          <span style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.15rem",fontWeight:800,color:"var(--text)"}}>Quiz Mode</span>
          <span style={{fontSize:"0.75rem",color:"var(--muted)",fontWeight:700}}>Answer & earn stars</span>
        </button>
      </div>

      <div style={{...S.card,animation:"fadeUp 0.4s 0.2s ease both"}}>
        <div style={S.cardTitle}>üìö {gradeName} Topics</div>
        <div style={{display:"flex",flexDirection:"column",gap:10,marginTop:10}}>
          {grade.topics.map(t=>{
            const status=getTopicMastery(profile,t);
            const pct=getTopicPct(profile,t);
            return (
              <div key={t} style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                <span style={{fontSize:"1rem",width:22,flexShrink:0}}>{TOPIC_EMOJIS[t]}</span>
                <span style={{fontWeight:700,fontSize:"0.87rem",flex:1,minWidth:80}}>{TOPIC_LABELS[t]}</span>
                {pct!==null&&<ProgressBar pct={pct} color={grade.color}/>}
                <MasteryBadge status={status} labels={labels}/>
              </div>
            );
          })}
        </div>
      </div>
    </Page>
  );
}

// ---
function FlashSetup({ profile, country, onStart, onBack }) {
  const grade = GRADES.find(g=>g.id===profile.gradeId);
  const [selTopics, setSelTopics] = useState([...grade.topics]);

  const toggleT = (t) => setSelTopics(prev =>
    prev.includes(t) ? (prev.length>1 ? prev.filter(x=>x!==t) : prev) : [...prev,t]
  );

  const handleStart = () => {
    // Generate ~4 problems per topic so every topic gets fair coverage, then smart-shuffle
    const perTopic = Math.max(3, Math.ceil(20 / selTopics.length));
    const problems = [];
    selTopics.forEach(t => {
      for (let i = 0; i < perTopic; i++) problems.push(generateProblem(t, "medium"));
    });
    onStart({ topics:selTopics, problems: smartShuffle(problems) });
  };

  return (
    <Page>
      <button style={S.backBtn} onClick={onBack}>‚Üê Back</button>
      <div style={{...S.card,marginTop:12,animation:"fadeUp 0.4s ease"}}>
        <div style={S.cardTitle}>‚ö° Flash Card Setup</div>
        <p style={{color:"var(--muted)",fontWeight:600,fontSize:"0.87rem",marginBottom:16,lineHeight:1.5}}>
          Which topics would you like to practice today?
        </p>
        <div style={{display:"flex",flexWrap:"wrap",gap:8,marginBottom:24}}>
          {grade.topics.map(t=>{
            const active=selTopics.includes(t);
            return (
              <button key={t} onClick={()=>toggleT(t)} style={{
                border:`2px solid ${active?"#e6a800":"#e0e0e0"}`,
                background:active?"#fff8e1":"#fafafa",borderRadius:30,
                padding:"7px 14px",fontFamily:"Nunito,sans-serif",
                fontWeight:700,fontSize:"0.83rem",color:active?"#7a5000":"var(--muted)",
                transition:"all 0.18s"}}>
                {TOPIC_EMOJIS[t]} {TOPIC_LABELS[t]}
              </button>
            );
          })}
        </div>
        <button style={{...S.btnPrimary,width:"100%",
          background:"#e6a800",boxShadow:"0 4px 14px rgba(230,168,0,0.35)"}}
          onClick={handleStart}>
          Start Flash Cards! ‚ö°
        </button>
      </div>
    </Page>
  );
}

// ---
function QuizSetup({ profile, country, onStart, onBack }) {
  const grade = GRADES.find(g=>g.id===profile.gradeId);
  const [selTopics,  setSelTopics]  = useState([...grade.topics]);
  const [difficulty, setDifficulty] = useState("medium");
  const [qCount,     setQCount]     = useState(10);

  const toggleT = (t) => setSelTopics(prev =>
    prev.includes(t) ? (prev.length>1 ? prev.filter(x=>x!==t) : prev) : [...prev,t]
  );

  const handleStart = () => {
    const problems = [];
    for (let i=0;i<qCount;i++) problems.push(generateProblem(selTopics[i%selTopics.length],difficulty));
    for (let i=problems.length-1;i>0;i--) { const j=rnd(0,i); [problems[i],problems[j]]=[problems[j],problems[i]]; }
    onStart({ topics:selTopics, difficulty, qCount, problems });
  };

  return (
    <Page>
      <button style={S.backBtn} onClick={onBack}>‚Üê Back</button>
      <div style={{...S.card,marginTop:12,animation:"fadeUp 0.4s ease"}}>
        <div style={S.cardTitle}>üß† Quiz Setup</div>
        <p style={{color:"var(--muted)",fontWeight:600,fontSize:"0.87rem",marginBottom:16,lineHeight:1.5}}>
          Focus on the topics you want to strengthen ‚Äî pick as many or as few as you like!
        </p>

        <label style={S.inputLabel}>Topics</label>
        <div style={{display:"flex",flexWrap:"wrap",gap:8,marginBottom:20}}>
          {grade.topics.map(t=>{
            const status=getTopicMastery(profile,t);
            const active=selTopics.includes(t);
            return (
              <button key={t} onClick={()=>toggleT(t)} style={{
                border:`2px solid ${active?"var(--mint)":"#e0e0e0"}`,
                background:active?"#e8fdf6":"#fafafa",borderRadius:30,
                padding:"7px 14px",fontFamily:"Nunito,sans-serif",
                fontWeight:700,fontSize:"0.83rem",color:active?"#0d6e4f":"var(--muted)",
                transition:"all 0.18s",display:"flex",alignItems:"center",gap:5}}>
                {TOPIC_EMOJIS[t]} {TOPIC_LABELS[t]}
                {status==="growing"&&<span style={{fontSize:"0.6rem",color:"var(--coral)"}}>‚óè</span>}
              </button>
            );
          })}
        </div>

        <label style={S.inputLabel}>Number of Questions</label>
        <div style={{display:"flex",gap:8,marginBottom:20,flexWrap:"wrap"}}>
          {[5,10,15,20].map(n=>(
            <button key={n} onClick={()=>setQCount(n)} style={{
              border:`2px solid ${qCount===n?"var(--blue)":"#e0e0e0"}`,
              background:qCount===n?"#eaf0ff":"#fafafa",borderRadius:20,
              padding:"8px 18px",fontFamily:"Nunito,sans-serif",
              fontWeight:800,color:qCount===n?"var(--blue)":"var(--muted)",
              transition:"all 0.18s"}}>
              {n}
            </button>
          ))}
        </div>

        <label style={S.inputLabel}>Difficulty</label>
        <div style={{display:"flex",gap:8,marginBottom:24,flexWrap:"wrap"}}>
          {[["easy","üòä Easy"],["medium","üåü Medium"],["hard","üî• Hard"]].map(([val,lab])=>(
            <button key={val} onClick={()=>setDifficulty(val)} style={{
              border:`2px solid ${difficulty===val?"var(--purple)":"#e0e0e0"}`,
              background:difficulty===val?"#f0e6ff":"#fafafa",borderRadius:20,
              padding:"8px 18px",fontFamily:"Nunito,sans-serif",
              fontWeight:800,color:difficulty===val?"var(--purple)":"var(--muted)",
              transition:"all 0.18s"}}>
              {lab}
            </button>
          ))}
        </div>

        <button style={{...S.btnPrimary,width:"100%"}} onClick={handleStart}>
          Start Quiz! üöÄ
        </button>
      </div>
    </Page>
  );
}

// ---
function FlashGame({ config, onExit }) {
  const [idx,     setIdx]     = useState(0);
  const [flipped, setFlipped] = useState(false);
  const problems = config.problems;

  const next = () => { setFlipped(false); setIdx(i=>(i+1)%problems.length); };
  const prev = () => { setFlipped(false); setIdx(i=>(i-1+problems.length)%problems.length); };
  const shuffle = () => {
    const reshuffled = smartShuffle([...problems]);
    // replace in-place so the ref stays stable
    reshuffled.forEach((p, i) => { problems[i] = p; });
    setIdx(0); setFlipped(false);
  };

  useEffect(()=>{
    const h=(e)=>{
      if(e.key==="ArrowRight"||e.key==="n") next();
      else if(e.key==="ArrowLeft"||e.key==="p") prev();
      else if(e.key===" "||e.key==="Enter"){e.preventDefault();setFlipped(f=>!f);}
    };
    window.addEventListener("keydown",h);
    return ()=>window.removeEventListener("keydown",h);
  });

  const prob = problems[idx];
  return (
    <Page>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12}}>
        <button style={S.backBtn} onClick={onExit}>‚úï Exit</button>
        <span style={{fontWeight:800,color:"var(--muted)",fontSize:"0.88rem"}}>{idx+1} / {problems.length}</span>
        <button style={S.backBtn} onClick={shuffle}>üîÄ Shuffle</button>
      </div>

      <div onClick={()=>setFlipped(f=>!f)} style={{
        background:"linear-gradient(135deg,#fff8e1,#fffde7)",
        border:"3px solid #FFD166",borderRadius:24,padding:"40px 24px",cursor:"pointer",
        minHeight:210,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",
        boxShadow:"0 6px 28px rgba(255,209,102,0.22)",userSelect:"none",animation:"fadeUp 0.3s ease"}}>
        <div style={{fontFamily:"'Baloo 2',cursive",
          fontSize:"clamp(1.7rem,6vw,3rem)",color:"var(--text)",fontWeight:800,
          textAlign:"center",whiteSpace:"pre-line",lineHeight:1.3}}>
          {prob.question}
        </div>
        {prob.hint&&!flipped&&(
          <div style={{color:"var(--muted)",fontSize:"0.8rem",fontWeight:700,marginTop:8,textAlign:"center"}}>
            {prob.hint}
          </div>
        )}
        {flipped ? (
          <div style={{marginTop:14,fontFamily:"'Baloo 2',cursive",fontSize:"2.4rem",
            color:"var(--mint)",fontWeight:900,animation:"pop 0.3s ease",textAlign:"center"}}>
            = {prob.answer}
          </div>
        ) : (
          <div style={{color:"#ccc",fontSize:"0.82rem",fontWeight:700,marginTop:14,textAlign:"center"}}>
            Tap to reveal ‚ú®
          </div>
        )}
      </div>

      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:14}}>
        <button style={{...S.btnSecondary,padding:"10px 20px"}} onClick={prev}>‚Üê Prev</button>
        <div style={{display:"flex",gap:5,flexWrap:"wrap",justifyContent:"center",maxWidth:200}}>
          {problems.map((_,i)=>(
            <div key={i} style={{width:7,height:7,borderRadius:"50%",flexShrink:0,
              background:i===idx?"var(--blue)":"#ddd",transition:"background 0.2s"}}/>
          ))}
        </div>
        <button style={{...S.btnSecondary,padding:"10px 20px"}} onClick={next}>Next ‚Üí</button>
      </div>
      <div style={{textAlign:"center",marginTop:8,fontSize:"0.72rem",color:"#ccc",fontWeight:600}}>
        Keyboard: ‚Üê ‚Üí to navigate ¬∑ Space to flip
      </div>
    </Page>
  );
}

// ---
function QuizGame({ config, onComplete, onExit }) {
  const [idx,      setIdx]      = useState(0);
  const [score,    setScore]    = useState(0);
  const [answers,  setAnswers]  = useState([]);
  const [chosen,   setChosen]   = useState(null);
  const [choices,  setChoices]  = useState(()=>generateChoices(config.problems[0].answer));
  const [feedback, setFeedback] = useState(null);

  const prob = config.problems[idx];

  useEffect(()=>{
    setChosen(null);
    setFeedback(null);
    setChoices(generateChoices(prob.answer));
  },[idx]);

  const handleAnswer = (c) => {
    if (chosen!==null) return;
    const correct = String(c)===String(prob.answer);
    setChosen(c);
    setFeedback(correct?"correct":"wrong");
    const newScore   = correct ? score+1 : score;
    const newAnswers = [...answers,{topic:prob.topic,correct}];
    if(correct) setScore(newScore);

    setTimeout(()=>{
      if(idx+1>=config.problems.length){
        onComplete({score:newScore,total:config.problems.length,
          pct:Math.round((newScore/config.problems.length)*100),answers:newAnswers});
      } else {
        setAnswers(newAnswers);
        setIdx(i=>i+1);
      }
    },1200);
  };

  return (
    <Page>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10,flexWrap:"wrap",gap:8}}>
        <button style={S.backBtn} onClick={onExit}>‚úï Exit</button>
        <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
          <span style={{...S.badge,background:"#eaf0ff",color:"var(--blue)"}}>Q {idx+1}/{config.problems.length}</span>
          <span style={{...S.badge,background:"#d4f7ec",color:"#0d6e4f"}}>‚úÖ {score}</span>
        </div>
      </div>

      <div style={{marginBottom:14}}>
        <ProgressBar pct={(idx/config.problems.length)*100} color="var(--blue)" height={10}/>
      </div>

      <div style={{background:"linear-gradient(135deg,#f0f8ff,#fff)",border:"3px solid #ddeeff",
        borderRadius:24,padding:"26px 20px",marginBottom:18,textAlign:"center",
        boxShadow:"0 4px 20px rgba(45,107,228,0.09)",animation:"fadeUp 0.3s ease"}}>
        <div style={{fontFamily:"'Baloo 2',cursive",
          fontSize:"clamp(1.8rem,6vw,3.2rem)",color:"var(--text)",fontWeight:900,
          letterSpacing:1,whiteSpace:"pre-line",lineHeight:1.3}}>
          {prob.question}
        </div>
        {prob.hint&&<div style={{color:"var(--muted)",fontSize:"0.8rem",fontWeight:700,marginTop:8}}>{prob.hint}</div>}
      </div>

      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        {choices.map((c,i)=>{
          const isChosen  = chosen!==null && String(chosen)===String(c);
          const isCorrect = String(c)===String(prob.answer);
          let border="#e0e0e0", bg="#fafafa", col="var(--text)";
          if(chosen!==null){
            if(isCorrect){border="var(--mint)";bg="#d4f7ec";col="#0d6e4f";}
            else if(isChosen){border="var(--coral)";bg="#fde8ed";col="#cc2244";}
          }
          return (
            <button key={i} disabled={chosen!==null} onClick={()=>handleAnswer(c)}
              style={{border:`3px solid ${border}`,borderRadius:16,padding:"16px 10px",
                background:bg,color:col,fontFamily:"'Baloo 2',cursive",
                fontSize:"clamp(1.3rem,4vw,1.8rem)",fontWeight:800,
                transition:"border 0.15s, background 0.15s",
                animation:isChosen&&!isCorrect?"shake 0.35s ease":isCorrect&&chosen?"pop 0.3s ease":"none",
                cursor:chosen?"default":"pointer"}}
              onMouseEnter={e=>{if(!chosen){e.currentTarget.style.borderColor="var(--blue)";e.currentTarget.style.background="#eaf6fd";}}}
              onMouseLeave={e=>{if(!chosen){e.currentTarget.style.borderColor="#e0e0e0";e.currentTarget.style.background="#fafafa";}}}
            >{c}</button>
          );
        })}
      </div>

      {feedback&&(
        <div style={{textAlign:"center",marginTop:14,fontFamily:"'Baloo 2',cursive",
          fontSize:"1.2rem",fontWeight:800,animation:"fadeUp 0.2s ease",
          color:feedback==="correct"?"#0d6e4f":"#cc4444"}}>
          {feedback==="correct"
            ? ["Great job! ‚ú®","Correct! üéâ","You got it! üåü","Excellent! üí´"][rnd(0,3)]
            : `The answer is ${prob.answer} ‚Äî you've got this! üí™`}
        </div>
      )}
    </Page>
  );
}

// ---
function QuizResult({ result, onRetry, onHome }) {
  const { score, total, pct, answers } = result;
  const stars   = pct>=95?3:pct>=75?2:pct>=50?1:0;
  const msgs    = pct>=95?ENCOURAGEMENTS.perfect:pct>=75?ENCOURAGEMENTS.great:pct>=50?ENCOURAGEMENTS.good:ENCOURAGEMENTS.growing;
  const message = msgs[rnd(0,msgs.length-1)];

  const topicAcc = {};
  answers.forEach(({topic,correct})=>{
    if(!topicAcc[topic]) topicAcc[topic]={c:0,t:0};
    topicAcc[topic].t++;
    if(correct) topicAcc[topic].c++;
  });
  const weakTopics = Object.entries(topicAcc).filter(([,v])=>(v.c/v.t)<0.6).map(([t])=>t);

  return (
    <Page>
      <div style={{...S.card,textAlign:"center",animation:"fadeUp 0.4s ease"}}>
        <div style={{fontSize:"3.2rem",marginBottom:6,animation:"pop 0.5s ease"}}>
          {pct>=80?"üéâ":pct>=50?"üòä":"üí™"}
        </div>
        <h2 style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.9rem",color:"var(--blue)",fontWeight:900}}>
          {message.split("!")[0]}!
        </h2>
        <Stars count={stars}/>
        <div style={{fontSize:"1.05rem",fontWeight:800,color:"var(--text)",margin:"8px 0",
          background:"#f0f8ff",borderRadius:16,padding:"10px 18px",display:"inline-block"}}>
          {score} out of {total} ¬∑ {pct}%
        </div>
        <p style={{color:"var(--muted)",fontWeight:700,fontSize:"0.88rem",marginTop:8,lineHeight:1.6}}>
          {pct>=80
            ?"You're doing brilliantly ‚Äî keep up the amazing work! üåü"
            :pct>=50
            ?"You're making real progress! Every practice session builds your skills. üí™"
            :"Every question you tried made your brain stronger. That's what matters most! üå±"}
        </p>

        <div style={{textAlign:"left",marginTop:16,marginBottom:14}}>
          <div style={{fontWeight:800,color:"var(--text)",marginBottom:8,fontSize:"0.88rem"}}>Your results by topic:</div>
          {Object.entries(topicAcc).map(([t,v])=>{
            const tPct=Math.round((v.c/v.t)*100);
            return (
              <div key={t} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,flexWrap:"wrap"}}>
                <span style={{width:20,fontSize:"0.95rem",flexShrink:0}}>{TOPIC_EMOJIS[t]}</span>
                <span style={{flex:1,fontWeight:700,fontSize:"0.83rem",minWidth:80}}>{TOPIC_LABELS[t]}</span>
                <ProgressBar pct={tPct} color={tPct>=80?"#06D6A0":tPct>=50?"#FFD166":"#FF9F7F"}/>
                <span style={{fontSize:"0.78rem",fontWeight:800,minWidth:32,textAlign:"right",
                  color:tPct>=80?"#0d6e4f":tPct>=50?"#856404":"#c0392b"}}>{tPct}%</span>
              </div>
            );
          })}
        </div>

        {weakTopics.length>0&&(
          <div style={{background:"linear-gradient(135deg,#fff8e1,#fffde7)",
            border:"2px solid #FFD166",borderRadius:16,padding:16,textAlign:"left",marginBottom:16}}>
            <div style={{fontWeight:800,color:"#856404",marginBottom:10,fontSize:"0.88rem"}}>
              üåü Want to grow even stronger? Here are some fun ways to practice:
            </div>
            {weakTopics.map(t=>(
              <div key={t} style={{marginBottom:12}}>
                <div style={{fontWeight:800,fontSize:"0.83rem",color:"var(--text)",marginBottom:4}}>
                  {TOPIC_EMOJIS[t]} {TOPIC_LABELS[t]}
                </div>
                {(TOPIC_RESOURCES[t]||[]).slice(0,2).map((r,i)=>(
                  <div key={i} style={{fontSize:"0.79rem",color:"var(--muted)",fontWeight:600,
                    padding:"3px 0 3px 12px",borderLeft:"3px solid #FFD166",marginBottom:3,lineHeight:1.4}}>
                    {r}
                  </div>
                ))}
              </div>
            ))}
          </div>
        )}

        <div style={{display:"flex",gap:10,justifyContent:"center",flexWrap:"wrap"}}>
          <button style={S.btnPrimary} onClick={onRetry}>Try Again üîÑ</button>
          <button style={S.btnSecondary} onClick={onHome}>Dashboard üè†</button>
        </div>
      </div>
    </Page>
  );
}

// ---
function ProfileView({ profile, country, labels, onBack, onDelete }) {
  const grade = GRADES.find(g=>g.id===profile.gradeId);
  const gradeName = getGradeName(profile.gradeId, country);
  const masteredCount = grade.topics.filter(t=>getTopicMastery(profile,t)==="mastered").length;
  const recent = profile.quizHistory.slice(-8).reverse();
  return (
    <Page>
      <button style={S.backBtn} onClick={onBack}>‚Üê Back</button>
      <div style={{...S.card,textAlign:"center",marginTop:12,
        background:`linear-gradient(135deg,${grade.color}22,#fffdf9)`,
        borderColor:grade.color,animation:"fadeUp 0.4s ease"}}>
        <div style={{fontSize:"3.2rem"}}>{profile.avatar}</div>
        <h2 style={{fontFamily:"'Baloo 2',cursive",fontSize:"1.5rem",color:"var(--text)",fontWeight:900}}>{profile.name}</h2>
        <div style={{color:"var(--muted)",fontWeight:700,fontSize:"0.84rem"}}>{grade.emoji} {gradeName} ¬∑ Age {grade.age}</div>
        <div style={{display:"flex",gap:12,justifyContent:"center",margin:"12px 0",flexWrap:"wrap"}}>
          <div style={{background:"#d4f7ec",color:"#0d6e4f",borderRadius:20,padding:"4px 14px",fontWeight:800,fontSize:"0.83rem"}}>
            üèÜ {masteredCount} Mastered
          </div>
          <div style={{background:"#eaf0ff",color:"var(--blue)",borderRadius:20,padding:"4px 14px",fontWeight:800,fontSize:"0.83rem"}}>
            üìù {profile.quizHistory.length} Quizzes
          </div>
        </div>
      </div>

      <div style={{...S.card,animation:"fadeUp 0.4s 0.1s ease both"}}>
        <div style={S.cardTitle}>üìä Topic Mastery</div>
        <div style={{display:"flex",flexDirection:"column",gap:12,marginTop:10}}>
          {grade.topics.map(t=>{
            const status=getTopicMastery(profile,t);
            const pct=getTopicPct(profile,t);
            const prog=profile.topicProgress[t];
            return (
              <div key={t}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4,flexWrap:"wrap"}}>
                  <span style={{fontSize:"0.95rem",flexShrink:0}}>{TOPIC_EMOJIS[t]}</span>
                  <span style={{flex:1,fontWeight:700,fontSize:"0.86rem"}}>{TOPIC_LABELS[t]}</span>
                  <MasteryBadge status={status} labels={labels}/>
                </div>
                {prog&&prog.attempts>0 ? (
                  <>
                    <ProgressBar pct={pct||0} color={grade.color}/>
                    <div style={{fontSize:"0.7rem",color:"var(--muted)",fontWeight:700,marginTop:2}}>
                      {prog.correct}/{prog.attempts} correct ({pct}%){status==="mastered"&&" üéâ"}
                    </div>
                  </>
                ) : (
                  <div style={{fontSize:"0.7rem",color:"#ccc",fontWeight:700}}>Not started yet</div>
                )}
              </div>
            );
          })}
        </div>
      </div>

      {recent.length>0&&(
        <div style={{...S.card,animation:"fadeUp 0.4s 0.2s ease both"}}>
          <div style={S.cardTitle}>üìÖ Recent Quizzes</div>
          <div style={{display:"flex",flexDirection:"column",gap:8,marginTop:10}}>
            {recent.map((q,i)=>{
              const d=new Date(q.date);
              const stars=q.pct>=95?3:q.pct>=75?2:q.pct>=50?1:0;
              return (
                <div key={i} style={{display:"flex",alignItems:"center",gap:10,
                  padding:"8px 12px",background:"#f9f9f9",borderRadius:12}}>
                  <div style={{flex:1}}>
                    <div style={{fontWeight:800,fontSize:"0.84rem",color:"var(--text)"}}>
                      {q.score}/{q.total} ({q.pct}%)
                    </div>
                    <div style={{fontSize:"0.7rem",color:"var(--muted)",fontWeight:600}}>{d.toLocaleDateString()}</div>
                  </div>
                  <span style={{fontSize:"0.9rem"}}>{"‚≠ê".repeat(stars)}{"‚òÜ".repeat(3-stars)}</span>
                  <div style={{width:60,flexShrink:0}}>
                    <ProgressBar pct={q.pct} height={6}
                      color={q.pct>=80?"#06D6A0":q.pct>=50?"#FFD166":"#FF9F7F"}/>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      <div style={{textAlign:"center",marginTop:4,marginBottom:24}}>
        <button onClick={onDelete} style={{...S.btnSecondary,
          color:"#cc4444",borderColor:"#ffcccc",background:"#fff8f8",fontSize:"0.85rem"}}>
          üóëÔ∏è Delete Profile
        </button>
      </div>
    </Page>
  );
}

// ---
const S = {
  card:{background:"var(--card)",borderRadius:24,
    boxShadow:"0 4px 24px rgba(0,0,0,0.07)",
    padding:"22px",marginBottom:14,border:"2px solid #f0eee8"},
  cardTitle:{fontFamily:"'Baloo 2',cursive",fontSize:"1.15rem",fontWeight:800,color:"var(--navy)",marginBottom:4},
  sectionLabel:{fontFamily:"'Baloo 2',cursive",fontWeight:800,fontSize:"1rem",color:"var(--navy)",marginBottom:10,marginTop:4},
  profileCard:{background:"var(--card)",border:"3px solid #eee",borderRadius:20,
    padding:"14px 10px",display:"flex",flexDirection:"column",alignItems:"center",gap:4,
    cursor:"pointer",transition:"all 0.2s",fontFamily:"Nunito,sans-serif",
    boxShadow:"0 2px 10px rgba(0,0,0,0.05)"},
  addProfileBtn:{background:"#f9f9f9",border:"2px dashed #ddd",borderRadius:20,
    padding:"14px 10px",display:"flex",flexDirection:"column",alignItems:"center",gap:6,
    cursor:"pointer",transition:"all 0.2s",fontFamily:"Nunito,sans-serif"},
  modeCard:{background:"var(--card)",border:"3px solid #eee",borderRadius:20,
    padding:"18px 12px",display:"flex",flexDirection:"column",alignItems:"center",gap:5,
    cursor:"pointer",transition:"all 0.2s",fontFamily:"Nunito,sans-serif",
    boxShadow:"0 2px 10px rgba(0,0,0,0.05)"},
  btnPrimary:{background:"var(--blue)",color:"#fff",border:"none",borderRadius:30,
    padding:"13px 26px",fontFamily:"'Baloo 2',cursive",fontWeight:800,fontSize:"1rem",
    boxShadow:"0 4px 14px rgba(45,107,228,0.32)",transition:"all 0.2s",letterSpacing:"0.3px"},
  btnSecondary:{background:"#f0f0f0",color:"#555",border:"2px solid #e0e0e0",borderRadius:30,
    padding:"10px 20px",fontFamily:"'Baloo 2',cursive",fontWeight:700,fontSize:"0.92rem",
    transition:"all 0.2s"},
  backBtn:{background:"transparent",color:"var(--muted)",border:"2px solid #e0e0e0",borderRadius:20,
    padding:"7px 14px",fontFamily:"Nunito,sans-serif",fontWeight:700,fontSize:"0.83rem",
    cursor:"pointer",transition:"all 0.18s"},
  input:{width:"100%",border:"2px solid #e0e0e0",borderRadius:12,padding:"10px 14px",
    fontSize:"1rem",fontFamily:"Nunito,sans-serif",fontWeight:700,outline:"none",
    marginBottom:16,background:"#fafafa",display:"block"},
  inputLabel:{display:"block",fontWeight:800,color:"var(--muted)",fontSize:"0.78rem",
    marginBottom:6,textTransform:"uppercase",letterSpacing:"0.5px"},
  badge:{borderRadius:20,padding:"4px 12px",fontWeight:800,fontSize:"0.8rem",fontFamily:"Nunito,sans-serif"},
};
const domRoot = ReactDOM.createRoot(document.getElementById('root'));
domRoot.render(React.createElement(MathAdventure));
  </script>
</body>
</html>